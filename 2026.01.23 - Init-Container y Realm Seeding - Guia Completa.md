# Guía: Init-Container y Realm Seeding en Keycloak

**Fecha:** 23 de Enero de 2026  
**Tema:** Funcionamiento del Init-Container y actualización correcta de URLs en Keycloak

---

## Índice

1. [Descripción del Problema](#descripción-del-problema)
2. [Arquitectura del Sistema](#arquitectura-del-sistema)
3. [Flujo de Inicialización de Keycloak](#flujo-de-inicialización-de-keycloak)
4. [El Problema con tx.test](#el-problema-con-txtest)
5. [Soluciones Disponibles](#soluciones-disponibles)
6. [Recomendación y Plan de Acción](#recomendación-y-plan-de-acción)

---

## Descripción del Problema

Al desplegar el portal de Tractus-X en OVH con una nueva IP del LoadBalancer, las URLs en la base de datos de Keycloak mantienen valores antiguos (`tx.test`) en lugar de actualizarse con la nueva IP.

### URLs afectadas encontradas:

**En Central IDP (11 URLs):**
- `portal.tx.test` - 4 ocurrencias
- `sharedidp.tx.test` - 4 ocurrencias
- `partners-gate.tx.test` - 1 ocurrencia
- `partners-pool.tx.test` - 1 ocurrencia
- `managed-identity-wallets.tx.test` - 1 ocurrencia

**En Shared IDP (2 URLs):**
- `centralidp.tx.test` - 2 ocurrencias

---

## Arquitectura del Sistema

### Componentes involucrados:

```
┌─────────────────────────────────────────────────────────────┐
│                    Helm Chart Deployment                     │
│                                                               │
│  1. values-adopter-portal.yaml    → Habilita componentes    │
│  2. values-ovh-hosts-portal.yaml  → Config de infraestructura│
│  3. values-ovh-realms-portal.yaml → Config de realm seeding │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│              Kubernetes Pod: Keycloak (StatefulSet)          │
│                                                               │
│  ┌────────────────────────────────────────────────────┐    │
│  │   Init Container 1: prepare-write-dirs             │    │
│  │   - Prepara directorios y permisos                 │    │
│  └────────────────────────────────────────────────────┘    │
│                           ↓                                  │
│  ┌────────────────────────────────────────────────────┐    │
│  │   Init Container 2: import                         │    │
│  │   - Imagen: umbrella-init-container:2.3.0-init    │    │
│  │   - Contiene: CX-Central-realm.json               │    │
│  │   - Contiene: CX-Central-users-0.json             │    │
│  │   - Copia archivos JSON a /import/                │    │
│  └────────────────────────────────────────────────────┘    │
│                           ↓                                  │
│  ┌────────────────────────────────────────────────────┐    │
│  │   Main Container: keycloak                         │    │
│  │   1. Lee archivos JSON de /import/                │    │
│  │   2. Importa realms a PostgreSQL                  │    │
│  │   3. Ejecuta realm seeding (si configurado)       │    │
│  └────────────────────────────────────────────────────┘    │
│                                                               │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│            PostgreSQL Database (PersistentVolume)            │
│                                                               │
│  - Tablas: client, redirect_uris, identity_provider_config  │
│  - Datos: URLs hardcodeadas desde JSON del init-container   │
└─────────────────────────────────────────────────────────────┘
```

---

## Flujo de Inicialización de Keycloak

### Paso 1: Build del Init-Container

**Ubicación:** `init-container/Dockerfile`

```dockerfile
FROM alpine:3.19
RUN mkdir import
RUN chown -R 1000:3000 /import
USER 1000:3000
COPY iam/centralidp/ import/catenax-central/realms
```

**Archivos copiados:**
- `init-container/iam/centralidp/CX-Central-realm.json`
- `init-container/iam/centralidp/CX-Central-users-0.json`

### Paso 2: Despliegue del StatefulSet de Keycloak

Cuando se despliega el Helm chart, se crea un StatefulSet con:

1. **Init Container 1: prepare-write-dirs**
   - Prepara directorios con permisos correctos

2. **Init Container 2: import** 
   - Usa la imagen: `docker.io/tractusx/umbrella-init-container:2.3.0-init`
   - Monta un volumen compartido en `/import/`
   - Copia los archivos JSON al volumen

### Paso 3: Arranque de Keycloak

El contenedor principal de Keycloak:

1. **Lee los archivos JSON** del volumen `/import/`
2. **Importa el realm completo** a PostgreSQL:
   - Clientes (clients)
   - URLs de redirección (redirect_uris)
   - Configuración de Identity Providers
   - Usuarios
   - Roles
   - etc.

3. **Ejecuta realm seeding** (si está configurado en values):
   - **IMPORTANTE:** El realm seeding es **idempotente**
   - Solo **crea** recursos que NO existen
   - **NO actualiza** recursos existentes en la BD

### Paso 4: Estado Final

La base de datos PostgreSQL contiene:
- ✅ Todos los datos del realm importados desde JSON
- ⚠️ URLs con valores hardcodeados del JSON (`tx.test`)
- ❌ Los valores del realm seeding NO sobrescriben datos existentes

---

## El Problema con tx.test

### Causa Raíz

Los archivos JSON del init-container tienen URLs hardcodeadas:

**Archivo:** `init-container/iam/centralidp/CX-Central-realm.json`

```json
{
  "clients": [
    {
      "clientId": "Cl2-CX-Portal",
      "rootUrl": "http://portal.tx.test/home",
      "redirectUris": [
        "http://portal.tx.test/*"
      ]
    }
  ],
  "identityProviders": [
    {
      "alias": "CX-Operator",
      "config": {
        "tokenUrl": "http://sharedidp.tx.test/auth/realms/CX-Operator/protocol/openid-connect/token",
        "authorizationUrl": "http://sharedidp.tx.test/auth/realms/CX-Operator/protocol/openid-connect/auth"
      }
    }
  ]
}
```

### Secuencia del Problema

```
1. Init-container copia JSON con tx.test
              ↓
2. Keycloak importa JSON → BD tiene tx.test
              ↓
3. Realm seeding intenta actualizar
              ↓
4. Realm seeding detecta que el recurso existe
              ↓
5. Realm seeding NO actualiza (es idempotente)
              ↓
6. BD mantiene valores con tx.test ❌
```

### Por qué el Realm Seeding no corrige el problema

El realm seeding del Helm chart usa lógica tipo:

```python
if not client_exists(client_id):
    create_client(client_data)  # Solo crea si no existe
# NO hace: update_client(client_data)
```

Por lo tanto:
- ✅ Crea clientes nuevos que no están en el JSON
- ❌ NO actualiza clientes existentes importados del JSON

---

## Soluciones Disponibles

### Solución 1: Deshabilitar el Init-Container ⭐ RECOMENDADA

**Ventajas:**
- ✅ Simple de implementar
- ✅ El realm seeding crea todo desde cero con URLs correctas
- ✅ No requiere construir imágenes custom
- ✅ Funciona con valores dinámicos (cualquier IP)

**Desventajas:**
- ⚠️ Requiere eliminar la base de datos existente para empezar limpio
- ⚠️ Se pierden datos previos (usuarios, configuraciones manuales)

**Implementación:**

Agregar a `values-ovh-realms-portal.yaml`:

```yaml
centralidp:
  keycloak:
    realmSeeding:
      initContainer:
        image:
          name: ""  # Deshabilita el init-container
      # ... resto de configuración de realmSeeding
```

**Pasos:**

1. Agregar configuración para deshabilitar init-container
2. Eliminar el namespace completo: `kubectl delete namespace portal`
3. Redesplegar con:
   ```bash
   helm install portal . \
     -f values-adopter-portal.yaml \
     -f values-ovh-hosts-portal.yaml \
     -f values-ovh-realms-portal.yaml \
     -n portal \
     --create-namespace
   ```

---

### Solución 2: Crear Init-Container Personalizado

**Ventajas:**
- ✅ Mantiene toda la configuración original del realm
- ✅ Puede incluir datos adicionales (usuarios custom, etc.)
- ✅ No requiere borrar datos existentes después de la primera vez

**Desventajas:**
- ❌ Requiere construir y mantener imagen Docker personalizada
- ❌ Más complejo de implementar
- ❌ Requiere registro de imágenes (Docker Hub, registry privado, etc.)
- ❌ Los JSONs quedan hardcodeados con una IP específica

**Implementación:**

1. **Crear archivos JSON customizados:**

   ```bash
   # Copiar archivos originales
   cp init-container/iam/centralidp/CX-Central-realm.json \
      init-container/iam/centralidp/CX-Central-realm-ovh.json
   
   # Reemplazar tx.test con tu IP
   sed -i 's/tx\.test/51.83.111.178.nip.io/g' \
      init-container/iam/centralidp/CX-Central-realm-ovh.json
   ```

2. **Construir imagen Docker personalizada:**

   ```dockerfile
   FROM alpine:3.19
   RUN mkdir import
   RUN chown -R 1000:3000 /import
   USER 1000:3000
   COPY iam/centralidp-ovh/ import/catenax-central/realms
   ```

3. **Build y push:**

   ```bash
   cd init-container
   docker build -t myregistry/umbrella-init-container:ovh-custom .
   docker push myregistry/umbrella-init-container:ovh-custom
   ```

4. **Usar en values:**

   ```yaml
   centralidp:
     keycloak:
       realmSeeding:
         initContainer:
           image:
             name: myregistry/umbrella-init-container:ovh-custom
             pullPolicy: Always
   ```

---

### Solución 3: Job de Corrección Post-Despliegue (ACTUAL)

**Ventajas:**
- ✅ No requiere reconstruir nada
- ✅ Funciona con despliegue existente
- ✅ Puede ejecutarse múltiples veces

**Desventajas:**
- ❌ Es un workaround, no una solución permanente
- ❌ Requiere paso manual después de cada despliegue
- ❌ Necesita reiniciar pods después de corregir

**Ya implementado:** `fix-keycloak-urls-job-complete.yaml`

---

## Recomendación y Plan de Acción

### Recomendación: Solución 1 (Deshabilitar Init-Container)

**Razones:**
1. Es la más simple y mantenible
2. Funciona con cualquier IP (dinámico)
3. El realm seeding en `values-ovh-realms-portal.yaml` ya está completo
4. Evita dependencias de imágenes Docker personalizadas
5. Alineado con arquitectura modular (separación de valores)

### Plan de Implementación

#### Fase 1: Preparación (5 minutos)

1. **Actualizar `values-ovh-realms-portal.yaml`:**
   ```yaml
   centralidp:
     keycloak:
       realmSeeding:
         initContainer:
           image:
             name: ""  # Deshabilita
         clients:
           # ... configuración existente
   ```

2. **Actualizar `values-ovh-realms-portal-template.yaml`:**
   ```yaml
   centralidp:
     keycloak:
       realmSeeding:
         initContainer:
           image:
             name: ""  # Deshabilita
         clients:
           # ... configuración existente
   ```

#### Fase 2: Backup (10 minutos)

```bash
# Backup de configuración actual
kubectl get all -n portal -o yaml > backup-portal-$(date +%Y%m%d).yaml

# Backup de secrets
kubectl get secrets -n portal -o yaml > backup-secrets-$(date +%Y%m%d).yaml

# Si tienes datos importantes en PostgreSQL
kubectl exec -n portal portal-centralidp-postgresql-0 -- \
  pg_dumpall -U kccentral > backup-db-$(date +%Y%m%d).sql
```

#### Fase 3: Limpieza (2 minutos)

```bash
# Eliminar el namespace completo
kubectl delete namespace portal

# Verificar que se eliminó
kubectl get namespace portal
```

#### Fase 4: Redespliegue (10-15 minutos)

```bash
cd /home/xmendialdua/projects/assembly/tractus-x-umbrella/charts/umbrella

# Desplegar con los 3 archivos values
helm install portal . \
  -f values-adopter-portal.yaml \
  -f values-ovh-hosts-portal.yaml \
  -f values-ovh-realms-portal.yaml \
  -n portal \
  --create-namespace \
  --timeout 20m

# Monitorear el despliegue
kubectl get pods -n portal -w
```

#### Fase 5: Verificación (5 minutos)

```bash
# Esperar a que todos los pods estén Ready
kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=centralidp -n portal --timeout=600s

# Ejecutar script de verificación
cd /home/xmendialdua/projects/assembly/tractus-x-umbrella/charts/umbrella
bash check-keycloak-urls.sh
```

**Resultado esperado:** ✅ Todas las URLs deben mostrar "✓ OK" sin ningún "⚠️ CONTIENE tx.test"

#### Fase 6: Pruebas Funcionales (10 minutos)

1. **Acceder al portal:**
   - URL: http://portal.51.83.111.178.nip.io
   - Usuario: cx-operator
   - Verificar login correcto

2. **Acceder a Keycloak Admin:**
   - Central IDP: http://centralidp.51.83.111.178.nip.io/auth/admin
   - Shared IDP: http://sharedidp.51.83.111.178.nip.io/auth/admin
   - Verificar que NO hay error de cookies

3. **Verificar configuración en Keycloak:**
   - Revisar clientes en CX-Central realm
   - Verificar URLs de redirección
   - Comprobar Identity Provider CX-Operator

---

## Verificación de Éxito

### Criterios de Aceptación

✅ **Todos los pods corriendo correctamente:**
```bash
kubectl get pods -n portal
# Todos deben mostrar STATUS: Running y READY: 1/1
```

✅ **Sin URLs con tx.test en la BD:**
```bash
bash check-keycloak-urls.sh | grep "CONTIENE tx.test"
# No debe devolver ninguna línea
```

✅ **Login funcional:**
- Portal frontend accesible
- Login con cx-operator funciona
- Admin console de Keycloak accesible sin error de cookies

✅ **URLs correctas en la BD:**
```sql
-- Verificación manual si es necesario
kubectl exec -n portal portal-centralidp-postgresql-0 -- \
  psql -U kccentral -d iamcentralidp -c \
  "SELECT DISTINCT substring(root_url from 'http://[^/]+') FROM client WHERE root_url IS NOT NULL;"

# Debe mostrar: http://portal.51.83.111.178.nip.io
```

---

## Troubleshooting

### Problema: Init-container sigue ejecutándose

**Síntoma:** Después de configurar `name: ""`, el init-container aún aparece

**Solución:**
```yaml
# En vez de name: "", usa:
centralidp:
  keycloak:
    realmSeeding:
      initContainer:
        image:
          name: "alpine:3.19"  # Imagen vacía que no hace nada
        command: ["sh", "-c", "echo 'Init container disabled' && exit 0"]
```

### Problema: Realm seeding no crea clientes

**Síntoma:** Después del despliegue, no hay clientes en Keycloak

**Causa:** Sintaxis incorrecta en values-ovh-realms-portal.yaml

**Solución:** Verificar indentación YAML:
```bash
yamllint values-ovh-realms-portal.yaml
```

### Problema: Pods en CrashLoopBackOff

**Síntoma:** Pods de Keycloak no arrancan

**Diagnóstico:**
```bash
kubectl logs -n portal portal-centralidp-0
kubectl describe pod -n portal portal-centralidp-0
```

**Causas comunes:**
- Base de datos no disponible
- Errores en configuración de realm seeding
- Problemas de permisos en PV

---

## Documentos Relacionados

- `2026.01.23 - Result_Check_Keycloak_URLs.md` - Análisis de URLs con tx.test
- `20260116-portal-deployment-in-ovh.md` - Guía de despliegue en OVH
- `values-ovh-realms-portal.yaml` - Configuración de realm seeding
- `values-ovh-realms-portal-template.yaml` - Template para diferentes IPs

---

## Conclusión

La solución recomendada es **deshabilitar el init-container** y confiar completamente en el realm seeding configurado en `values-ovh-realms-portal.yaml`. Esto proporciona:

- ✅ Flexibilidad para cambiar IPs sin reconstruir imágenes
- ✅ Configuración clara y centralizada en archivos values
- ✅ Facilidad de mantenimiento
- ✅ Despliegues limpios sin necesidad de jobs de corrección

El único trade-off es que requiere un despliegue limpio (eliminando namespace), pero esto solo es necesario una vez para corregir el estado actual.

---

**Última actualización:** 23 de Enero 2026  
**Autor:** Asistente AI / GitHub Copilot  
**Versión:** 1.0
