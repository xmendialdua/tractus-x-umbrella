# Gu√≠a R√°pida para Onboarding de Business Partners
**Fecha:** 28 de Enero de 2026  
**Estado Actual:** Ikerlan completado ‚úÖ | Assembly pendiente ‚è≥  
**Punto de partida para:** Segundo onboarding (Assembly)

---

## üìö Resumen de Documentaci√≥n Actualizada

### 1. **Documento Principal Completo** 
`2026.01.27 - Onboarding Ikerlan - Proceso Completo.md`

**Contenido:**
- ‚úÖ Resumen ejecutivo con estado final
- ‚úÖ **PROCEDIMIENTO OPTIMIZADO** (10 pasos claros para pr√≥ximo onboarding)
- ‚úÖ Documentaci√≥n completa con todos los errores encontrados
- ‚úÖ 12 problemas documentados con sus soluciones
- ‚úÖ Lecciones aprendidas
- ‚úÖ Troubleshooting com√∫n
- ‚úÖ Pr√≥ximos pasos para Assembly y Fagor

---

### 2. **Procedimiento R√°pido para Copy-Paste**
`onboarding/PROCEDIMIENTO-ONBOARDING-OPTIMIZADO.md`

**Contenido:**
- ‚úÖ Checklist de 10 pasos
- ‚úÖ Comandos listos para ejecutar (solo cambiar variables)
- ‚úÖ Tiempo estimado: 15-20 minutos
- ‚úÖ Valores preparados para Assembly (idp2) y Fagor (idp3)
- ‚úÖ Troubleshooting r√°pido

---

### 3. **Datos de Ikerlan Actualizados**
`onboarding/Ikerlan.txt`

**Contenido:**
- ‚úÖ Estado: COMPLETADO
- ‚úÖ Resumen de configuraci√≥n final
- ‚úÖ Lecciones aprendidas
- ‚úÖ URLs y credenciales

---

## üéØ Para Hoy (28-Ene-2026) - Onboarding Assembly

### üöÄ NUEVO ENFOQUE: Realm Seeding (M√©todo Declarativo)

**¬øPor qu√© cambiar el m√©todo?**
- ‚ùå Portal UI no funciona sin SMTP
- ‚ùå Proceso manual DB + Keycloak API es complejo y propenso a errores
- ‚úÖ **Realm Seeding = M√©todo oficial de Tractus-X**

**Ventajas del Realm Seeding:**
- üìù Declarativo: Archivos YAML/JSON describen partners
- üîÑ Automatizado: Kubernetes Jobs ejecutan el seeding
- üì¶ Versionable: Se guarda en Git como c√≥digo
- üîÅ Replicable: Mismo archivo sirve para m√∫ltiples entornos
- ‚úÖ Oficial: Es el mecanismo dise√±ado por Tractus-X

---

### Plan de Trabajo para Assembly

**Opci√≥n A: Usar Realm Seeding (RECOMENDADO)**
1. Investigar jobs existentes: `kubectl get jobs -n portal | grep realm-seeding`
2. Analizar ConfigMaps de seeding actuales
3. Crear archivo YAML para Assembly siguiendo el patr√≥n de Ikerlan
4. Aplicar seeding mediante Job de Kubernetes
5. Verificar resultado

**Tiempo estimado:** 30-45 minutos (incluye investigaci√≥n)

**Opci√≥n B: Proceso Manual (FALLBACK)**
- Usar `PROCEDIMIENTO-ONBOARDING-OPTIMIZADO.md`
- Solo si Realm Seeding no funciona

**Valores a usar (ambas opciones):**
- **Realm:** `idp2`
- **Display Name:** `Assembly`
- **BPN:** `BPNL000000002ASM`
- **Email:** [el que corresponda]

---

## ‚úÖ Logros de Ayer (27-Ene-2026)

1. ‚úÖ **Ikerlan onboarding completado** - Usuario puede hacer login
2. ‚úÖ **Arquitectura de realms entendida** - idp1, idp2, idp3 con displayNames
3. ‚úÖ **12 problemas resueltos** - Documentados para evitar repetirlos
4. ‚úÖ **Procedimiento optimizado creado** - Listo para replicar
5. ‚úÖ **Documentaci√≥n completa** - Todo versionado y listo para git

---

## ÔøΩ Investigaci√≥n Inicial: Realm Seeding

### Comandos para Explorar

```bash
# 1. Ver jobs de realm seeding completados
kubectl get jobs -n portal | grep realm-seeding

# 2. Ver ConfigMaps relacionados con seeding
kubectl get configmap -n portal | grep -E "realm|seed"

# 3. Ver pods completados de seeding
kubectl get pods -n portal | grep realm-seeding

# 4. Analizar logs de seeding de Shared IDP (referencia)
kubectl logs -n portal portal-sharedidp-realm-seeding-10-xxxxx

# 5. Ver contenido del ConfigMap de seeding
kubectl get configmap portal-sharedidp-realms -n portal -o yaml

# 6. Buscar archivos de values con configuraci√≥n de realms
grep -r "realm" charts/umbrella/values*.yaml | grep -i seed
```

### Estructura Esperada

Los archivos de Realm Seeding t√≠picamente contienen:
- Definici√≥n de realms
- Usuarios iniciales
- Roles y permisos
- Clientes OAuth2
- Atributos custom (BPN, etc.)

**Ejemplo de estructura:**
```yaml
realms:
  - realm: idp2
    displayName: Assembly
    enabled: true
    sslRequired: none
    users:
      - username: contacto@assembly.com
        email: contacto@assembly.com
        enabled: true
        emailVerified: true
        credentials:
          - type: password
            value: Welcome2Catena-X!
        realmRoles:
          - Company Admin
        attributes:
          bpn: ["BPNL000000002ASM"]
    clients:
      - clientId: Cl2-CX-Portal
        enabled: true
        publicClient: true
        redirectUris: ["http://portal.51.68.114.44.nip.io/*"]
```

---

## üöÄ Flujo de Trabajo R√°pido para Assembly

### Opci√≥n A: Realm Seeding (Investigar primero)

### Opci√≥n A: Realm Seeding (Investigar primero)
1. Ejecutar comandos de investigaci√≥n (secci√≥n anterior)
2. Identificar el patr√≥n de seeding actual
3. Crear/modificar ConfigMap o values para Assembly
4. Aplicar mediante Job o Helm upgrade
5. Verificar resultado

### Opci√≥n B: Proceso Manual (Fallback)
1. **Seguir:** `onboarding/PROCEDIMIENTO-ONBOARDING-OPTIMIZADO.md`
2. **Variables clave:**
   - `REALM_ALIAS="idp2"`
   - `DISPLAY_NAME="Assembly"`
   - `USER_EMAIL="contacto@assembly.com"`
   - `BPN="BPNL000000002ASM"`

### Despu√©s de Completar
- [ ] Actualizar este documento con el resultado
- [ ] Crear `onboarding/Assembly.txt` con datos finales
- [ ] Preparar para Fagor (idp3)

---

## üìã Checklist R√°pido (Copiar de PROCEDIMIENTO-ONBOARDING-OPTIMIZADO.md)

- [ ] PASO 1: Preparar datos del Business Partner
- [ ] PASO 2: Crear invitaci√≥n en Portal UI
- [ ] PASO 3: Identificar identity provider alias (idp2 esperado)
- [ ] PASO 4: Configurar realm en Keycloak (sslRequired: none)
- [ ] PASO 5: Crear cliente OAuth2 (Cl2-CX-Portal)
- [ ] PASO 6: Obtener usuario y configurar contrase√±a
- [ ] PASO 7: Actualizar base de datos (user_entity_id + BPN)
- [ ] PASO 8: Verificar REQUIRE_HTTPS en false
- [ ] PASO 9: Reiniciar servicios del Portal
- [ ] PASO 10: Probar login

---

## ‚ö†Ô∏è Recordatorios Importantes

### Tres M√©todos de Onboarding (del Peor al Mejor)

1. ‚ùå **Portal UI con SMTP** 
   - Dise√±o original, pero NO funciona sin servidor SMTP
   - En nuestro entorno: BLOQUEADO

2. ‚ö†Ô∏è **Manual: DB + Keycloak API** (usado con Ikerlan)
   - Complejo, propenso a errores
   - 10 pasos manuales con riesgo de inconsistencias
   - Solo para debugging o emergencias
   - NO escalable

3. ‚úÖ **Realm Seeding** (OFICIAL y RECOMENDADO)
   - Declarativo: Archivos YAML describen estado deseado
   - Automatizado: Kubernetes Jobs ejecutan el seeding
   - Versionable en Git
   - M√©todo oficial de Tractus-X
   - **Usar este m√©todo para Assembly**

---

### De la Experiencia con Ikerlan (si usas m√©todo manual)

1. **El realm usa ID t√©cnico (idp2), NO el nombre de la empresa**
   - Correcto: `idp2` con displayName "Assembly"
   - Incorrecto: `CX-Operator-Assembly`

2. **SSL debe estar deshabilitado**
   ```json
   "sslRequired": "none"
   ```

3. **Cada realm necesita su propio cliente OAuth2**
   - ClientId: `Cl2-CX-Portal`
   - RedirectUris: `http://portal.51.68.114.44.nip.io/*`

4. **El user_entity_id debe ser el UUID de Keycloak**
   - Obtener con: `curl .../realms/idp2/users?email=...`

5. **Reiniciar pods del Portal despu√©s de cambios en BD**
   ```bash
   kubectl delete pod -n portal -l app.kubernetes.io/name=portal
   ```

6. **Probar siempre en modo inc√≥gnito**
   - Evita problemas de cach√© del navegador

---

## üîó Arquitectura de Realms (Recordatorio)

```
Shared IDP (Keycloak)
‚îú‚îÄ‚îÄ master (realm admin)
‚îú‚îÄ‚îÄ CX-Operator (realm del operador del Portal)
‚îî‚îÄ‚îÄ Business Partner Realms:
    ‚îú‚îÄ‚îÄ idp1 (displayName: "Ikerlan")     ‚úÖ COMPLETADO
    ‚îú‚îÄ‚îÄ idp2 (displayName: "Assembly")    ‚è≥ HOY
    ‚îú‚îÄ‚îÄ idp3 (displayName: "Fagor")       ‚è≥ SIGUIENTE
    ‚îî‚îÄ‚îÄ idp4, idp5, ... (futuros partners)
```

---

## üìû Recursos Clave

| Recurso | Ubicaci√≥n |
|---------|-----------|
| Portal UI | http://portal.51.68.114.44.nip.io |
| Shared IDP | http://sharedidp.51.68.114.44.nip.io/auth |
| Procedimiento detallado | `onboarding/PROCEDIMIENTO-ONBOARDING-OPTIMIZADO.md` |
| Ejemplo completo | `onboarding/Ikerlan.txt` |
| Troubleshooting | `2026.01.27 - Onboarding Ikerlan - Proceso Completo.md` (final) |

---

## üéØ Siguiente: Fagor

**Despu√©s de completar Assembly:**
- **Realm:** `idp3`
- **Display Name:** `Fagor`
- **BPN:** `BPNL000000003FGR`
- **Procedimiento:** Mismo que Assembly

Pero lo haremos siguiendo una tercera v√≠a:
 - Realm Seeding (Opci√≥n Correcta y Declarativa)
    - Archivos YAML/JSON describen partners
    - Automatizado mediante Kubernetes Jobs
    - Replicable, versionable en Git
    - Es el mecanismo oficial de Tractus-X

---

**Documento creado:** 28 de Enero de 2026  
**Autor:** xmendialdua  
**Prop√≥sito:** Punto de partida r√°pido para onboarding de Assembly  
**Actualizar tras completar:** Marcar Assembly como ‚úÖ y actualizar secci√≥n de logros
