# Resultado Check Keycloak URLs - 23 de Enero 2026

## Fecha de ejecución
**23/01/2026 - 12:38**

## Resumen Ejecutivo

Este documento contiene los resultados de la verificación de URLs en las bases de datos de Keycloak (CentralIDP y SharedIDP) realizada mediante el script `check-keycloak-urls.sh`.

**Estado**: ⚠️ **Se encontraron URLs con tx.test que necesitan corrección**

---

## 1. CENTRAL IDP - client.root_url

### Tabla: client
Verifica las URLs raíz configuradas en los clientes de Keycloak.

```
          client_id           |          root_url          |       status        
------------------------------+----------------------------+---------------------
 account                      | ${authBaseUrl}             | ✓ OK
 account                      | ${authBaseUrl}             | ✓ OK
 account-console              | ${authBaseUrl}             | ✓ OK
 account-console              | ${authBaseUrl}             | ✓ OK
 Cl16-CX-BPDMGate             |                            | ✓ OK
 Cl1-CX-Registration          |                            | ✓ OK
 Cl23-CX-Policy-Hub           |                            | ✓ OK
 Cl24-CX-SSI-CredentialIssuer |                            | ✓ OK
 Cl25-CX-BPDM-Orchestrator    |                            | ✓ OK
 Cl2-CX-Portal                | http://portal.tx.test/home | ⚠️  CONTIENE tx.test
 Cl3-CX-Semantic              |                            | ✓ OK
 Cl7-CX-BPDM                  |                            | ✓ OK
 sa-cl2-04                    |                            | ✓ OK
 sa-cl2-05                    |                            | ✓ OK
 sa-cl24-01                   |                            | ✓ OK
 sa-cl25-cx-1                 |                            | ✓ OK
 sa-cl25-cx-2                 |                            | ✓ OK
 sa-cl25-cx-3                 |                            | ✓ OK
 sa-cl5-custodian-2           |                            | ✓ OK
 sa-cl7-cx-1                  |                            | ✓ OK
 sa-cl7-cx-7                  |                            | ✓ OK
 satest01                     |                            | ✓ OK
 satest02                     |                            | ✓ OK
 satest03                     |                            | ✓ OK
 satest04                     |                            | ✓ OK
 satest05                     |                            | ✓ OK
 satest06                     |                            | ✓ OK
 satest07                     |                            | ✓ OK
 satest08                     |                            | ✓ OK
 satest09                     |                            | ✓ OK
 satest10                     |                            | ✓ OK
 satest11                     |                            | ✓ OK
 satest12                     |                            | ✓ OK
 satest13                     |                            | ✓ OK
 satest14                     |                            | ✓ OK
 satest15                     |                            | ✓ OK
 satest16                     |                            | ✓ OK
 security-admin-console       | ${authAdminUrl}            | ✓ OK
 security-admin-console       | ${authAdminUrl}            | ✓ OK
(39 rows)
```

### ⚠️ Problema encontrado:
- **Cl2-CX-Portal**: root_url contiene `http://portal.tx.test/home`

---

## 2. CENTRAL IDP - redirect_uris

### Tabla: redirect_uris
Verifica las URLs de redirección configuradas para los clientes.

```
          client_id           |               redirect_uri                |       status        
------------------------------+-------------------------------------------+---------------------
 account                      | /realms/CX-Central/account/*              | ✓ OK
 account                      | /realms/master/account/*                  | ✓ OK
 account-console              | /realms/CX-Central/account/*              | ✓ OK
 account-console              | /realms/master/account/*                  | ✓ OK
 Cl16-CX-BPDMGate             | http://partners-gate.tx.test/*            | ⚠️  CONTIENE tx.test
 Cl1-CX-Registration          | http://portal.tx.test/*                   | ⚠️  CONTIENE tx.test
 Cl23-CX-Policy-Hub           |                                           | ✓ OK
 Cl23-CX-Policy-Hub           | /*                                        | ✓ OK
 Cl24-CX-SSI-CredentialIssuer | /*                                        | ✓ OK
 Cl2-CX-Portal                | http://portal.tx.test/*                   | ⚠️  CONTIENE tx.test
 Cl3-CX-Semantic              | http://portal.tx.test/*                   | ⚠️  CONTIENE tx.test
 Cl5-CX-Custodian             | http://managed-identity-wallets.tx.test/* | ⚠️  CONTIENE tx.test
 Cl7-CX-BPDM                  | http://partners-pool.tx.test/*            | ⚠️  CONTIENE tx.test
 sa-cl1-reg-2                 | *                                         | ✓ OK
 sa-cl2-04                    | /*                                        | ✓ OK
 sa-cl2-05                    | /*                                        | ✓ OK
 sa-cl24-01                   | /*                                        | ✓ OK
 sa-cl25-cx-1                 | /*                                        | ✓ OK
 sa-cl25-cx-2                 | /*                                        | ✓ OK
 sa-cl25-cx-3                 | /*                                        | ✓ OK
 sa-cl3-cx-1                  | *                                         | ✓ OK
 sa-cl5-custodian-2           | *                                         | ✓ OK
 sa-cl7-cx-1                  | /*                                        | ✓ OK
 sa-cl7-cx-7                  | /*                                        | ✓ OK
 sa-cl8-cx-1                  | *                                         | ✓ OK
 satest01                     | /*                                        | ✓ OK
 satest02                     | /*                                        | ✓ OK
 satest03                     | /*                                        | ✓ OK
 satest04                     | /*                                        | ✓ OK
 satest05                     | /*                                        | ✓ OK
 satest06                     | /*                                        | ✓ OK
 satest07                     | /*                                        | ✓ OK
 satest08                     | /*                                        | ✓ OK
 satest09                     | /*                                        | ✓ OK
 satest10                     | /*                                        | ✓ OK
 satest11                     | /*                                        | ✓ OK
 satest12                     | /*                                        | ✓ OK
 satest13                     | /*                                        | ✓ OK
 satest14                     | /*                                        | ✓ OK
 satest15                     | /*                                        | ✓ OK
 satest16                     | /*                                        | ✓ OK
 security-admin-console       | /admin/CX-Central/console/*               | ✓ OK
 security-admin-console       | /admin/master/console/*                   | ✓ OK
(43 rows)
```

### ⚠️ Problemas encontrados:
- **Cl16-CX-BPDMGate**: `http://partners-gate.tx.test/*`
- **Cl1-CX-Registration**: `http://portal.tx.test/*`
- **Cl2-CX-Portal**: `http://portal.tx.test/*`
- **Cl3-CX-Semantic**: `http://portal.tx.test/*`
- **Cl5-CX-Custodian**: `http://managed-identity-wallets.tx.test/*`
- **Cl7-CX-BPDM**: `http://partners-pool.tx.test/*`

---

## 3. CENTRAL IDP - identity_provider_config

### Tabla: identity_provider_config
Verifica las URLs de configuración del proveedor de identidad CX-Operator.

```
 provider_alias |    config_key    |                                  config_value                                   |       status                                                                                                                           
----------------+------------------+---------------------------------------------------------------------------------+---------------------                                                                                                                    
 CX-Operator    | authorizationUrl | http://sharedidp.tx.test/auth/realms/CX-Operator/protocol/openid-connect/auth   | ⚠️  CONTIENE tx.test                                                                                                                     
 CX-Operator    | jwksUrl          | http://sharedidp.tx.test/auth/realms/CX-Operator/protocol/openid-connect/certs  | ⚠️  CONTIENE tx.test                                                                                                                     
 CX-Operator    | logoutUrl        | http://sharedidp.tx.test/auth/realms/CX-Operator/protocol/openid-connect/logout | ⚠️  CONTIENE tx.test                                                                                                                     
 CX-Operator    | tokenUrl         | http://sharedidp.tx.test/auth/realms/CX-Operator/protocol/openid-connect/token  | ⚠️  CONTIENE tx.test                                                                                                                    
(4 rows)
```

### ⚠️ Problemas encontrados:
Todas las 4 URLs del proveedor de identidad CX-Operator contienen tx.test:
- **authorizationUrl**: `http://sharedidp.tx.test/auth/realms/CX-Operator/protocol/openid-connect/auth`
- **jwksUrl**: `http://sharedidp.tx.test/auth/realms/CX-Operator/protocol/openid-connect/certs`
- **logoutUrl**: `http://sharedidp.tx.test/auth/realms/CX-Operator/protocol/openid-connect/logout`
- **tokenUrl**: `http://sharedidp.tx.test/auth/realms/CX-Operator/protocol/openid-connect/token`

---

## 4. CENTRAL IDP - Búsqueda global tx.test

### Resumen de todas las URLs con tx.test en Central IDP

```
          tabla           |    identificador    |                                       url                                                                                                                                                        
--------------------------+---------------------+------------------------------------------------------------------------
 client.root_url          | Cl2-CX-Portal       | http://portal.tx.test/home
 redirect_uris            | Cl16-CX-BPDMGate    | http://partners-gate.tx.test/*
 redirect_uris            | Cl1-CX-Registration | http://portal.tx.test/*
 redirect_uris            | Cl7-CX-BPDM         | http://partners-pool.tx.test/*
 redirect_uris            | Cl2-CX-Portal       | http://portal.tx.test/*
 redirect_uris            | Cl3-CX-Semantic     | http://portal.tx.test/*
 redirect_uris            | Cl5-CX-Custodian    | http://managed-identity-wallets.tx.test/*
 identity_provider_config | CX-Operator         | http://sharedidp.tx.test/auth/realms/CX-Operator/protocol/openid-connect/token
 identity_provider_config | CX-Operator         | http://sharedidp.tx.test/auth/realms/CX-Operator/protocol/openid-connect/auth
 identity_provider_config | CX-Operator         | http://sharedidp.tx.test/auth/realms/CX-Operator/protocol/openid-connect/certs
 identity_provider_config | CX-Operator         | http://sharedidp.tx.test/auth/realms/CX-Operator/protocol/openid-connect/logout
(11 rows)
```

**Total de URLs con tx.test en Central IDP**: 11

---

## 5. SHARED IDP - redirect_uris

### Tabla: redirect_uris
Verifica las URLs de redirección en SharedIDP.

```
       client_id        |                                  redirect_uri                                  |       status                                                                                                                                     
------------------------+--------------------------------------------------------------------------------+---------------------                                                                                                                      
 account                | /realms/CX-Operator/account/*                                                  | ✓ OK
 account                | /realms/master/account/*                                                       | ✓ OK
 account-console        | /realms/CX-Operator/account/*                                                  | ✓ OK
 account-console        | /realms/master/account/*                                                       | ✓ OK
 central-idp            | http://centralidp.tx.test/auth/realms/CX-Central/broker/CX-Operator/endpoint/* | ⚠️  CONTIENE tx.test                                                                                                                             
 sa-cl1-reg-1           | *                                                                              | ✓ OK
 saCX-Operator          | https://null                                                                   | ✓ OK
 security-admin-console | /admin/CX-Operator/console/*                                                   | ✓ OK
 security-admin-console | /admin/master/console/*                                                        | ✓ OK
(9 rows)
```

### ⚠️ Problema encontrado:
- **central-idp**: `http://centralidp.tx.test/auth/realms/CX-Central/broker/CX-Operator/endpoint/*`

---

## 6. SHARED IDP - client_attributes (jwks.url)

### Tabla: client_attributes
Verifica el atributo jwks.url del cliente central-idp.

```
  client_id  | attribute_name |                                attribute_value                                 |       status                                                                                                                     
-------------+----------------+--------------------------------------------------------------------------------+---------------------                                                                                                              
 central-idp | jwks.url       | http://centralidp.tx.test/auth/realms/CX-Central/protocol/openid-connect/certs | ⚠️  CONTIENE tx.test                                                                                                              
(1 row)
```

### ⚠️ Problema encontrado:
- **central-idp**: jwks.url = `http://centralidp.tx.test/auth/realms/CX-Central/protocol/openid-connect/certs`

---

## 7. SHARED IDP - Búsqueda global tx.test

### Resumen de todas las URLs con tx.test en Shared IDP

```
       tabla       | identificador |                                      url                                       
-------------------+---------------+--------------------------------------------------------------------------------
 redirect_uris     | central-idp   | http://centralidp.tx.test/auth/realms/CX-Central/broker/CX-Operator/endpoint/*
 client_attributes | central-idp   | http://centralidp.tx.test/auth/realms/CX-Central/protocol/openid-connect/certs
(2 rows)
```

**Total de URLs con tx.test en Shared IDP**: 2

---

## 8. RESUMEN - IPs configuradas actualmente

### En CENTRAL IDP

```
                url_base                 
-----------------------------------------
 http://managed-identity-wallets.tx.test
 http://partners-gate.tx.test
 http://partners-pool.tx.test
 http://portal.tx.test
 http://sharedidp.tx.test
 
(6 rows)
```

### En SHARED IDP

```
         url_base          
---------------------------
 http://centralidp.tx.test
 
(2 rows)
```

---

## Conclusiones y Recomendaciones

### Total de URLs con tx.test encontradas:
- **Central IDP**: 11 URLs
- **Shared IDP**: 2 URLs
- **Total**: 13 URLs que necesitan corrección

### URLs afectadas por dominio:
1. `portal.tx.test` - 4 ocurrencias
2. `sharedidp.tx.test` - 4 ocurrencias  
3. `centralidp.tx.test` - 2 ocurrencias
4. `partners-gate.tx.test` - 1 ocurrencia
5. `partners-pool.tx.test` - 1 ocurrencia
6. `managed-identity-wallets.tx.test` - 1 ocurrencia

### Acción requerida:

Para corregir estas URLs se debe:

1. **Editar fix-keycloak-urls-job.yaml** con la IP correcta del LoadBalancer
2. **Ejecutar el Job**: `kubectl apply -f fix-keycloak-urls-job.yaml -n portal`
3. **Verificar logs**: `kubectl logs -n portal job/fix-keycloak-urls -f`
4. **Reiniciar pods de centralidp**: `kubectl delete pod -n portal -l app.kubernetes.io/name=centralidp`
5. **Reiniciar pods de sharedidp**: `kubectl delete pod -n portal -l app.kubernetes.io/name=sharedidp`

### Nota importante:

Estas URLs con `tx.test` permanecen en la base de datos porque el **realm seeding de Keycloak es idempotente** - no actualiza valores que ya existen. Por eso es necesario ejecutar el Job de corrección manual después de cada nuevo despliegue con una IP diferente.

---

**Fin del reporte**
