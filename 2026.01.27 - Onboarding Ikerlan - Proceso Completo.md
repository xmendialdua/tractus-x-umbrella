# Onboarding de Business Partners en Catena-X Portal
**Fecha:** 27 de Enero de 2026  
**√öltima actualizaci√≥n:** 27 de Enero de 2026 - 21:30  
**Cluster:** OVH Kubernetes (portal namespace)  
**Empresa onboardeada:** Ikerlan (Primer Business Partner) ‚úÖ COMPLETADO

---

## üìã Resumen Ejecutivo

Este documento describe el proceso completo de onboarding de **Ikerlan** como Business Partner en la red Catena-X, utilizando el Portal desplegado en OVH y los componentes BPDM (Business Partner Data Management).

**Estado del Onboarding:**
1. ‚úÖ **Ikerlan** - COMPLETADO (27-Ene-2026 21:15)
2. ‚è≥ Assembly (siguiente - programado 28-Ene-2026)
3. ‚è≥ Fagor (siguiente)

**Resultado Final:**
- ‚úÖ Usuario puede hacer login en Portal
- ‚úÖ Empresa Ikerlan visible en sistema
- ‚úÖ BPN asignado: BPNL000000001IKL
- ‚úÖ Realm Keycloak configurado (idp1)
- ‚è≥ Pendiente: Completar datos de empresa en Portal UI

---

## üéØ PROCEDIMIENTO CORRECTO PARA ONBOARDING (VERSI√ìN OPTIMIZADA)

**Este es el procedimiento a seguir para onboardear un nuevo Business Partner.**  
**Tiempo estimado:** 15-20 minutos

### Prerrequisitos
- ‚úÖ Portal desplegado y funcionando
- ‚úÖ BPDM components operativos (Pool, Gate, Orchestrator)
- ‚úÖ Acceso a kubectl en el cluster
- ‚úÖ Datos del Business Partner recopilados

---

### PASO 1: Preparar Datos del Business Partner

Crear archivo `onboarding/<empresa>.txt` con:
- Nombre legal de la empresa
- CIF/NIF
- Direcci√≥n completa
- Email del contacto principal
- BPN asignado (formato: BPNL000000001XXX)

**Ejemplo para Ikerlan:** Ver `onboarding/Ikerlan.txt`

---

### PASO 2: Crear Invitaci√≥n en Portal UI

1. Acceder a Portal como administrador: `http://portal.51.68.114.44.nip.io`
2. Ir a **"Invite new partner"**
3. Introducir:
   - Email del contacto: `contacto@empresa.com`
   - Nombre de la empresa: `Nombre Legal`
4. Click en **"Invite Business Partner"**

**Resultado esperado:**
- La empresa se crea en `portal.companies` (company_status_id = 1)
- Se crea registro en `portal.company_applications` (application_status_id = 1)
- Se crea `portal.identity_provider` con alias `idp1` (o idp2, idp3...)
- Se crea usuario inicial en `portal.identities`

**‚ö†Ô∏è Nota:** El proceso autom√°tico NO completar√° porque falta servidor SMTP. Esto es normal.

---

### PASO 3: Identificar el Identity Provider Alias

```bash
# Obtener password de PostgreSQL
PGPASSWORD=$(kubectl get secret -n portal portal-postgres -o jsonpath='{.data.portal-password}' | base64 -d)

# Buscar la empresa y su identity provider alias
kubectl exec -n portal portal-portal-backend-postgresql-0 -- \
  env PGPASSWORD=$PGPASSWORD \
  psql -U portal -d postgres -c \
  "SELECT c.id as company_id, c.name, iip.iam_idp_alias, iip.metadata_url 
   FROM portal.companies c 
   JOIN portal.identity_providers ip ON ip.owner_id = c.id 
   JOIN portal.iam_identity_providers iip ON iip.identity_provider_id = ip.id 
   WHERE c.name = 'NOMBRE_EMPRESA' 
   ORDER BY c.date_created DESC LIMIT 1;"
```

**Resultado esperado:**
```
company_id              | name    | iam_idp_alias | metadata_url
30bdf87c-...            | Ikerlan | idp1          | http://sharedidp.../auth/realms/idp1
```

**Anotar:**
- `company_id`: UUID de la empresa
- `iam_idp_alias`: Realm a configurar en Keycloak (t√≠picamente idp1, idp2, idp3...)

---

### PASO 4: Configurar Realm en Keycloak Shared IDP

```bash
# Obtener token de administrador de Keycloak
ADMIN_PASS=$(kubectl get secret -n portal portal-sharedidp -o jsonpath='{.data.admin-password}' | base64 -d)

ADMIN_TOKEN=$(curl -s -X POST \
  "http://sharedidp.51.68.114.44.nip.io/auth/realms/master/protocol/openid-connect/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=password" \
  -d "client_id=admin-cli" \
  -d "username=admin" \
  -d "password=$ADMIN_PASS" | jq -r '.access_token')

# Verificar que el realm existe y desactivar requisito SSL
REALM_ALIAS="idp1"  # Usar el valor obtenido en PASO 3

curl -s -X PUT \
  "http://sharedidp.51.68.114.44.nip.io/auth/admin/realms/$REALM_ALIAS" \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d "{
    \"realm\": \"$REALM_ALIAS\",
    \"displayName\": \"Ikerlan\",
    \"enabled\": true,
    \"sslRequired\": \"none\"
  }"
```

---

### PASO 5: Crear Cliente OAuth2 para el Portal

```bash
curl -s -X POST \
  "http://sharedidp.51.68.114.44.nip.io/auth/admin/realms/$REALM_ALIAS/clients" \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "clientId": "Cl2-CX-Portal",
    "name": "Catena-X Portal Client",
    "enabled": true,
    "publicClient": true,
    "standardFlowEnabled": true,
    "implicitFlowEnabled": false,
    "directAccessGrantsEnabled": true,
    "serviceAccountsEnabled": false,
    "protocol": "openid-connect",
    "redirectUris": [
      "http://portal.51.68.114.44.nip.io/*",
      "http://portal.51.68.114.44.nip.io/home",
      "http://portal.51.68.114.44.nip.io/auth/*"
    ],
    "webOrigins": [
      "http://portal.51.68.114.44.nip.io"
    ],
    "attributes": {
      "post.logout.redirect.uris": "http://portal.51.68.114.44.nip.io/*"
    }
  }'
```

---

### PASO 6: Obtener Usuario y Configurar Contrase√±a

```bash
# Buscar el usuario en el realm
USER_EMAIL="contacto@empresa.com"

USER_INFO=$(curl -s -X GET \
  "http://sharedidp.51.68.114.44.nip.io/auth/admin/realms/$REALM_ALIAS/users?email=$USER_EMAIL" \
  -H "Authorization: Bearer $ADMIN_TOKEN")

USER_ID=$(echo $USER_INFO | jq -r '.[0].id')
echo "Usuario ID: $USER_ID"

# Establecer contrase√±a
curl -s -X PUT \
  "http://sharedidp.51.68.114.44.nip.io/auth/admin/realms/$REALM_ALIAS/users/$USER_ID/reset-password" \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "password",
    "value": "Welcome2Catena-X!",
    "temporary": false
  }'
```

---

### PASO 7: Actualizar Base de Datos con UUID de Keycloak

```bash
# Actualizar user_entity_id en portal.identities
kubectl exec -n portal portal-portal-backend-postgresql-0 -- \
  env PGPASSWORD=$PGPASSWORD \
  psql -U portal -d postgres -c \
  "UPDATE portal.identities 
   SET user_entity_id = '$USER_ID' 
   WHERE company_id = 'COMPANY_ID_DEL_PASO_3';"

# Actualizar BPN en portal.companies
kubectl exec -n portal portal-portal-backend-postgresql-0 -- \
  env PGPASSWORD=$PGPASSWORD \
  psql -U portal -d postgres -c \
  "UPDATE portal.companies 
   SET business_partner_number = 'BPNL000000001XXX' 
   WHERE id = 'COMPANY_ID_DEL_PASO_3';"
```

---

### PASO 8: Verificar REQUIRE_HTTPS en Portal Frontend

```bash
# Verificar que est√° en false
kubectl get deployment -n portal portal-portal -o jsonpath='{.spec.template.spec.containers[0].env[?(@.name=="REQUIRE_HTTPS_URL_PATTERN")].value}'

# Si no es 'false', cambiarlo:
kubectl set env deployment/portal-portal -n portal REQUIRE_HTTPS_URL_PATTERN=false
```

---

### PASO 9: Reiniciar Servicios del Portal

```bash
# Reiniciar todos los servicios del Portal para recargar configuraci√≥n
kubectl delete pod -n portal -l app.kubernetes.io/name=portal --field-selector=status.phase=Running

# Esperar a que todos los pods est√©n Running
kubectl get pods -n portal -l app.kubernetes.io/name=portal -w
```

---

### PASO 10: Probar Login

1. Abrir navegador en **modo inc√≥gnito**
2. Navegar a: `http://portal.51.68.114.44.nip.io`
3. Click en **"Login"**
4. Introducir credenciales:
   - Email: `contacto@empresa.com`
   - Password: `Welcome2Catena-X!`
5. Verificar redirecci√≥n a Keycloak realm correcto
6. Tras login exitoso, completar datos de la empresa en el Portal

**URLs esperadas en el flujo:**
- Portal inicial: `http://portal.51.68.114.44.nip.io`
- Keycloak login: `http://sharedidp.51.68.114.44.nip.io/auth/realms/idp1/...`
- Portal tras login: `http://portal.51.68.114.44.nip.io` (con sesi√≥n activa)

---

### Verificaci√≥n Final

```bash
# Verificar que el usuario puede hacer login
# Debe redirigir al Portal sin errores

# Verificar en logs del Portal backend
kubectl logs -n portal -l app.kubernetes.io/name=portal-registration-service --tail=50

# Verificar empresa en base de datos
kubectl exec -n portal portal-portal-backend-postgresql-0 -- \
  env PGPASSWORD=$PGPASSWORD \
  psql -U portal -d postgres -c \
  "SELECT id, name, business_partner_number, company_status_id 
   FROM portal.companies 
   WHERE name = 'NOMBRE_EMPRESA';"
```

**‚úÖ Onboarding completado cuando:**
- Usuario puede hacer login sin errores
- Portal muestra pantalla de "Complete Your Registration"
- BPN aparece en los datos de la empresa
- Usuario tiene rol "Company Admin"

---

## üìö DOCUMENTACI√ìN COMPLETA DEL PROCESO (Incluye Errores y Soluciones)

**Nota:** Esta secci√≥n documenta TODO el proceso realizado, incluyendo los errores encontrados y c√≥mo se resolvieron. Es √∫til para entender el debugging pero NO es necesario seguir estos pasos si se usa el procedimiento optimizado anterior.

---

## üõ†Ô∏è Pasos Previos Completados

### 1. Correcci√≥n de ConfigMaps BPDM (URLs tx.test ‚Üí LoadBalancer IP)

**Problema inicial:** ConfigMaps con URLs de test (`centralidp.tx.test`, `business-partners.tx.test`)

**Soluci√≥n aplicada:** Patch manual con `kubectl + jq`

```bash
# Corregir auth-server-url en los 4 ConfigMaps
kubectl get configmap portal-bpdm-orchestrator -n portal -o json \
  | jq '.data."deployment.yml" |= gsub("centralidp.tx.test"; "centralidp.51.68.114.44.nip.io")' \
  | kubectl apply -f -

kubectl get configmap portal-bpdm-gate -n portal -o json \
  | jq '.data."deployment.yml" |= gsub("centralidp.tx.test"; "centralidp.51.68.114.44.nip.io")' \
  | kubectl apply -f -

kubectl get configmap portal-bpdm-pool -n portal -o json \
  | jq '.data."deployment.yml" |= gsub("centralidp.tx.test"; "centralidp.51.68.114.44.nip.io")' \
  | kubectl apply -f -

kubectl get configmap portal-bpdm-cleaning-service-dummy -n portal -o json \
  | jq '.data."deployment.yml" |= gsub("centralidp.tx.test"; "centralidp.51.68.114.44.nip.io")' \
  | kubectl apply -f -
```

**Resultado:** ‚úÖ ConfigMaps con URLs correctas

---

### 2. Correcci√≥n de URLs Inter-Servicios (Externas ‚Üí Internas)

**Problema:** Pods BPDM intentaban comunicarse usando URLs externas del LoadBalancer en lugar de servicios internos del cluster.

**Soluci√≥n aplicada:** Cambiar a URLs internas de Kubernetes

```bash
# Pool: usar URL interna de Orchestrator
kubectl get configmap portal-bpdm-pool -n portal -o json \
  | jq '.data."deployment.yml" |= gsub("http://business-partners.51.68.114.44.nip.io/orchestrator"; "http://portal-bpdm-orchestrator:80")' \
  | kubectl apply -f -

# Gate: usar URLs internas de Pool y Orchestrator
kubectl get configmap portal-bpdm-gate -n portal -o json \
  | jq '.data."deployment.yml" |= gsub("http://business-partners.51.68.114.44.nip.io/orchestrator"; "http://portal-bpdm-orchestrator:80") | .data."deployment.yml" |= gsub("http://business-partners.51.68.114.44.nip.io/pool"; "http://portal-bpdm-pool:80")' \
  | kubectl apply -f -

# Cleaning Service: usar URL interna de Orchestrator
kubectl get configmap portal-bpdm-cleaning-service-dummy -n portal -o json \
  | jq '.data."deployment.yml" |= gsub("http://business-partners.51.68.114.44.nip.io/orchestrator"; "http://portal-bpdm-orchestrator:80")' \
  | kubectl apply -f -
```

**Resultado:** ‚úÖ Comunicaci√≥n interna optimizada

---

### 3. Reinicio de Pods BPDM

**Raz√≥n:** Cargar los ConfigMaps actualizados

```bash
kubectl delete pod -n portal -l app.kubernetes.io/name=bpdm-pool
kubectl delete pod -n portal -l app.kubernetes.io/name=bpdm-gate
kubectl delete pod -n portal -l app.kubernetes.io/name=bpdm-orchestrator
kubectl delete pod -n portal -l app.kubernetes.io/name=bpdm-cleaning-service-dummy
```

**Resultado:** ‚úÖ Todos los pods BPDM en estado Running

---

### 4. Correcci√≥n de Ingress BPDM

**Problema:** Ingress con `<none>` en CLASS y `business-partners.tx.test` en HOST

**Soluci√≥n aplicada:** Patch manual de los 3 Ingress

```bash
# Pool
kubectl patch ingress portal-bpdm-pool -n portal --type=json -p='[
  {"op": "add", "path": "/spec/ingressClassName", "value": "nginx"},
  {"op": "replace", "path": "/spec/rules/0/host", "value": "business-partners.51.68.114.44.nip.io"}
]'

# Gate
kubectl patch ingress portal-bpdm-gate -n portal --type=json -p='[
  {"op": "add", "path": "/spec/ingressClassName", "value": "nginx"},
  {"op": "replace", "path": "/spec/rules/0/host", "value": "business-partners.51.68.114.44.nip.io"}
]'

# Orchestrator
kubectl patch ingress portal-bpdm-orchestrator -n portal --type=json -p='[
  {"op": "add", "path": "/spec/ingressClassName", "value": "nginx"},
  {"op": "replace", "path": "/spec/rules/0/host", "value": "business-partners.51.68.114.44.nip.io"}
]'
```

**Resultado:** ‚úÖ Ingress accesibles externamente

**Script automatizado:** `fix-bpdm-ingress.sh`

Scripts para ejecuci√≥n interactiva en fichero txt: `fix-bpdm-ingress.txt`

---

### 5. Actualizaci√≥n de Ficheros de Configuraci√≥n

**Ficheros modificados:**
- ‚úÖ `values-ovh-hosts-portal.yaml` - A√±adida configuraci√≥n de Ingress BPDM
- ‚úÖ `values-ovh-hosts-portal-template.yaml` - Template actualizado para futuros despliegues

**Contenido a√±adido:**
```yaml
# BPDM Configuration
bpdm-gate:
  ingress:
    enabled: true
    className: "nginx"
    hosts:
      - host: "business-partners.51.68.114.44.nip.io"
        paths:
          - path: /gate
            pathType: Prefix
  applicationConfig:
    bpdm:
      security:
        authServerUrl: "http://centralidp.51.68.114.44.nip.io/auth"
      pool:
        baseUrl: "http://portal-bpdm-pool:80"
      orchestrator:
        baseUrl: "http://portal-bpdm-orchestrator:80"

bpdm-pool:
  ingress:
    enabled: true
    className: "nginx"
    hosts:
      - host: "business-partners.51.68.114.44.nip.io"
        paths:
          - path: /pool
            pathType: Prefix
  applicationConfig:
    bpdm:
      security:
        authServerUrl: "http://centralidp.51.68.114.44.nip.io/auth"
      orchestrator:
        baseUrl: "http://portal-bpdm-orchestrator:80"

bpdm-orchestrator:
  ingress:
    enabled: true
    className: "nginx"
    hosts:
      - host: "business-partners.51.68.114.44.nip.io"
        paths:
          - path: /orchestrator
            pathType: Prefix
```

---

## ‚úÖ Estado Actual: Componentes Operativos

### üåê Interfaces Web

| Componente | Estado | URL | Descripci√≥n |
|------------|--------|-----|-------------|
| **üè† Portal Frontend** | ‚úÖ Running | http://portal.51.68.114.44.nip.io | Interfaz principal de usuario |
| **‚öôÔ∏è Portal Backend** | ‚úÖ Running | http://portal-backend.51.68.114.44.nip.io | API REST del Portal |
| **üîê Keycloak Central IDP** | ‚úÖ Running | http://centralidp.51.68.114.44.nip.io | Gesti√≥n de identidades central |
| **üîë Keycloak Shared IDP** | ‚úÖ Running | http://sharedidp.51.68.114.44.nip.io | Identidades compartidas |
| **üóÑÔ∏è PgAdmin4** | ‚úÖ Running | http://pgadmin4.51.68.114.44.nip.io | Administraci√≥n de bases de datos |

### üè¢ Servicios BPDM (Business Partner Data Management)

| Componente | Estado | URL | Health Check | Descripci√≥n |
|------------|--------|-----|--------------|-------------|
| **üö™ BPDM Gate** | ‚úÖ Running | http://business-partners.51.68.114.44.nip.io/gate | ‚úÖ 200 OK | API p√∫blica para Business Partners |
| **üèä BPDM Pool** | ‚úÖ Running | http://business-partners.51.68.114.44.nip.io/pool | ‚úÖ 200 OK | Pool central de datos maestros |
| **üéº BPDM Orchestrator** | ‚úÖ Running | http://business-partners.51.68.114.44.nip.io/orchestrator | ‚úÖ 200 OK | Orquestaci√≥n de flujos BPDM |
| **üßπ BPDM Cleaning Service** | ‚úÖ Running | (interno) | N/A | Servicio de limpieza de datos |

### üíæ Bases de Datos

| Base de Datos | Pod | Estado | Descripci√≥n |
|---------------|-----|--------|-------------|
| **üìä Portal PostgreSQL** | portal-portal-backend-postgresql-0 | ‚úÖ Running | Datos del Portal |
| **üîê Central IDP PostgreSQL** | portal-centralidp-postgresql-0 | ‚úÖ Running | Datos de Keycloak Central |
| **üîë Shared IDP PostgreSQL** | portal-sharedidp-postgresql-0 | ‚úÖ Running | Datos de Keycloak Shared |
| **üè¢ BPDM PostgreSQL** | bpdm-postgres-0 | ‚úÖ Running | Datos de Business Partners |

### üì¶ Pods Totales por Tipo

```
‚úÖ 5 BPDM pods (orchestrator, pool, gate, cleaning-service, postgres)
‚úÖ 3 Keycloak pods (centralidp, sharedidp con PostgreSQL)
‚úÖ 6 Portal backend services (administration, registration, notification, provisioning, marketplace, services)
‚úÖ 3 Portal frontend (portal, assets, registration)
‚úÖ 1 PgAdmin4
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìä Total: ~50 pods operativos
```

### üîå Ingress Configurados

```bash
$ kubectl get ingress -n portal | grep -E "(NAME|portal|centralidp|sharedidp|business-partners)"

NAME                       CLASS    HOSTS                                ADDRESS        PORTS
portal-bpdm-gate           nginx    business-partners.51.68.114.44.nip.io   51.68.114.44   80
portal-bpdm-orchestrator   nginx    business-partners.51.68.114.44.nip.io   51.68.114.44   80
portal-bpdm-pool           nginx    business-partners.51.68.114.44.nip.io   51.68.114.44   80
portal-centralidp          nginx    centralidp.51.68.114.44.nip.io          51.68.114.44   80
portal-frontend            nginx    portal.51.68.114.44.nip.io              51.68.114.44   80
portal-pgadmin4            nginx    pgadmin4.51.68.114.44.nip.io            51.68.114.44   80
portal-portal-backend      nginx    portal-backend.51.68.114.44.nip.io      51.68.114.44   80
portal-sharedidp           nginx    sharedidp.51.68.114.44.nip.io           51.68.114.44   80
```

---

## üéØ Proceso de Onboarding: Ikerlan

### Informaci√≥n del Business Partner

**Empresa:** Ikerlan  
**Pa√≠s:** Espa√±a  
**Tipo:** Centro de Investigaci√≥n y Desarrollo Tecnol√≥gico  
**Sector:** Automoci√≥n, Electr√≥nica, Energ√≠a  
**Ciudad:** Mondrag√≥n, Guip√∫zcoa

### Datos Necesarios para el Onboarding

Antes de comenzar, necesitamos recopilar la siguiente informaci√≥n de Ikerlan:

- [ ] **Nombre legal de la empresa:** "Ikerlan S.Coop."
- [ ] **Direcci√≥n completa:**
  - Calle/Avenida
  - C√≥digo postal
  - Ciudad
  - Pa√≠s
- [ ] **Identificadores fiscales:**
  - CIF/NIF (Espa√±a)
  - N√∫mero de registro mercantil
- [ ] **Contacto principal:**
  - Nombre y apellidos
  - Email corporativo
  - Tel√©fono
  - Cargo en la empresa
- [ ] **Informaci√≥n adicional:**
  - Sitio web
  - Descripci√≥n de actividad
  - BPN (Business Partner Number) - si ya tiene uno

---

## üìù FASE 1: Acceso al Portal

### Paso 1.1: Verificar Acceso al Portal

**Comando:**
```bash
curl -s -o /dev/null -w "%{http_code}" http://portal.51.68.114.44.nip.io
```

**Resultado esperado:** `200`

**¬øQu√© estamos haciendo?**
- Verificamos que el Portal est√° accesible p√∫blicamente
- Confirmamos que el frontend responde correctamente

---

### Paso 1.2: Acceder al Portal v√≠a Navegador

**URL:** http://portal.51.68.114.44.nip.io

**¬øQu√© veremos?**
- Pantalla de bienvenida del Portal Catena-X
- Bot√≥n "Register Company" o "Login"
- Idioma: Ingl√©s/Alem√°n (por defecto)

**Acci√≥n:**
1. Abrir navegador
2. Navegar a la URL del Portal
3. Verificar que la p√°gina carga correctamente

---

## üìã FASE 2: Registro Inicial de la Empresa

### Paso 2.1: Iniciar Proceso de Registro

**En el Portal:**
1. Clic en **"Register Company"** o **"Company Registration"**
2. Aceptar t√©rminos y condiciones

**¬øQu√© estamos haciendo?**
- Iniciando el proceso de self-registration en el Portal
- Este es el flujo est√°ndar de onboarding en Catena-X

---

### Paso 2.2: Completar Formulario de Datos B√°sicos

**Datos a ingresar:**

#### Informaci√≥n de la Empresa
```
Legal Name:       Ikerlan S.Coop.
Short Name:       Ikerlan
Street:           [Direcci√≥n completa]
Postal Code:      [C√≥digo postal]
City:             Mondrag√≥n
Country:          Spain
Tax ID:           [CIF de Ikerlan]
Commercial Reg:   [N√∫mero de registro mercantil]
Website:          https://www.ikerlan.es
```

#### Contacto Principal
```
First Name:       [Nombre]
Last Name:        [Apellidos]
Email:            [email@ikerlan.es]
Phone:            [+34 XXX XXX XXX]
Position:         [Cargo]
```

**¬øQu√© hace el sistema?**
- Valida los datos ingresados
- Verifica que el email sea corporativo (@ikerlan.es)
- Comprueba si la empresa ya existe en BPDM

---

### Paso 2.3: Verificaci√≥n de Identidad

**Proceso autom√°tico:**
1. El Portal env√≠a un **email de verificaci√≥n** a la direcci√≥n proporcionada
2. El contacto debe hacer clic en el link del email
3. Esto confirma que el email es v√°lido y accesible

**Verificar env√≠o de email:**
```bash
kubectl logs -n portal -l app.kubernetes.io/name=notification-service --tail=50 | grep -i "ikerlan"
```

**¬øQu√© estamos haciendo?**
- Verificamos que el servicio de notificaciones proces√≥ el env√≠o de email
- Confirmamos que no hay errores en el proceso

**NOTA:** Si no hay servidor SMTP configurado (smtp4dev deshabilitado), este paso puede fallar. En entornos de desarrollo, podemos saltar la verificaci√≥n de email manualmente.

---

## üè¢ FASE 3: Creaci√≥n del Business Partner en BPDM

Una vez verificado el email, el Portal debe crear autom√°ticamente un registro en BPDM Pool.

### Paso 3.1: Verificar Creaci√≥n Autom√°tica en BPDM Pool

**Comando:**
```bash
# Obtener token de autenticaci√≥n de Keycloak
TOKEN=$(curl -s -X POST "http://centralidp.51.68.114.44.nip.io/auth/realms/CX-Central/protocol/openid-connect/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=client_credentials" \
  -d "client_id=Cl7-CX-BPDM" \
  -d "client_secret=SECRETO_DEL_CLIENTE" | jq -r '.access_token')

# Buscar Business Partner por nombre
curl -X GET "http://business-partners.51.68.114.44.nip.io/pool/v7/business-partners?legalName=Ikerlan" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" | jq
```

**¬øQu√© estamos haciendo?**
- Obtenemos un token OAuth2 de Keycloak usando el cliente t√©cnico de BPDM
- Buscamos en BPDM Pool si ya existe un Business Partner con el nombre "Ikerlan"
- Si el registro autom√°tico funcion√≥, deber√≠amos ver el registro creado

**Resultado esperado (si existe):**
```json
{
  "totalElements": 1,
  "content": [
    {
      "bpn": "BPNL000000000XXX",
      "legalName": "Ikerlan S.Coop.",
      "legalForm": "S.COOP",
      "status": "ACTIVE",
      "addresses": [...]
    }
  ]
}
```

---

### Paso 3.2: Creaci√≥n Manual (si no existe)

Si el registro autom√°tico fall√≥ o no est√° implementado, creamos el Business Partner manualmente:

**Comando:**
```bash
# Crear Business Partner en BPDM Pool
curl -X POST "http://business-partners.51.68.114.44.nip.io/pool/v7/business-partners" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "legalName": "Ikerlan S.Coop.",
    "shortName": "Ikerlan",
    "legalForm": "S.COOP",
    "status": "ACTIVE",
    "classifications": [
      {
        "value": "RESEARCH_DEVELOPMENT",
        "code": "NACE",
        "type": "72.1"
      }
    ],
    "addresses": [
      {
        "addressType": "LEGAL_ADDRESS",
        "physicalPostalAddress": {
          "country": "ES",
          "city": "Mondrag√≥n",
          "postalCode": "20500",
          "street": {
            "name": "P¬∫ J.M. Arizmendiarrieta",
            "houseNumber": "2"
          }
        }
      }
    ],
    "identifiers": [
      {
        "type": "VAT_ID",
        "value": "ESF20459407",
        "issuingBody": "Agencia Tributaria Espa√±a"
      }
    ]
  }' | jq
```

**¬øQu√© estamos haciendo?**
- Creamos un nuevo registro de Business Partner en BPDM Pool
- Incluimos informaci√≥n legal, direcci√≥n, identificadores fiscales
- El sistema asignar√° autom√°ticamente un **BPN (Business Partner Number)** √∫nico

**Resultado esperado:**
```json
{
  "bpn": "BPNL000000000123",
  "legalName": "Ikerlan S.Coop.",
  "createdAt": "2026-01-27T15:30:00Z",
  "updatedAt": "2026-01-27T15:30:00Z"
}
```

**‚ö†Ô∏è IMPORTANTE:** Guarda el **BPN** generado, lo necesitaremos en siguientes pasos.

---

### Paso 3.3: Verificar el BPN Asignado

**Comando:**
```bash
# Ver el Business Partner creado
curl -X GET "http://business-partners.51.68.114.44.nip.io/pool/v7/business-partners/BPNL000000000123" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" | jq
```

**¬øQu√© estamos haciendo?**
- Recuperamos el registro completo del Business Partner usando su BPN
- Verificamos que todos los datos se guardaron correctamente
- Confirmamos que el estado es ACTIVE

---

## üîê FASE 4: Configuraci√≥n de Acceso en Keycloak

### Paso 4.1: Crear Realm de Ikerlan en Shared IDP

**¬øPor qu√© crear un Realm?**
- Cada Business Partner tiene su propio realm en Shared IDP
- Esto permite gesti√≥n independiente de usuarios y roles
- Facilita la integraci√≥n con sus propios sistemas de identidad

**Comando:**
```bash
# Obtener token admin de Keycloak
ADMIN_TOKEN=$(curl -s -X POST "http://sharedidp.51.68.114.44.nip.io/auth/realms/master/protocol/openid-connect/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=password" \
  -d "client_id=admin-cli" \
  -d "username=admin" \
  -d "password=PASSWORD_DE_ADMIN" | jq -r '.access_token')

# Crear realm para Ikerlan
curl -X POST "http://sharedidp.51.68.114.44.nip.io/auth/admin/realms" \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "realm": "CX-Operator-Ikerlan",
    "enabled": true,
    "displayName": "Ikerlan Operator Realm",
    "loginTheme": "catenax-shared",
    "attributes": {
      "bpn": "BPNL000000000123"
    }
  }'
```

**¬øQu√© estamos haciendo?**
- Creamos un realm dedicado para Ikerlan en Shared IDP
- El realm se llama "CX-Operator-Ikerlan"
- Asociamos el realm con el BPN de Ikerlan mediante un atributo

---

### Paso 4.2: Crear Usuario Administrador para Ikerlan

**Comando:**
```bash
# Crear usuario admin de Ikerlan
curl -X POST "http://sharedidp.51.68.114.44.nip.io/auth/admin/realms/CX-Operator-Ikerlan/users" \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin@ikerlan.es",
    "email": "admin@ikerlan.es",
    "firstName": "Admin",
    "lastName": "Ikerlan",
    "enabled": true,
    "emailVerified": true,
    "attributes": {
      "bpn": ["BPNL000000000123"]
    },
    "credentials": [
      {
        "type": "password",
        "value": "ChangeMe123!",
        "temporary": true
      }
    ]
  }'
```

**¬øQu√© estamos haciendo?**
- Creamos el usuario administrador inicial para Ikerlan
- Password temporal "ChangeMe123!" (deber√°n cambiarlo al primer login)
- Asociamos el usuario con el BPN mediante atributos

---

### Paso 4.3: Asignar Roles al Usuario Admin

**Comando:**
```bash
# Obtener ID del usuario creado
USER_ID=$(curl -s -X GET "http://sharedidp.51.68.114.44.nip.io/auth/admin/realms/CX-Operator-Ikerlan/users?username=admin@ikerlan.es" \
  -H "Authorization: Bearer $ADMIN_TOKEN" | jq -r '.[0].id')

# Obtener rol "Company Admin"
ROLE_ID=$(curl -s -X GET "http://sharedidp.51.68.114.44.nip.io/auth/admin/realms/CX-Operator-Ikerlan/roles" \
  -H "Authorization: Bearer $ADMIN_TOKEN" | jq -r '.[] | select(.name=="Company Admin") | .id')

# Asignar rol al usuario
curl -X POST "http://sharedidp.51.68.114.44.nip.io/auth/admin/realms/CX-Operator-Ikerlan/users/$USER_ID/role-mappings/realm" \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '[
    {
      "id": "'$ROLE_ID'",
      "name": "Company Admin"
    }
  ]'
```

**¬øQu√© estamos haciendo?**
- Asignamos el rol "Company Admin" al usuario
- Este rol da permisos para gestionar la empresa en el Portal
- Permite crear m√°s usuarios, gestionar aplicaciones, etc.

---

## ‚úÖ FASE 5: Verificaci√≥n Final del Onboarding

### Paso 5.1: Verificar en BPDM Pool

**Comando:**
```bash
curl -X GET "http://business-partners.51.68.114.44.nip.io/pool/v7/business-partners/BPNL000000000123" \
  -H "Authorization: Bearer $TOKEN" | jq
```

**Verificar:**
- ‚úÖ BPN asignado
- ‚úÖ Estado: ACTIVE
- ‚úÖ Datos completos (nombre, direcci√≥n, identificadores)

---

### Paso 5.2: Verificar en Keycloak Shared IDP

**Comando:**
```bash
# Listar usuarios del realm de Ikerlan
curl -X GET "http://sharedidp.51.68.114.44.nip.io/auth/admin/realms/CX-Operator-Ikerlan/users" \
  -H "Authorization: Bearer $ADMIN_TOKEN" | jq
```

**Verificar:**
- ‚úÖ Realm "CX-Operator-Ikerlan" existe
- ‚úÖ Usuario admin@ikerlan.es creado
- ‚úÖ Usuario tiene rol "Company Admin"

---

### Paso 5.3: Test de Login en el Portal

**Acci√≥n manual:**
1. Abrir navegador: http://portal.51.68.114.44.nip.io
2. Clic en "Login"
3. Seleccionar "Login with Company IDP" o "Shared IDP"
4. Ingresar:
   - Username: `admin@ikerlan.es`
   - Password: `ChangeMe123!`
5. El sistema pedir√° cambiar el password (es temporal)
6. Cambiar a un password seguro

**Verificar:**
- ‚úÖ Login exitoso
- ‚úÖ Redirecci√≥n al dashboard del Portal
- ‚úÖ Nombre de la empresa visible en la interfaz
- ‚úÖ BPN visible en el perfil

---

### Paso 5.4: Verificar Acceso a Funcionalidades

Una vez dentro del Portal, verificar acceso a:

- ‚úÖ **Dashboard:** Vista general de la empresa
- ‚úÖ **Company Data:** Ver y editar datos de la empresa
- ‚úÖ **User Management:** Gestionar usuarios de Ikerlan
- ‚úÖ **App Marketplace:** Ver aplicaciones disponibles
- ‚úÖ **Use Cases:** Ver casos de uso de Catena-X
- ‚úÖ **Admin Board:** Panel de administraci√≥n (solo con rol Admin)

---

## üìä Resumen del Onboarding de Ikerlan

### Datos Finales

```
Empresa:          Ikerlan S.Coop.
BPN Asignado:     BPNL000000000123
Realm Keycloak:   CX-Operator-Ikerlan
Usuario Admin:    admin@ikerlan.es
Estado BPDM:      ACTIVE
Estado Keycloak:  ENABLED
```

### Recursos Creados

| Recurso | Ubicaci√≥n | Detalles |
|---------|-----------|----------|
| **Business Partner** | BPDM Pool | BPN: BPNL000000000123 |
| **Realm** | Shared IDP | CX-Operator-Ikerlan |
| **Usuario Admin** | Shared IDP | admin@ikerlan.es |
| **Registro Portal** | Portal DB | Company ID + BPN asociado |

---

## ‚ö†Ô∏è PROBLEMAS ENCONTRADOS DURANTE LA EJECUCI√ìN

### Fecha de Ejecuci√≥n: 27 de Enero de 2026

---

### ‚ùå PROBLEMA 1: Secret de Cliente BPDM No Encontrado

**Momento:** Al intentar obtener token OAuth2 para acceder a BPDM

**Error:**
```bash
Error from server (NotFound): secrets "portal-backend-client-secret" not found
```

**Diagn√≥stico:**
- El secret esperado no exist√≠a con ese nombre
- Los secrets reales est√°n en `portal-centralidp-clients` y `portal-centralidp-base-service-accounts`

**Soluci√≥n:**
```bash
# Buscar secrets correctos
kubectl get secrets -n portal | grep -i "client\|secret"

# Identificar el service account correcto
kubectl get secret portal-centralidp-base-service-accounts -n portal -o jsonpath='{.data}' | jq -r 'keys[]'

# Cliente correcto: sa-cl25-cx-2
TOKEN=$(curl -s -X POST "http://centralidp.51.68.114.44.nip.io/auth/realms/CX-Central/protocol/openid-connect/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=client_credentials" \
  -d "client_id=sa-cl25-cx-2" \
  -d "client_secret=$(kubectl get secret portal-centralidp-base-service-accounts -n portal -o jsonpath='{.data.sa-cl25-cx-2}' | base64 -d)" | jq -r '.access_token')
```

**Resultado:** ‚úÖ Token obtenido correctamente (length: 1425)

---

### ‚ùå PROBLEMA 2: Cliente OAuth2 No Habilitado para Service Account

**Momento:** Al intentar usar cliente `Cl7-CX-BPDM`

**Error:**
```json
{
  "error": "unauthorized_client",
  "error_description": "Client not enabled to retrieve service account"
}
```

**Diagn√≥stico:**
- El cliente `Cl7-CX-BPDM` existe pero no est√° configurado como service account
- Los ConfigMaps de BPDM usan `sa-cl25-cx-2` para comunicaci√≥n con el orchestrator

**Soluci√≥n:**
Usar el cliente t√©cnico correcto: `sa-cl25-cx-2`

---

### ‚ùå PROBLEMA 3: API BPDM Versi√≥n Incorrecta

**Momento:** Al buscar Business Partners en BPDM Pool

**Error:**
```json
{
  "type": "about:blank",
  "title": "Not Found",
  "status": 404,
  "detail": "No static resource v7/business-partners.",
  "instance": "/pool/v7/business-partners"
}
```

**Diagn√≥stico:**
- La documentaci√≥n menciona API v7, pero el deployment usa v6
- BPDM Pool versi√≥n 7.1.0 tiene API v6

**Soluci√≥n:**
```bash
# Usar API v6 en lugar de v7
curl -s "http://business-partners.51.68.114.44.nip.io/pool/v6/business-partners?legalName=Ikerlan" \
  -H "Authorization: Bearer $TOKEN"
```

**Resultado:** ‚úÖ API v6 funciona correctamente

---

### ‚ùå PROBLEMA 4: Flujo de Invitaci√≥n Bloqueado por SMTP

**Momento:** Al ejecutar invitaci√≥n desde el Portal UI

**Estado:** Invitaci√≥n creada con estado "CREATED" pero no procesada

**Error en logs del portal-processes-worker:**
```
System.Net.Sockets.SocketException (111): Connection refused
at MailKit.Net.Smtp.SmtpClient.ConnectAsync
Critical error : processing process [ID] type MAILING: "Connection refused"
```

**Diagn√≥stico:**
1. La invitaci√≥n se guard√≥ en la base de datos del Portal
2. El CronJob `portal-processes-worker` (ejecuta cada 5 minutos) intenta procesar invitaciones pendientes
3. El proceso incluye enviar email de invitaci√≥n v√≠a SMTP
4. No hay servidor SMTP configurado en el deployment
5. El job falla repetidamente bloqueando todo el flujo de onboarding autom√°tico

**Componentes verificados:**
- ‚úÖ Invitaci√≥n visible en Portal UI (Status: CREATED)
- ‚ùå Realm en Keycloak: No creado
- ‚ùå Business Partner en BPDM: No creado
- ‚ùå Usuario en Keycloak: No creado

**Impacto:**
- El flujo autom√°tico de onboarding est√° completamente bloqueado
- Los recursos (realm, BPN, usuario) no se crean hasta que el email se env√≠e
- En producci√≥n, el usuario recibir√≠a un email con un link de activaci√≥n

**Soluci√≥n adoptada:**
Crear manualmente los 3 componentes esenciales:
1. Business Partner en BPDM Pool (con BPN predefinido)
2. Realm en Shared IDP  
3. Usuario admin en Keycloak

**Nota:** En un entorno de producci√≥n real, se deber√≠a:
- Configurar un servidor SMTP (Mailgun, SendGrid, servidor corporativo)
- O usar un servidor SMTP de prueba como smtp4dev o MailHog

---

### ‚ùå PROBLEMA 5: Token OAuth2 Expirado

**Momento:** Al intentar consultar BPDM Pool despu√©s de varios minutos

**Error:**
```
HTTP/1.1 401
WWW-Authenticate: Bearer error="invalid_token", error_description="An error occurred while attempting to decode the Jwt: Jwt expired at 2026-01-27T15:34:14Z"
```

**Diagn√≥stico:**
- Los tokens OAuth2 tienen una duraci√≥n limitada (aprox. 5 minutos)
- Es necesario regenerar el token peri√≥dicamente

**Soluci√≥n:**
```bash
# Regenerar token cuando expire
TOKEN=$(curl -s -X POST "http://centralidp.51.68.114.44.nip.io/auth/realms/CX-Central/protocol/openid-connect/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=client_credentials" \
  -d "client_id=sa-cl25-cx-2" \
  -d "client_secret=$(kubectl get secret portal-centralidp-base-service-accounts -n portal -o jsonpath='{.data.sa-cl25-cx-2}' | base64 -d)" | jq -r '.access_token')
```

**Resultado:** ‚úÖ Token regenerado

---

### ‚ùå PROBLEMA 6: Endpoints BPDM Pool API v6 No Documentados

**Momento:** Al intentar crear Business Partner en BPDM Pool

**Endpoints probados que NO funcionan:**
- `POST /pool/v6/business-partners` ‚Üí 404 Not Found o no responde
- `POST /pool/v6/business-partners/input` ‚Üí 404 "No static resource"

**Diagn√≥stico:**
- La API v6 de BPDM Pool tiene endpoints diferentes a v7
- No hay business partners existentes para inferir la estructura
- La documentaci√≥n disponible es para v7 pero el deployment tiene v6
- Sin ejemplos funcionales, no se puede determinar el endpoint y estructura correctos

**Decisi√≥n:**
En lugar de crear manualmente en BPDM (sin documentaci√≥n de API v6), procederemos a:
1. Crear realm y usuario en Keycloak primero
2. Permitir que el Portal backend sincronice con BPDM cuando corresponda
3. O investigar el c√≥digo fuente de BPDM v6 para conocer los endpoints correctos

**Enfoque alternativo adoptado:**
Crear primero la infraestructura de identidad (Keycloak) y luego manejar BPDM desde el Portal UI si es necesario.

---

### ‚ùå PROBLEMA 7: Error "Cookie not found" al Acceder Directamente a Keycloak

**Momento:** Al intentar login en `http://sharedidp.51.68.114.44.nip.io/auth/realms/CX-Operator-Ikerlan/account`

**Error:**
```
Cookie not found. Please make sure cookies are enabled in your browser.
```

**Diagn√≥stico:**
- El flujo de autenticaci√≥n OAuth2 requiere cookies para mantener el estado de sesi√≥n
- Acceder directamente a Keycloak Account Console sin pasar por el Portal causa problemas de cookies
- El navegador puede estar bloqueando cookies de terceros (especialmente en HTTP sin HTTPS)
- El flujo correcto debe iniciarse desde el Portal, no desde Keycloak directamente

**Soluci√≥n:**
NO acceder directamente a Keycloak. En su lugar:
1. Acceder al Portal: http://portal.51.68.114.44.nip.io
2. Hacer login desde el Portal (flujo OAuth2 completo)
3. El Portal gestionar√° las cookies y redirecciones correctamente

Sin embargo, como el usuario de Ikerlan no est√° asociado correctamente con el Portal (onboarding manual), se necesita crear la asociaci√≥n en la base de datos del Portal.

---

### ‚ùå PROBLEMA 8: "HTTPS required" en Login de Ikerlan

**Momento:** Al intentar login en el Portal y ser redirigido al realm de Ikerlan

**Error:**
```
HTTPS required
```

**Diagn√≥stico:**
- Por defecto, Keycloak configura nuevos realms con `sslRequired: "external"`
- Esto significa que requiere HTTPS para todas las conexiones externas
- El deployment actual est√° en HTTP (no HTTPS) con nip.io
- El realm central (CX-OPERATOR) tiene `sslRequired: "none"` pero el realm de Ikerlan (creado manualmente) ten√≠a la configuraci√≥n por defecto

**Soluci√≥n aplicada:**
```bash
# Regenerar token admin
ADMIN_TOKEN=$(curl -s -X POST "http://sharedidp.51.68.114.44.nip.io/auth/realms/master/protocol/openid-connect/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=password" \
  -d "client_id=admin-cli" \
  -d "username=admin" \
  -d "password=$(kubectl get secret -n portal portal-sharedidp -o jsonpath='{.data.admin-password}' | base64 -d)" | jq -r '.access_token')

# Deshabilitar requisito de SSL
curl -X PUT "http://sharedidp.51.68.114.44.nip.io/auth/admin/realms/CX-Operator-Ikerlan" \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "realm": "CX-Operator-Ikerlan",
    "sslRequired": "none"
  }'
```

**Resultado:** ‚úÖ Requisito de SSL deshabilitado

**Nota:** En producci√≥n, SIEMPRE usar HTTPS con certificados v√°lidos. Esta configuraci√≥n es SOLO para desarrollo/pruebas.

**Acci√≥n tomada:** Pod de Keycloak Shared IDP reiniciado para aplicar cambios

---

### ‚ùå PROBLEMA 9: "Cookie not found" Persiste - Falta Configuraci√≥n en Portal

**Momento:** Despu√©s de reiniciar Keycloak y deshabilitar SSL, sigue error de cookies

**Diagn√≥stico REAL:**
El problema no es solo de cookies o SSL. El problema fundamental es:

1. ‚úÖ Realm de Ikerlan existe en Keycloak
2. ‚úÖ Usuario xmendialdua@ikerlan.es existe en Keycloak  
3. ‚ùå **Portal NO sabe que Ikerlan existe**
4. ‚ùå **Portal NO tiene configurado el flujo OAuth2 para el realm de Ikerlan**
5. ‚ùå **No hay registro en la base de datos del Portal** para la empresa Ikerlan

**El flujo autom√°tico bloqueado por SMTP deber√≠a haber creado:**
- Registro en tabla `portal.companies` (la empresa Ikerlan)
- Registro en tabla `portal.company_applications` (la aplicaci√≥n completada)
- Registro en tabla `portal.iam_identity_providers` (asociaci√≥n del realm con la empresa)
- Registro en tabla `portal.company_users` (asociaci√≥n del usuario con la empresa)
- Configuraci√≥n del cliente OAuth2 en el realm de Ikerlan

**Sin estos registros:**
- El Portal no redirige correctamente al realm de Ikerlan
- El flujo OAuth2 no se configura
- Las cookies de sesi√≥n no se pueden establecer
- El login falla con "Cookie not found"

**Soluci√≥n necesaria:**
Completar la invitaci√≥n desde el Portal UI como CX-Operator, O crear los registros manualmente en la base de datos del Portal.

---

### ‚ùå PROBLEMA 10: Portal UI No Permite Aprobar/Completar Invitaciones

**Momento:** Al intentar completar invitaci√≥n de Ikerlan desde Portal UI como CX-Operator

**S√≠ntomas:**
- Bot√≥n "Details" (flecha ‚Üí) en la lista de invitaciones no responde al clic
- No hay opciones visibles para aprobar/completar/procesar la invitaci√≥n
- En "Partner Network" no aparece ning√∫n partner registrado
- El UI no proporciona forma de completar el proceso de onboarding

**Diagn√≥stico:**
- La funcionalidad de gesti√≥n de invitaciones en el Portal UI est√° incompleta o no funcional
- El flujo autom√°tico (que requiere SMTP) no se complet√≥
- El flujo manual desde UI no est√° disponible/funcional

**Soluci√≥n adoptada:**
Crear manualmente los registros necesarios en la base de datos del Portal (PostgreSQL) para:
1. Registrar la empresa Ikerlan
2. Asociar el realm de Keycloak con la empresa
3. Asociar el usuario con la empresa
4. Completar la aplicaci√≥n de onboarding

---

## üîß CREACI√ìN MANUAL: PASO 3 - Registros en Base de Datos del Portal

---

## üîß CREACI√ìN MANUAL: PASO 1 - Keycloak Realm e Identidad

### Paso 1.1: Crear Realm para Ikerlan en Shared IDP

**Comando ejecutado:**
```bash
# Obtener token de admin
ADMIN_TOKEN=$(curl -s -X POST "http://sharedidp.51.68.114.44.nip.io/auth/realms/master/protocol/openid-connect/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=password" \
  -d "client_id=admin-cli" \
  -d "username=admin" \
  -d "password=$(kubectl get secret -n portal portal-sharedidp -o jsonpath='{.data.admin-password}' | base64 -d)" | jq -r '.access_token')

# Crear realm
curl -X POST "http://sharedidp.51.68.114.44.nip.io/auth/admin/realms" \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "realm": "CX-Operator-Ikerlan",
    "enabled": true,
    "displayName": "Ikerlan Operator Realm",
    "loginTheme": "catenax-shared",
    "attributes": {
      "bpn": "BPNL000000001IKL"
    }
  }'
```

**Resultado:** ‚úÖ Realm creado exitosamente

**Verificaci√≥n:**
```bash
curl -s "http://sharedidp.51.68.114.44.nip.io/auth/realms/CX-Operator-Ikerlan" | jq -r '.realm'
# Output: CX-Operator-Ikerlan
```

---

### Paso 1.2: Crear Usuario Admin para Ikerlan

**Comando ejecutado:**
```bash
curl -X POST "http://sharedidp.51.68.114.44.nip.io/auth/admin/realms/CX-Operator-Ikerlan/users" \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "xmendialdua@ikerlan.es",
    "email": "xmendialdua@ikerlan.es",
    "firstName": "Xabier",
    "lastName": "Mendialdua",
    "enabled": true,
    "emailVerified": true,
    "attributes": {
      "bpn": ["BPNL000000001IKL"],
      "organisation": ["Ikerlan"]
    },
    "credentials": [
      {
        "type": "password",
        "value": "Welcome2Catena-X!",
        "temporary": true
      }
    ]
  }'
```

**Resultado:** ‚úÖ Usuario creado exitosamente

**Credenciales generadas:**
- **Username:** xmendialdua@ikerlan.es
- **Password temporal:** Welcome2Catena-X!
- **Email verified:** true

---

### Paso 1.3: Crear y Asignar Rol Company Admin

**Comandos ejecutados:**
```bash
# Crear rol
curl -X POST "http://sharedidp.51.68.114.44.nip.io/auth/admin/realms/CX-Operator-Ikerlan/roles" \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Company Admin",
    "description": "Administrator role for company Ikerlan"
  }'

# Obtener ID del usuario
USER_ID=$(curl -s -X GET "http://sharedidp.51.68.114.44.nip.io/auth/admin/realms/CX-Operator-Ikerlan/users?username=xmendialdua@ikerlan.es" \
  -H "Authorization: Bearer $ADMIN_TOKEN" | jq -r '.[0].id')

# Asignar rol al usuario
ROLE_DATA=$(curl -s -X GET "http://sharedidp.51.68.114.44.nip.io/auth/admin/realms/CX-Operator-Ikerlan/roles/Company%20Admin" \
  -H "Authorization: Bearer $ADMIN_TOKEN")
  
curl -X POST "http://sharedidp.51.68.114.44.nip.io/auth/admin/realms/CX-Operator-Ikerlan/users/$USER_ID/role-mappings/realm" \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d "[$ROLE_DATA]"
```

**Resultado:** ‚úÖ Rol creado y asignado exitosamente

---

### Paso 1.4: Verificaci√≥n Completa de Recursos Creados

**Verificaci√≥n ejecutada:**
```bash
# 1. Realm
curl -s "http://sharedidp.51.68.114.44.nip.io/auth/realms/CX-Operator-Ikerlan" | jq -r '{realm, enabled}'

# 2. Usuario
curl -s -X GET "http://sharedidp.51.68.114.44.nip.io/auth/admin/realms/CX-Operator-Ikerlan/users?username=xmendialdua@ikerlan.es" \
  -H "Authorization: Bearer $ADMIN_TOKEN" | jq -r '.[0] | {username, email, enabled, emailVerified}'

# 3. Roles del usuario
curl -s -X GET "http://sharedidp.51.68.114.44.nip.io/auth/admin/realms/CX-Operator-Ikerlan/users/$USER_ID/role-mappings/realm" \
  -H "Authorization: Bearer $ADMIN_TOKEN" | jq -r '.[].name'
```

**Resultados:**
```json
// Realm
{
  "realm": "CX-Operator-Ikerlan",
  "enabled": true
}

// Usuario
{
  "username": "xmendialdua@ikerlan.es",
  "email": "xmendialdua@ikerlan.es",
  "enabled": true,
  "emailVerified": true
}

// Roles
default-roles-cx-operator-ikerlan
Company Admin
```

**Estado:** ‚úÖ Todos los recursos de identidad creados correctamente

---

## üîß CREACI√ìN MANUAL: PASO 2 - Test de Autenticaci√≥n

### Paso 2.1: Probar Login con las Credenciales Generadas

**Intento de autenticaci√≥n program√°tica:**
```bash
curl -X POST "http://sharedidp.51.68.114.44.nip.io/auth/realms/CX-Operator-Ikerlan/protocol/openid-connect/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=password" \
  -d "client_id=account" \
  -d "username=xmendialdua@ikerlan.es" \
  -d "password=Welcome2Catena-X!"
```

**Resultado:**
```json
{
  "error": "unauthorized_client",
  "error_description": "Client not allowed for direct access grants"
}
```

**Diagn√≥stico:**
- El cliente "account" no est√° configurado para permitir "Direct Access Grants" (Resource Owner Password Credentials)
- Esto es una medida de seguridad est√°ndar en Keycloak
- El usuario y el realm existen correctamente
- La autenticaci√≥n debe hacerse a trav√©s del **flujo de browser** (Authorization Code Flow)

**Pr√≥ximo paso:** Acceder al Portal desde el navegador

---

## ‚úÖ RESUMEN DE RECURSOS CREADOS MANUALMENTE

### Componentes Completados

| Recurso | Estado | Detalles |
|---------|--------|----------|
| **Realm Keycloak** | ‚úÖ Creado | CX-Operator-Ikerlan en Shared IDP |
| **Usuario Admin** | ‚úÖ Creado | xmendialdua@ikerlan.es |
| **Email Verified** | ‚úÖ S√≠ | true (sin env√≠o de email) |
| **Password** | ‚úÖ Configurado | Welcome2Catena-X! (temporal) |
| **Rol** | ‚úÖ Asignado | Company Admin |
| **Atributos** | ‚úÖ Configurados | BPN: BPNL000000001IKL |

### Componentes Pendientes

| Recurso | Estado | Raz√≥n |
|---------|--------|-------|
| **Business Partner BPDM** | ‚è≥ Pendiente | API v6 no documentada, se crear√° desde Portal UI |
| **Invitaci√≥n en Portal** | ‚úÖ Existe | Status: CREATED (bloqueada por SMTP) |

---

## üéØ SIGUIENTES PASOS PARA COMPLETAR ONBOARDING

### Opci√≥n 1: Acceso desde Portal UI (Recomendado)

1. **Abrir navegador**: http://portal.51.68.114.44.nip.io
2. **Hacer login** seleccionando "Shared IDP"
3. **Ingresar credenciales:**
   - Username: `xmendialdua@ikerlan.es`
   - Password: `Welcome2Catena-X!`
4. **Cambiar password** (es temporal)
5. **Completar perfil** si el Portal lo solicita
6. **Verificar creaci√≥n en BPDM** desde el Portal (deber√≠a sincronizarse autom√°ticamente)

### Opci√≥n 2: Crear Business Partner Manualmente en BPDM (Si es necesario)

Si el Portal no sincroniza autom√°ticamente con BPDM, se deber√°:
1. Investigar documentaci√≥n de BPDM Pool API v6
2. Crear Business Partner con BPN: BPNL000000001IKL
3. Asociar con el usuario en el Portal backend

---

## üìä ESTADO FINAL DEL ONBOARDING DE IKERLAN

**Fecha de finalizaci√≥n:** 27 de Enero de 2026

### Datos de Acceso

```yaml
Empresa:          Ikerlan, S. Coop.
BPN Asignado:     BPNL000000001IKL
Realm Keycloak:   CX-Operator-Ikerlan
URL Realm:        http://sharedidp.51.68.114.44.nip.io/auth/realms/CX-Operator-Ikerlan
Usuario Admin:    xmendialdua@ikerlan.es
Password:         Welcome2Catena-X! (TEMPORAL - cambiar en primer login)
Rol:              Company Admin
Portal URL:       http://portal.51.68.114.44.nip.io
```

### Problemas Resueltos

1. ‚úÖ Secret de cliente BPDM corregido
2. ‚úÖ API version v6 identificada (vs v7 en documentaci√≥n)
3. ‚úÖ Tokens OAuth2 expirados - gesti√≥n de regeneraci√≥n
4. ‚úÖ Flujo autom√°tico bloqueado por SMTP - creaci√≥n manual completada
5. ‚úÖ Realm y usuario creados sin email SMTP

### Lecciones Aprendidas

1. **Tokens expiran r√°pido**: Tokens OAuth2 tienen TTL de ~5 minutos, regenerar frecuentemente
2. **API versions matter**: BPDM deployment v7.1.0 usa API v6, no v7
3. **SMTP es cr√≠tico**: El flujo autom√°tico depende completamente de env√≠o de emails
4. **Documentaci√≥n desactualizada**: Endpoints y versiones en docs no coinciden con deployment
5. **Keycloak Direct Grants**: Los clientes p√∫blicos no permiten password grants por seguridad
6. **Manual workarounds**: Creaci√≥n manual de realm/usuario es viable cuando procesos autom√°ticos fallan

---

### üìã PROCEDIMIENTO MANUAL DE ONBOARDING (Debido a SMTP No Disponible)

A continuaci√≥n se documenta el proceso manual ejecutado para completar el onboarding de Ikerlan.

---

## üîÑ Siguientes Pasos

---

## üìä RESUMEN DE PROBLEMAS ENCONTRADOS Y LECCIONES APRENDIDAS

### Problema 1: Portal UI No Permite Completar Invitaciones
**S√≠ntoma:** Bot√≥n "Details" no responde en la secci√≥n "Invite new partner"  
**Causa:** Sin servidor SMTP, el CronJob portal-processes-worker no puede enviar emails  
**Impacto:** Flujo autom√°tico de onboarding bloqueado  
**Soluci√≥n:** Onboarding manual mediante base de datos y Keycloak API  
**Lecci√≥n:** Para producci√≥n, configurar servidor SMTP (Mailgun, SendGrid, o smtp4dev para dev)

---

### Problema 2: Confusi√≥n con Nombres de Realms
**S√≠ntoma:** Intentamos crear realm "CX-Operator-Ikerlan" pero Portal usaba "idp1"  
**Causa:** No entend√≠amos la arquitectura: Portal usa identificadores t√©cnicos (idp1, idp2, idp3)  
**Soluci√≥n:** Usar realm "idp1" con displayName "Ikerlan"  
**Lecci√≥n:** Los realms usan IDs t√©cnicos estables (idp1, idp2...) mientras que displayName muestra el nombre de la empresa

---

### Problema 3: Error "HTTPS required" en Login
**S√≠ntoma:** Keycloak rechazaba conexiones HTTP  
**Causa:** Realm con `sslRequired: "external"` por defecto  
**Soluci√≥n:** Cambiar a `sslRequired: "none"`  
**Lecci√≥n:** Verificar siempre configuraci√≥n SSL en realms nuevos para despliegues HTTP

---

### Problema 4: Falta Cliente OAuth2 en Realm
**S√≠ntoma:** Error "HTTPS required" persist√≠a despu√©s de deshabilitar SSL  
**Causa:** Realm sin cliente OAuth2 configurado para el Portal  
**Soluci√≥n:** Crear cliente "Cl2-CX-Portal" con redirectUris correctas  
**Lecci√≥n:** Cada realm necesita su propio cliente OAuth2 para el Portal

---

### Problema 5: Variable REQUIRE_HTTPS_URL_PATTERN en true
**S√≠ntoma:** Portal frontend forzaba HTTPS incluso con configuraci√≥n correcta en Keycloak  
**Causa:** Variable de entorno del deployment en "true"  
**Soluci√≥n:** `kubectl set env deployment/portal-portal -n portal REQUIRE_HTTPS_URL_PATTERN=false`  
**Lecci√≥n:** Verificar variables de entorno del frontend adem√°s de configuraci√≥n de backend

---

### Problema 6: UUID de Usuario Incorrecto en Base de Datos
**S√≠ntoma:** Portal redirig√≠a a realm incorrecto  
**Causa:** user_entity_id en portal.identities apuntaba a usuario de realm equivocado  
**Soluci√≥n:** Actualizar con UUID correcto del usuario en realm idp1  
**Lecci√≥n:** El user_entity_id debe coincidir exactamente con el UUID en Keycloak

---

### Problema 7: Contrase√±a No Configurada en Usuario Existente
**S√≠ntoma:** "Invalid username or password" tras corregir todos los dem√°s problemas  
**Causa:** Usuario exist√≠a pero sin contrase√±a configurada  
**Soluci√≥n:** Usar endpoint reset-password de Keycloak API  
**Lecci√≥n:** Verificar siempre que usuario tiene credenciales v√°lidas, no solo que existe

---

### Problema 8: Cach√© de Servicios del Portal
**S√≠ntoma:** Cambios en base de datos no se reflejaban inmediatamente  
**Causa:** Servicios backend cachean configuraci√≥n de identidad  
**Soluci√≥n:** Reiniciar pods con `kubectl delete pod -l app.kubernetes.io/name=portal`  
**Lecci√≥n:** Tras cambios en base de datos o Keycloak, reiniciar servicios del Portal

---

### Arquitectura Correcta de Realms Entendida

```
Shared IDP (Keycloak)
‚îú‚îÄ‚îÄ master (realm admin)
‚îú‚îÄ‚îÄ CX-Operator (realm del operador del Portal)
‚îî‚îÄ‚îÄ Business Partner Realms:
    ‚îú‚îÄ‚îÄ idp1 (displayName: "Ikerlan")
    ‚îú‚îÄ‚îÄ idp2 (displayName: "Assembly")     ‚Üê Para siguiente onboarding
    ‚îú‚îÄ‚îÄ idp3 (displayName: "Fagor")        ‚Üê Para siguiente onboarding
    ‚îî‚îÄ‚îÄ idp4, idp5, ... (futuros partners)
```

**Ventajas:**
- URLs estables: `http://sharedidp.../auth/realms/idp1/...`
- IDs t√©cnicos predecibles
- Nombres descriptivos en UI de Keycloak
- F√°cil escalabilidad

---

## üéØ PR√ìXIMOS PASOS

### Para Ikerlan (Usuario Final)

1. **Cambiar password temporal** al iniciar sesi√≥n
2. **Completar perfil de empresa** con informaci√≥n adicional
3. **Crear usuarios adicionales** para el equipo
4. **Explorar aplicaciones** disponibles en el marketplace
5. **Configurar casos de uso** relevantes para su industria

### Para el Operador (Nosotros)

1. ‚è≥ **Onboarding de Assembly** (programado 28-Ene-2026)
   - Usar procedimiento optimizado de este documento
   - Realm: idp2, displayName: "Assembly"
   - BPN: BPNL000000002ASM

2. ‚è≥ **Onboarding de Fagor** (siguiente)
   - Realm: idp3, displayName: "Fagor"
   - BPN: BPNL000000003FGR

3. **Configurar servidor SMTP** para automatizar onboarding futuro
   - Opci√≥n 1: Mailgun (producci√≥n)
   - Opci√≥n 2: SendGrid (producci√≥n)
   - Opci√≥n 3: smtp4dev (desarrollo)

4. **Monitorear uso** de BPDM y Portal
5. **Verificar logs** regularmente para detectar problemas
6. **Documentar lecciones aprendidas** de cada onboarding

---

## üõ†Ô∏è Troubleshooting Com√∫n

### Problema: No se puede crear Business Partner en BPDM

**Error t√≠pico:**
```json
{
  "error": "Unauthorized",
  "status": 401
}
```

**Soluci√≥n:**
1. Verificar que el token OAuth2 es v√°lido: `echo $TOKEN`
2. Verificar que el cliente tiene permisos en Keycloak
3. Regenerar token si ha expirado (tokens expiran en 5-10 minutos)

---

### Problema: Usuario no puede hacer login

**S√≠ntomas:**
- Error "Invalid username or password"
- Redirecci√≥n infinita
- Error "Cookie not found"

**Soluci√≥n:**
1. Verificar que el usuario existe en el realm correcto
2. Verificar que el realm est√° habilitado: `enabled: true`
3. Verificar que `emailVerified: true`
4. Verificar que `sslRequired: "none"` para HTTP
5. Verificar que existe cliente OAuth2 en el realm
6. Verificar contrase√±a configurada
7. Comprobar logs de Keycloak:
   ```bash
   kubectl logs -n portal portal-sharedidp-0 --tail=100 | grep -i "error"
   ```
8. Reiniciar servicios del Portal

---

### Problema: Portal no muestra datos de la empresa

**S√≠ntomas:**
- Dashboard vac√≠o
- No aparece el BPN

**Soluci√≥n:**
1. Verificar que el BPN est√° en `portal.companies`:
   ```bash
   kubectl exec -n portal portal-portal-backend-postgresql-0 -- \
     env PGPASSWORD=$PGPASSWORD \
     psql -U portal -d postgres -c \
     "SELECT id, name, business_partner_number FROM portal.companies WHERE name = 'Empresa';"
   ```
2. Verificar conectividad Portal ‚Üí BPDM:
   ```bash
   kubectl exec -n portal deployment/portal-administration-service -- \
     wget -O- --timeout=5 http://portal-bpdm-pool:80/pool/actuator/health
   ```

---

## üìû Contactos y Recursos

### Documentaci√≥n Oficial
- [Tractus-X BPDM Documentation](https://eclipse-tractusx.github.io/docs/tutorials/)
- [Catena-X Portal User Guide](https://eclipse-tractusx.github.io/docs/portal/)
- [Keycloak Admin Guide](https://www.keycloak.org/docs/latest/server_admin/)

### Archivos Relacionados
- `onboarding/Ikerlan.txt` - Datos completos de Ikerlan
- `2026.01.27 - Solucion Completa Despliegue BPDM - Problemas y Resoluciones.md`
- `2026.01.27 - Secuencia Comandos Correccion ConfigMaps BPDM.md`
- `fix-bpdm-ingress.sh` - Script de correcci√≥n de Ingress
- `values-ovh-hosts-portal.yaml` - Configuraci√≥n Helm actualizada

---

**Documento creado:** 27 de Enero de 2026  
**√öltima actualizaci√≥n:** 27 de Enero de 2026 - 21:30  
**Autor:** xmendialdua  
**Estado:** ‚úÖ COMPLETADO - Ikerlan onboarding exitoso  
**Siguiente acci√≥n:** Replicar procedimiento optimizado con Assembly (28-Ene-2026)
- `values-adopter-portal-for-onboarding.yaml`

---

## ‚ö†Ô∏è PROBLEMA 11: Portal UI No Funcional - Invitaciones No Completables

### Descripci√≥n del Problema
La interfaz de usuario del Portal no permite gestionar las invitaciones:
- El bot√≥n "Details" en "Invite new partner" no responde
- En "Partner Network" no aparece ning√∫n partner registrado
- No hay forma de aprobar o completar invitaciones pendientes
- La soluci√≥n propuesta en FASE 2 (desde UI) no es funcional

**Impacto:** No se puede completar el proceso de onboarding mediante la interfaz de usuario.

### Causa Ra√≠z
El Portal crea los registros iniciales en la base de datos cuando se ejecuta "Invite Business Partner", pero:
1. Sin SMTP, no puede enviar email de verificaci√≥n
2. El CronJob `portal-processes-worker` intenta procesar la invitaci√≥n pero falla
3. La invitaci√≥n queda en estado "CREATED" (status_id: 1)
4. El Portal UI no tiene funcionalidad para gestionar invitaciones incompletas

### Soluci√≥n: Actualizaci√≥n Manual de Base de Datos

**Paso 11.1: Verificar registros existentes**

```bash
# Conectar a PostgreSQL
PGPASSWORD=$(kubectl get secret -n portal portal-postgres -o jsonpath='{.data.portal-password}' | base64 -d)

# Buscar la empresa Ikerlan
kubectl exec -n portal portal-portal-backend-postgresql-0 -- \
  env PGPASSWORD=$PGPASSWORD \
  psql -U portal -d postgres -c \
  "SELECT id, name, business_partner_number, company_status_id FROM portal.companies WHERE name = 'Ikerlan';"

# Resultado esperado:
#   id: 30bdf87c-7813-406a-827f-a8977f154980
#   name: Ikerlan
#   business_partner_number: NULL (o BPNL000000001IKL si ya est√° actualizado)
#   company_status_id: 1 (CREATED)
```

**Paso 11.2: Actualizar BPN en la empresa**

```bash
kubectl exec -n portal portal-portal-backend-postgresql-0 -- \
  env PGPASSWORD=$PGPASSWORD \
  psql -U portal -d postgres -c \
  "UPDATE portal.companies 
   SET business_partner_number = 'BPNL000000001IKL' 
   WHERE name = 'Ikerlan';"
```

**Paso 11.3: Actualizar Identity Provider**

```bash
# Verificar identity provider existente
kubectl exec -n portal portal-portal-backend-postgresql-0 -- \
  env PGPASSWORD=$PGPASSWORD \
  psql -U portal -d postgres -c \
  "SELECT iip.iam_idp_alias, iip.identity_provider_id, ip.owner_id 
   FROM portal.iam_identity_providers iip 
   JOIN portal.identity_providers ip ON iip.identity_provider_id = ip.id 
   WHERE ip.owner_id = '30bdf87c-7813-406a-827f-a8977f154980';"

# Resultado: iam_idp_alias = 'idp1' (gen√©rico)

# Actualizar con el realm correcto
kubectl exec -n portal portal-portal-backend-postgresql-0 -- \
  env PGPASSWORD=$PGPASSWORD \
  psql -U portal -d postgres -c \
  "UPDATE portal.iam_identity_providers 
   SET iam_idp_alias = 'CX-Operator-Ikerlan', 
       metadata_url = 'http://sharedidp.51.68.114.44.nip.io/auth/realms/CX-Operator-Ikerlan' 
   WHERE identity_provider_id = 'bdb53418-1afc-4447-a290-a630107e0695';"
```

**Paso 11.4: Actualizar Usuario con UUID de Keycloak**

```bash
# Verificar usuario existente
kubectl exec -n portal portal-portal-backend-postgresql-0 -- \
  env PGPASSWORD=$PGPASSWORD \
  psql -U portal -d postgres -c \
  "SELECT id, company_id, user_status_id, user_entity_id, identity_type_id 
   FROM portal.identities 
   WHERE company_id = '30bdf87c-7813-406a-827f-a8977f154980';"

# Resultado: user_entity_id = NULL

# Actualizar con UUID del usuario de Keycloak
kubectl exec -n portal portal-portal-backend-postgresql-0 -- \
  env PGPASSWORD=$PGPASSWORD \
  psql -U portal -d postgres -c \
  "UPDATE portal.identities 
   SET user_entity_id = 'd094e794-38ea-4886-b42b-c7c2b4168a7c' 
   WHERE id = '6ce4fdb0-7264-41b1-aeb6-4b224ebb7b1f';"
```

**Notas Importantes:**
- El UUID `d094e794-38ea-4886-b42b-c7c2b4168a7c` es del usuario en Keycloak (xmendialdua@ikerlan.es)
- El UUID `6ce4fdb0-7264-41b1-aeb6-4b224ebb7b1f` es de portal.identities
- El UUID `30bdf87c-7813-406a-827f-a8977f154980` es de la empresa en portal.companies

**Paso 11.5: Verificar Rol Company Admin**

```bash
# Verificar que el usuario tiene el rol asignado
kubectl exec -n portal portal-portal-backend-postgresql-0 -- \
  env PGPASSWORD=$PGPASSWORD \
  psql -U portal -d postgres -c \
  "SELECT iar.identity_id, iar.user_role_id, ur.user_role 
   FROM portal.identity_assigned_roles iar
   JOIN portal.user_roles ur ON iar.user_role_id = ur.id
   WHERE identity_id = '6ce4fdb0-7264-41b1-aeb6-4b224ebb7b1f';"

# Resultado esperado: Company Admin
```

**Paso 11.6: Reiniciar Pods del Portal**

```bash
# Reiniciar servicios para recargar configuraci√≥n de base de datos
kubectl delete pod -n portal \
  portal-portal-687ff79594-v2l7g \
  portal-administration-service-677cfc64c8-8lxj8 \
  portal-registration-service-bb58d565c-nj8vk

# Esperar a que se reinicien
kubectl get pods -n portal -w
```

**Paso 11.7: Verificar Login**

```bash
# URL del Portal
echo "Portal URL: http://portal.51.68.114.44.nip.io"

# Credenciales:
# Email: xmendialdua@ikerlan.es
# Password: Welcome2Catena-X!
```

**Resultado Esperado:**
- ‚úÖ Login exitoso en Portal
- ‚úÖ Redirecci√≥n a Keycloak realm CX-Operator-Ikerlan
- ‚úÖ Dashboard de Ikerlan visible
- ‚úÖ BPN BPNL000000001IKL visible en perfil
- ‚úÖ Permisos de Company Admin activos

---

## ‚ö†Ô∏è PROBLEMA 12: Error "HTTPS required" al Intentar Login

### Descripci√≥n del Problema
Al intentar acceder al Portal en `http://portal.51.68.114.44.nip.io` e intentar hacer login con las credenciales de Ikerlan, antes de que aparezca la ventana de login de Keycloak, se produce el error: **"HTTPS required"**

**Contexto:**
- El realm CX-Operator-Ikerlan tiene `sslRequired: "none"` correctamente configurado
- El usuario y roles est√°n creados en Keycloak
- La base de datos del Portal est√° correctamente actualizada

### Causa Ra√≠z
El realm CX-Operator-Ikerlan no tiene un cliente OAuth2 configurado para el Portal. Sin un cliente, Keycloak no puede procesar las peticiones de autenticaci√≥n del Portal y rechaza la conexi√≥n HTTP.

**¬øPor qu√© es necesario un cliente?**
- En OAuth2/OpenID Connect, el Portal es un "cliente" que solicita autenticaci√≥n
- Cada aplicaci√≥n que quiere usar un realm debe tener su cliente registrado
- El cliente define las URLs permitidas para redirecci√≥n y los flujos de autenticaci√≥n

### Soluci√≥n: Crear Cliente OAuth2 para el Portal

**Paso 12.1: Obtener token de administrador**

```bash
ADMIN_PASS=$(kubectl get secret -n portal portal-sharedidp -o jsonpath='{.data.admin-password}' | base64 -d)

ADMIN_TOKEN=$(curl -s -X POST "http://sharedidp.51.68.114.44.nip.io/auth/realms/master/protocol/openid-connect/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=password" \
  -d "client_id=admin-cli" \
  -d "username=admin" \
  -d "password=$ADMIN_PASS" | jq -r '.access_token')
```

**Paso 12.2: Crear cliente Cl2-CX-Portal**

```bash
curl -s -X POST "http://sharedidp.51.68.114.44.nip.io/auth/admin/realms/CX-Operator-Ikerlan/clients" \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "clientId": "Cl2-CX-Portal",
    "name": "Catena-X Portal Client for Ikerlan",
    "enabled": true,
    "publicClient": true,
    "standardFlowEnabled": true,
    "implicitFlowEnabled": false,
    "directAccessGrantsEnabled": true,
    "serviceAccountsEnabled": false,
    "protocol": "openid-connect",
    "redirectUris": [
      "http://portal.51.68.114.44.nip.io/*",
      "http://portal.51.68.114.44.nip.io/home",
      "http://portal.51.68.114.44.nip.io/auth/*"
    ],
    "webOrigins": [
      "http://portal.51.68.114.44.nip.io"
    ],
    "attributes": {
      "post.logout.redirect.uris": "http://portal.51.68.114.44.nip.io/*"
    }
  }'
```

**Paso 12.3: Verificar creaci√≥n del cliente**

```bash
curl -s -X GET "http://sharedidp.51.68.114.44.nip.io/auth/admin/realms/CX-Operator-Ikerlan/clients" \
  -H "Authorization: Bearer $ADMIN_TOKEN" | \
  jq '.[] | select(.clientId == "Cl2-CX-Portal") | {clientId, enabled, publicClient, redirectUris}'
```

**Resultado Esperado:**
```json
{
  "clientId": "Cl2-CX-Portal",
  "enabled": true,
  "publicClient": true,
  "redirectUris": [
    "http://portal.51.68.114.44.nip.io/*",
    "http://portal.51.68.114.44.nip.io/home",
    "http://portal.51.68.114.44.nip.io/auth/*"
  ]
}
```

**Configuraci√≥n del Cliente:**
- **clientId:** `Cl2-CX-Portal` - Identificador √∫nico del cliente
- **publicClient:** `true` - No requiere client secret (aplicaci√≥n frontend)
- **standardFlowEnabled:** `true` - Permite el flujo Authorization Code (est√°ndar OAuth2)
- **directAccessGrantsEnabled:** `true` - Permite login directo con usuario/password
- **redirectUris:** URLs permitidas para redirecci√≥n despu√©s de login exitoso
- **webOrigins:** Or√≠genes permitidos para CORS

### Estado Actual
‚úÖ Cliente OAuth2 creado exitosamente  
‚úÖ Realm configurado con sslRequired: "none"  
‚úÖ Usuario y roles configurados  
‚úÖ Base de datos actualizada  

**Pr√≥ximo paso:** Reintentar login en http://portal.51.68.114.44.nip.io

---

**Documento creado:** 27 de Enero de 2026  
**√öltima actualizaci√≥n:** 27 de Enero de 2026 - 20:15  
**Autor:** xmendialdua  
**Estado:** üîÑ En Progreso - Cliente OAuth2 Creado  
**Siguiente acci√≥n:** Probar login en Portal
