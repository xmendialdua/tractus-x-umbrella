# Onboarding de Business Partners en Catena-X Portal
**Fecha:** 27 de Enero de 2026  
**Cluster:** OVH Kubernetes (portal namespace)  
**Empresa a onboardear:** Ikerlan (Primer Business Partner)

---

## üìã Resumen Ejecutivo

Este documento describe el proceso completo de onboarding de **Ikerlan** como Business Partner en la red Catena-X, utilizando el Portal desplegado en OVH y los componentes BPDM (Business Partner Data Management).

**Empresas a onboardear:**
1. ‚úÖ **Ikerlan** (este documento)
2. ‚è≥ Assembly (siguiente)
3. ‚è≥ Fagor (siguiente)

---

## üõ†Ô∏è Pasos Previos Completados

### 1. Correcci√≥n de ConfigMaps BPDM (URLs tx.test ‚Üí LoadBalancer IP)

**Problema inicial:** ConfigMaps con URLs de test (`centralidp.tx.test`, `business-partners.tx.test`)

**Soluci√≥n aplicada:** Patch manual con `kubectl + jq`

```bash
# Corregir auth-server-url en los 4 ConfigMaps
kubectl get configmap portal-bpdm-orchestrator -n portal -o json \
  | jq '.data."deployment.yml" |= gsub("centralidp.tx.test"; "centralidp.51.68.114.44.nip.io")' \
  | kubectl apply -f -

kubectl get configmap portal-bpdm-gate -n portal -o json \
  | jq '.data."deployment.yml" |= gsub("centralidp.tx.test"; "centralidp.51.68.114.44.nip.io")' \
  | kubectl apply -f -

kubectl get configmap portal-bpdm-pool -n portal -o json \
  | jq '.data."deployment.yml" |= gsub("centralidp.tx.test"; "centralidp.51.68.114.44.nip.io")' \
  | kubectl apply -f -

kubectl get configmap portal-bpdm-cleaning-service-dummy -n portal -o json \
  | jq '.data."deployment.yml" |= gsub("centralidp.tx.test"; "centralidp.51.68.114.44.nip.io")' \
  | kubectl apply -f -
```

**Resultado:** ‚úÖ ConfigMaps con URLs correctas

---

### 2. Correcci√≥n de URLs Inter-Servicios (Externas ‚Üí Internas)

**Problema:** Pods BPDM intentaban comunicarse usando URLs externas del LoadBalancer en lugar de servicios internos del cluster.

**Soluci√≥n aplicada:** Cambiar a URLs internas de Kubernetes

```bash
# Pool: usar URL interna de Orchestrator
kubectl get configmap portal-bpdm-pool -n portal -o json \
  | jq '.data."deployment.yml" |= gsub("http://business-partners.51.68.114.44.nip.io/orchestrator"; "http://portal-bpdm-orchestrator:80")' \
  | kubectl apply -f -

# Gate: usar URLs internas de Pool y Orchestrator
kubectl get configmap portal-bpdm-gate -n portal -o json \
  | jq '.data."deployment.yml" |= gsub("http://business-partners.51.68.114.44.nip.io/orchestrator"; "http://portal-bpdm-orchestrator:80") | .data."deployment.yml" |= gsub("http://business-partners.51.68.114.44.nip.io/pool"; "http://portal-bpdm-pool:80")' \
  | kubectl apply -f -

# Cleaning Service: usar URL interna de Orchestrator
kubectl get configmap portal-bpdm-cleaning-service-dummy -n portal -o json \
  | jq '.data."deployment.yml" |= gsub("http://business-partners.51.68.114.44.nip.io/orchestrator"; "http://portal-bpdm-orchestrator:80")' \
  | kubectl apply -f -
```

**Resultado:** ‚úÖ Comunicaci√≥n interna optimizada

---

### 3. Reinicio de Pods BPDM

**Raz√≥n:** Cargar los ConfigMaps actualizados

```bash
kubectl delete pod -n portal -l app.kubernetes.io/name=bpdm-pool
kubectl delete pod -n portal -l app.kubernetes.io/name=bpdm-gate
kubectl delete pod -n portal -l app.kubernetes.io/name=bpdm-orchestrator
kubectl delete pod -n portal -l app.kubernetes.io/name=bpdm-cleaning-service-dummy
```

**Resultado:** ‚úÖ Todos los pods BPDM en estado Running

---

### 4. Correcci√≥n de Ingress BPDM

**Problema:** Ingress con `<none>` en CLASS y `business-partners.tx.test` en HOST

**Soluci√≥n aplicada:** Patch manual de los 3 Ingress

```bash
# Pool
kubectl patch ingress portal-bpdm-pool -n portal --type=json -p='[
  {"op": "add", "path": "/spec/ingressClassName", "value": "nginx"},
  {"op": "replace", "path": "/spec/rules/0/host", "value": "business-partners.51.68.114.44.nip.io"}
]'

# Gate
kubectl patch ingress portal-bpdm-gate -n portal --type=json -p='[
  {"op": "add", "path": "/spec/ingressClassName", "value": "nginx"},
  {"op": "replace", "path": "/spec/rules/0/host", "value": "business-partners.51.68.114.44.nip.io"}
]'

# Orchestrator
kubectl patch ingress portal-bpdm-orchestrator -n portal --type=json -p='[
  {"op": "add", "path": "/spec/ingressClassName", "value": "nginx"},
  {"op": "replace", "path": "/spec/rules/0/host", "value": "business-partners.51.68.114.44.nip.io"}
]'
```

**Resultado:** ‚úÖ Ingress accesibles externamente

**Script automatizado:** `fix-bpdm-ingress.sh`

Scripts para ejecuci√≥n interactiva en fichero txt: `fix-bpdm-ingress.txt`

---

### 5. Actualizaci√≥n de Ficheros de Configuraci√≥n

**Ficheros modificados:**
- ‚úÖ `values-ovh-hosts-portal.yaml` - A√±adida configuraci√≥n de Ingress BPDM
- ‚úÖ `values-ovh-hosts-portal-template.yaml` - Template actualizado para futuros despliegues

**Contenido a√±adido:**
```yaml
# BPDM Configuration
bpdm-gate:
  ingress:
    enabled: true
    className: "nginx"
    hosts:
      - host: "business-partners.51.68.114.44.nip.io"
        paths:
          - path: /gate
            pathType: Prefix
  applicationConfig:
    bpdm:
      security:
        authServerUrl: "http://centralidp.51.68.114.44.nip.io/auth"
      pool:
        baseUrl: "http://portal-bpdm-pool:80"
      orchestrator:
        baseUrl: "http://portal-bpdm-orchestrator:80"

bpdm-pool:
  ingress:
    enabled: true
    className: "nginx"
    hosts:
      - host: "business-partners.51.68.114.44.nip.io"
        paths:
          - path: /pool
            pathType: Prefix
  applicationConfig:
    bpdm:
      security:
        authServerUrl: "http://centralidp.51.68.114.44.nip.io/auth"
      orchestrator:
        baseUrl: "http://portal-bpdm-orchestrator:80"

bpdm-orchestrator:
  ingress:
    enabled: true
    className: "nginx"
    hosts:
      - host: "business-partners.51.68.114.44.nip.io"
        paths:
          - path: /orchestrator
            pathType: Prefix
```

---

## ‚úÖ Estado Actual: Componentes Operativos

### üåê Interfaces Web

| Componente | Estado | URL | Descripci√≥n |
|------------|--------|-----|-------------|
| **üè† Portal Frontend** | ‚úÖ Running | http://portal.51.68.114.44.nip.io | Interfaz principal de usuario |
| **‚öôÔ∏è Portal Backend** | ‚úÖ Running | http://portal-backend.51.68.114.44.nip.io | API REST del Portal |
| **üîê Keycloak Central IDP** | ‚úÖ Running | http://centralidp.51.68.114.44.nip.io | Gesti√≥n de identidades central |
| **üîë Keycloak Shared IDP** | ‚úÖ Running | http://sharedidp.51.68.114.44.nip.io | Identidades compartidas |
| **üóÑÔ∏è PgAdmin4** | ‚úÖ Running | http://pgadmin4.51.68.114.44.nip.io | Administraci√≥n de bases de datos |

### üè¢ Servicios BPDM (Business Partner Data Management)

| Componente | Estado | URL | Health Check | Descripci√≥n |
|------------|--------|-----|--------------|-------------|
| **üö™ BPDM Gate** | ‚úÖ Running | http://business-partners.51.68.114.44.nip.io/gate | ‚úÖ 200 OK | API p√∫blica para Business Partners |
| **üèä BPDM Pool** | ‚úÖ Running | http://business-partners.51.68.114.44.nip.io/pool | ‚úÖ 200 OK | Pool central de datos maestros |
| **üéº BPDM Orchestrator** | ‚úÖ Running | http://business-partners.51.68.114.44.nip.io/orchestrator | ‚úÖ 200 OK | Orquestaci√≥n de flujos BPDM |
| **üßπ BPDM Cleaning Service** | ‚úÖ Running | (interno) | N/A | Servicio de limpieza de datos |

### üíæ Bases de Datos

| Base de Datos | Pod | Estado | Descripci√≥n |
|---------------|-----|--------|-------------|
| **üìä Portal PostgreSQL** | portal-portal-backend-postgresql-0 | ‚úÖ Running | Datos del Portal |
| **üîê Central IDP PostgreSQL** | portal-centralidp-postgresql-0 | ‚úÖ Running | Datos de Keycloak Central |
| **üîë Shared IDP PostgreSQL** | portal-sharedidp-postgresql-0 | ‚úÖ Running | Datos de Keycloak Shared |
| **üè¢ BPDM PostgreSQL** | bpdm-postgres-0 | ‚úÖ Running | Datos de Business Partners |

### üì¶ Pods Totales por Tipo

```
‚úÖ 5 BPDM pods (orchestrator, pool, gate, cleaning-service, postgres)
‚úÖ 3 Keycloak pods (centralidp, sharedidp con PostgreSQL)
‚úÖ 6 Portal backend services (administration, registration, notification, provisioning, marketplace, services)
‚úÖ 3 Portal frontend (portal, assets, registration)
‚úÖ 1 PgAdmin4
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìä Total: ~50 pods operativos
```

### üîå Ingress Configurados

```bash
$ kubectl get ingress -n portal | grep -E "(NAME|portal|centralidp|sharedidp|business-partners)"

NAME                       CLASS    HOSTS                                ADDRESS        PORTS
portal-bpdm-gate           nginx    business-partners.51.68.114.44.nip.io   51.68.114.44   80
portal-bpdm-orchestrator   nginx    business-partners.51.68.114.44.nip.io   51.68.114.44   80
portal-bpdm-pool           nginx    business-partners.51.68.114.44.nip.io   51.68.114.44   80
portal-centralidp          nginx    centralidp.51.68.114.44.nip.io          51.68.114.44   80
portal-frontend            nginx    portal.51.68.114.44.nip.io              51.68.114.44   80
portal-pgadmin4            nginx    pgadmin4.51.68.114.44.nip.io            51.68.114.44   80
portal-portal-backend      nginx    portal-backend.51.68.114.44.nip.io      51.68.114.44   80
portal-sharedidp           nginx    sharedidp.51.68.114.44.nip.io           51.68.114.44   80
```

---

## üéØ Proceso de Onboarding: Ikerlan

### Informaci√≥n del Business Partner

**Empresa:** Ikerlan  
**Pa√≠s:** Espa√±a  
**Tipo:** Centro de Investigaci√≥n y Desarrollo Tecnol√≥gico  
**Sector:** Automoci√≥n, Electr√≥nica, Energ√≠a  
**Ciudad:** Mondrag√≥n, Guip√∫zcoa

### Datos Necesarios para el Onboarding

Antes de comenzar, necesitamos recopilar la siguiente informaci√≥n de Ikerlan:

- [ ] **Nombre legal de la empresa:** "Ikerlan S.Coop."
- [ ] **Direcci√≥n completa:**
  - Calle/Avenida
  - C√≥digo postal
  - Ciudad
  - Pa√≠s
- [ ] **Identificadores fiscales:**
  - CIF/NIF (Espa√±a)
  - N√∫mero de registro mercantil
- [ ] **Contacto principal:**
  - Nombre y apellidos
  - Email corporativo
  - Tel√©fono
  - Cargo en la empresa
- [ ] **Informaci√≥n adicional:**
  - Sitio web
  - Descripci√≥n de actividad
  - BPN (Business Partner Number) - si ya tiene uno

---

## üìù FASE 1: Acceso al Portal

### Paso 1.1: Verificar Acceso al Portal

**Comando:**
```bash
curl -s -o /dev/null -w "%{http_code}" http://portal.51.68.114.44.nip.io
```

**Resultado esperado:** `200`

**¬øQu√© estamos haciendo?**
- Verificamos que el Portal est√° accesible p√∫blicamente
- Confirmamos que el frontend responde correctamente

---

### Paso 1.2: Acceder al Portal v√≠a Navegador

**URL:** http://portal.51.68.114.44.nip.io

**¬øQu√© veremos?**
- Pantalla de bienvenida del Portal Catena-X
- Bot√≥n "Register Company" o "Login"
- Idioma: Ingl√©s/Alem√°n (por defecto)

**Acci√≥n:**
1. Abrir navegador
2. Navegar a la URL del Portal
3. Verificar que la p√°gina carga correctamente

---

## üìã FASE 2: Registro Inicial de la Empresa

### Paso 2.1: Iniciar Proceso de Registro

**En el Portal:**
1. Clic en **"Register Company"** o **"Company Registration"**
2. Aceptar t√©rminos y condiciones

**¬øQu√© estamos haciendo?**
- Iniciando el proceso de self-registration en el Portal
- Este es el flujo est√°ndar de onboarding en Catena-X

---

### Paso 2.2: Completar Formulario de Datos B√°sicos

**Datos a ingresar:**

#### Informaci√≥n de la Empresa
```
Legal Name:       Ikerlan S.Coop.
Short Name:       Ikerlan
Street:           [Direcci√≥n completa]
Postal Code:      [C√≥digo postal]
City:             Mondrag√≥n
Country:          Spain
Tax ID:           [CIF de Ikerlan]
Commercial Reg:   [N√∫mero de registro mercantil]
Website:          https://www.ikerlan.es
```

#### Contacto Principal
```
First Name:       [Nombre]
Last Name:        [Apellidos]
Email:            [email@ikerlan.es]
Phone:            [+34 XXX XXX XXX]
Position:         [Cargo]
```

**¬øQu√© hace el sistema?**
- Valida los datos ingresados
- Verifica que el email sea corporativo (@ikerlan.es)
- Comprueba si la empresa ya existe en BPDM

---

### Paso 2.3: Verificaci√≥n de Identidad

**Proceso autom√°tico:**
1. El Portal env√≠a un **email de verificaci√≥n** a la direcci√≥n proporcionada
2. El contacto debe hacer clic en el link del email
3. Esto confirma que el email es v√°lido y accesible

**Verificar env√≠o de email:**
```bash
kubectl logs -n portal -l app.kubernetes.io/name=notification-service --tail=50 | grep -i "ikerlan"
```

**¬øQu√© estamos haciendo?**
- Verificamos que el servicio de notificaciones proces√≥ el env√≠o de email
- Confirmamos que no hay errores en el proceso

**NOTA:** Si no hay servidor SMTP configurado (smtp4dev deshabilitado), este paso puede fallar. En entornos de desarrollo, podemos saltar la verificaci√≥n de email manualmente.

---

## üè¢ FASE 3: Creaci√≥n del Business Partner en BPDM

Una vez verificado el email, el Portal debe crear autom√°ticamente un registro en BPDM Pool.

### Paso 3.1: Verificar Creaci√≥n Autom√°tica en BPDM Pool

**Comando:**
```bash
# Obtener token de autenticaci√≥n de Keycloak
TOKEN=$(curl -s -X POST "http://centralidp.51.68.114.44.nip.io/auth/realms/CX-Central/protocol/openid-connect/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=client_credentials" \
  -d "client_id=Cl7-CX-BPDM" \
  -d "client_secret=SECRETO_DEL_CLIENTE" | jq -r '.access_token')

# Buscar Business Partner por nombre
curl -X GET "http://business-partners.51.68.114.44.nip.io/pool/v7/business-partners?legalName=Ikerlan" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" | jq
```

**¬øQu√© estamos haciendo?**
- Obtenemos un token OAuth2 de Keycloak usando el cliente t√©cnico de BPDM
- Buscamos en BPDM Pool si ya existe un Business Partner con el nombre "Ikerlan"
- Si el registro autom√°tico funcion√≥, deber√≠amos ver el registro creado

**Resultado esperado (si existe):**
```json
{
  "totalElements": 1,
  "content": [
    {
      "bpn": "BPNL000000000XXX",
      "legalName": "Ikerlan S.Coop.",
      "legalForm": "S.COOP",
      "status": "ACTIVE",
      "addresses": [...]
    }
  ]
}
```

---

### Paso 3.2: Creaci√≥n Manual (si no existe)

Si el registro autom√°tico fall√≥ o no est√° implementado, creamos el Business Partner manualmente:

**Comando:**
```bash
# Crear Business Partner en BPDM Pool
curl -X POST "http://business-partners.51.68.114.44.nip.io/pool/v7/business-partners" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "legalName": "Ikerlan S.Coop.",
    "shortName": "Ikerlan",
    "legalForm": "S.COOP",
    "status": "ACTIVE",
    "classifications": [
      {
        "value": "RESEARCH_DEVELOPMENT",
        "code": "NACE",
        "type": "72.1"
      }
    ],
    "addresses": [
      {
        "addressType": "LEGAL_ADDRESS",
        "physicalPostalAddress": {
          "country": "ES",
          "city": "Mondrag√≥n",
          "postalCode": "20500",
          "street": {
            "name": "P¬∫ J.M. Arizmendiarrieta",
            "houseNumber": "2"
          }
        }
      }
    ],
    "identifiers": [
      {
        "type": "VAT_ID",
        "value": "ESF20459407",
        "issuingBody": "Agencia Tributaria Espa√±a"
      }
    ]
  }' | jq
```

**¬øQu√© estamos haciendo?**
- Creamos un nuevo registro de Business Partner en BPDM Pool
- Incluimos informaci√≥n legal, direcci√≥n, identificadores fiscales
- El sistema asignar√° autom√°ticamente un **BPN (Business Partner Number)** √∫nico

**Resultado esperado:**
```json
{
  "bpn": "BPNL000000000123",
  "legalName": "Ikerlan S.Coop.",
  "createdAt": "2026-01-27T15:30:00Z",
  "updatedAt": "2026-01-27T15:30:00Z"
}
```

**‚ö†Ô∏è IMPORTANTE:** Guarda el **BPN** generado, lo necesitaremos en siguientes pasos.

---

### Paso 3.3: Verificar el BPN Asignado

**Comando:**
```bash
# Ver el Business Partner creado
curl -X GET "http://business-partners.51.68.114.44.nip.io/pool/v7/business-partners/BPNL000000000123" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" | jq
```

**¬øQu√© estamos haciendo?**
- Recuperamos el registro completo del Business Partner usando su BPN
- Verificamos que todos los datos se guardaron correctamente
- Confirmamos que el estado es ACTIVE

---

## üîê FASE 4: Configuraci√≥n de Acceso en Keycloak

### Paso 4.1: Crear Realm de Ikerlan en Shared IDP

**¬øPor qu√© crear un Realm?**
- Cada Business Partner tiene su propio realm en Shared IDP
- Esto permite gesti√≥n independiente de usuarios y roles
- Facilita la integraci√≥n con sus propios sistemas de identidad

**Comando:**
```bash
# Obtener token admin de Keycloak
ADMIN_TOKEN=$(curl -s -X POST "http://sharedidp.51.68.114.44.nip.io/auth/realms/master/protocol/openid-connect/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=password" \
  -d "client_id=admin-cli" \
  -d "username=admin" \
  -d "password=PASSWORD_DE_ADMIN" | jq -r '.access_token')

# Crear realm para Ikerlan
curl -X POST "http://sharedidp.51.68.114.44.nip.io/auth/admin/realms" \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "realm": "CX-Operator-Ikerlan",
    "enabled": true,
    "displayName": "Ikerlan Operator Realm",
    "loginTheme": "catenax-shared",
    "attributes": {
      "bpn": "BPNL000000000123"
    }
  }'
```

**¬øQu√© estamos haciendo?**
- Creamos un realm dedicado para Ikerlan en Shared IDP
- El realm se llama "CX-Operator-Ikerlan"
- Asociamos el realm con el BPN de Ikerlan mediante un atributo

---

### Paso 4.2: Crear Usuario Administrador para Ikerlan

**Comando:**
```bash
# Crear usuario admin de Ikerlan
curl -X POST "http://sharedidp.51.68.114.44.nip.io/auth/admin/realms/CX-Operator-Ikerlan/users" \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin@ikerlan.es",
    "email": "admin@ikerlan.es",
    "firstName": "Admin",
    "lastName": "Ikerlan",
    "enabled": true,
    "emailVerified": true,
    "attributes": {
      "bpn": ["BPNL000000000123"]
    },
    "credentials": [
      {
        "type": "password",
        "value": "ChangeMe123!",
        "temporary": true
      }
    ]
  }'
```

**¬øQu√© estamos haciendo?**
- Creamos el usuario administrador inicial para Ikerlan
- Password temporal "ChangeMe123!" (deber√°n cambiarlo al primer login)
- Asociamos el usuario con el BPN mediante atributos

---

### Paso 4.3: Asignar Roles al Usuario Admin

**Comando:**
```bash
# Obtener ID del usuario creado
USER_ID=$(curl -s -X GET "http://sharedidp.51.68.114.44.nip.io/auth/admin/realms/CX-Operator-Ikerlan/users?username=admin@ikerlan.es" \
  -H "Authorization: Bearer $ADMIN_TOKEN" | jq -r '.[0].id')

# Obtener rol "Company Admin"
ROLE_ID=$(curl -s -X GET "http://sharedidp.51.68.114.44.nip.io/auth/admin/realms/CX-Operator-Ikerlan/roles" \
  -H "Authorization: Bearer $ADMIN_TOKEN" | jq -r '.[] | select(.name=="Company Admin") | .id')

# Asignar rol al usuario
curl -X POST "http://sharedidp.51.68.114.44.nip.io/auth/admin/realms/CX-Operator-Ikerlan/users/$USER_ID/role-mappings/realm" \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '[
    {
      "id": "'$ROLE_ID'",
      "name": "Company Admin"
    }
  ]'
```

**¬øQu√© estamos haciendo?**
- Asignamos el rol "Company Admin" al usuario
- Este rol da permisos para gestionar la empresa en el Portal
- Permite crear m√°s usuarios, gestionar aplicaciones, etc.

---

## ‚úÖ FASE 5: Verificaci√≥n Final del Onboarding

### Paso 5.1: Verificar en BPDM Pool

**Comando:**
```bash
curl -X GET "http://business-partners.51.68.114.44.nip.io/pool/v7/business-partners/BPNL000000000123" \
  -H "Authorization: Bearer $TOKEN" | jq
```

**Verificar:**
- ‚úÖ BPN asignado
- ‚úÖ Estado: ACTIVE
- ‚úÖ Datos completos (nombre, direcci√≥n, identificadores)

---

### Paso 5.2: Verificar en Keycloak Shared IDP

**Comando:**
```bash
# Listar usuarios del realm de Ikerlan
curl -X GET "http://sharedidp.51.68.114.44.nip.io/auth/admin/realms/CX-Operator-Ikerlan/users" \
  -H "Authorization: Bearer $ADMIN_TOKEN" | jq
```

**Verificar:**
- ‚úÖ Realm "CX-Operator-Ikerlan" existe
- ‚úÖ Usuario admin@ikerlan.es creado
- ‚úÖ Usuario tiene rol "Company Admin"

---

### Paso 5.3: Test de Login en el Portal

**Acci√≥n manual:**
1. Abrir navegador: http://portal.51.68.114.44.nip.io
2. Clic en "Login"
3. Seleccionar "Login with Company IDP" o "Shared IDP"
4. Ingresar:
   - Username: `admin@ikerlan.es`
   - Password: `ChangeMe123!`
5. El sistema pedir√° cambiar el password (es temporal)
6. Cambiar a un password seguro

**Verificar:**
- ‚úÖ Login exitoso
- ‚úÖ Redirecci√≥n al dashboard del Portal
- ‚úÖ Nombre de la empresa visible en la interfaz
- ‚úÖ BPN visible en el perfil

---

### Paso 5.4: Verificar Acceso a Funcionalidades

Una vez dentro del Portal, verificar acceso a:

- ‚úÖ **Dashboard:** Vista general de la empresa
- ‚úÖ **Company Data:** Ver y editar datos de la empresa
- ‚úÖ **User Management:** Gestionar usuarios de Ikerlan
- ‚úÖ **App Marketplace:** Ver aplicaciones disponibles
- ‚úÖ **Use Cases:** Ver casos de uso de Catena-X
- ‚úÖ **Admin Board:** Panel de administraci√≥n (solo con rol Admin)

---

## üìä Resumen del Onboarding de Ikerlan

### Datos Finales

```
Empresa:          Ikerlan S.Coop.
BPN Asignado:     BPNL000000000123
Realm Keycloak:   CX-Operator-Ikerlan
Usuario Admin:    admin@ikerlan.es
Estado BPDM:      ACTIVE
Estado Keycloak:  ENABLED
```

### Recursos Creados

| Recurso | Ubicaci√≥n | Detalles |
|---------|-----------|----------|
| **Business Partner** | BPDM Pool | BPN: BPNL000000000123 |
| **Realm** | Shared IDP | CX-Operator-Ikerlan |
| **Usuario Admin** | Shared IDP | admin@ikerlan.es |
| **Registro Portal** | Portal DB | Company ID + BPN asociado |

---

## üîÑ Siguientes Pasos

### Para Ikerlan (Usuario Final)

1. **Cambiar password temporal** al iniciar sesi√≥n
2. **Completar perfil de empresa** con informaci√≥n adicional
3. **Crear usuarios adicionales** para el equipo
4. **Explorar aplicaciones** disponibles en el marketplace
5. **Configurar casos de uso** relevantes para su industria

### Para el Operador (Nosotros)

1. ‚úÖ **Onboarding de Assembly** (siguiente empresa)
2. ‚úÖ **Onboarding de Fagor** (siguiente empresa)
3. **Monitorear uso** de BPDM y Portal
4. **Verificar logs** regularmente para detectar problemas
5. **Documentar lecciones aprendidas**

---

## üõ†Ô∏è Troubleshooting Com√∫n

### Problema: No se puede crear Business Partner en BPDM

**Error t√≠pico:**
```json
{
  "error": "Unauthorized",
  "status": 401
}
```

**Soluci√≥n:**
1. Verificar que el token OAuth2 es v√°lido: `echo $TOKEN`
2. Verificar que el cliente tiene permisos en Keycloak
3. Regenerar token si ha expirado (tokens expiran en 5-10 minutos)

---

### Problema: Usuario no puede hacer login

**S√≠ntomas:**
- Error "Invalid username or password"
- Redirecci√≥n infinita

**Soluci√≥n:**
1. Verificar que el usuario existe: Ver Paso 5.2
2. Verificar que el realm est√° habilitado
3. Verificar que `emailVerified: true`
4. Comprobar logs de Keycloak:
   ```bash
   kubectl logs -n portal portal-sharedidp-0 --tail=100 | grep -i "ikerlan"
   ```

---

### Problema: Portal no muestra datos de la empresa

**S√≠ntomas:**
- Dashboard vac√≠o
- No aparece el BPN

**Soluci√≥n:**
1. Verificar que el BPN en BPDM coincide con el atributo en Keycloak
2. Verificar que el servicio de administration tiene acceso a BPDM:
   ```bash
   kubectl logs -n portal -l app.kubernetes.io/name=administration-service --tail=50
   ```
3. Verificar conectividad entre Portal y BPDM:
   ```bash
   kubectl exec -n portal deployment/portal-administration-service -- \
     wget -O- --timeout=5 http://portal-bpdm-pool:80/pool/actuator/health
   ```

---

## üìû Contactos y Recursos

### Documentaci√≥n Oficial
- [Tractus-X BPDM Documentation](https://eclipse-tractusx.github.io/docs/tutorials/)
- [Catena-X Portal User Guide](https://eclipse-tractusx.github.io/docs/portal/)
- [Keycloak Admin Guide](https://www.keycloak.org/docs/latest/server_admin/)

### Archivos Relacionados
- `2026.01.27 - Solucion Completa Despliegue BPDM - Problemas y Resoluciones.md`
- `2026.01.27 - Secuencia Comandos Correccion ConfigMaps BPDM.md`
- `fix-bpdm-ingress.sh`
- `values-ovh-hosts-portal.yaml`
- `values-adopter-portal-for-onboarding.yaml`

---

**Documento creado:** 27 de Enero de 2026  
**Autor:** xmendialdua  
**Estado:** ‚úÖ Listo para ejecuci√≥n  
**Siguiente acci√≥n:** Ejecutar comandos de FASE 2 en adelante
