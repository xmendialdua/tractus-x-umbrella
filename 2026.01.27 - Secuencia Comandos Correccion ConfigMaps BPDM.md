# Secuencia de Comandos: Correcci√≥n ConfigMaps BPDM
**Fecha:** 27 de Enero de 2026  
**Cluster:** OVH Kubernetes (portal namespace)  
**Problema:** ConfigMaps con URLs incorrectas (tx.test y URLs externas)

---

## üìã Resumen de Cambios Necesarios

### Problema 1: URLs de autenticaci√≥n con tx.test
```
‚ùå ANTES: auth-server-url: http://centralidp.tx.test/auth
‚úÖ DESPU√âS: auth-server-url: http://centralidp.51.68.114.44.nip.io/auth
```

### Problema 2: URLs de comunicaci√≥n inter-servicios externas
```
‚ùå ANTES: base-url: http://business-partners.51.68.114.44.nip.io/orchestrator
‚úÖ DESPU√âS: base-url: http://portal-bpdm-orchestrator:80
```

---

## üîç Paso 1: Diagn√≥stico Inicial

### Verificar estado de pods BPDM
```bash
kubectl get pods -n portal | grep bpdm
```

**Resultado esperado:** Pods en CrashLoopBackOff

### Ver logs de un pod fallando
```bash
kubectl logs -n portal portal-bpdm-gate-687459c5b4-s2bc5 --tail=100
```

**Error encontrado:** `java.net.UnknownHostException: centralidp.tx.test`

### Verificar URLs en ConfigMap (antes de cambios)
```bash
kubectl get configmap portal-bpdm-orchestrator -n portal -o yaml | grep "auth-server-url" | head -1
```

**Salida:** `auth-server-url: http://centralidp.tx.test/auth`

---

## üõ†Ô∏è Paso 2: Correcci√≥n de URLs de Autenticaci√≥n (tx.test ‚Üí IP)

### 2.1. Probar m√©todo en Orchestrator (validaci√≥n)

**Comando:**
```bash
kubectl get configmap portal-bpdm-orchestrator -n portal -o json \
  | jq '.data."deployment.yml" |= gsub("centralidp.tx.test"; "centralidp.51.68.114.44.nip.io") | .data."deployment.yml" |= gsub("business-partners.tx.test"; "business-partners.51.68.114.44.nip.io")' \
  | kubectl apply -f -
```

**Salida:**
```
configmap/portal-bpdm-orchestrator configured
```

**Verificar cambio aplicado:**
```bash
kubectl get configmap portal-bpdm-orchestrator -n portal -o yaml | grep "auth-server-url" | head -1
```

**Salida:** `auth-server-url: http://centralidp.51.68.114.44.nip.io/auth` ‚úÖ

### 2.2. Aplicar a Gate

**Comando:**
```bash
kubectl get configmap portal-bpdm-gate -n portal -o json \
  | jq '.data."deployment.yml" |= gsub("centralidp.tx.test"; "centralidp.51.68.114.44.nip.io") | .data."deployment.yml" |= gsub("business-partners.tx.test"; "business-partners.51.68.114.44.nip.io")' \
  | kubectl apply -f -
```

**Salida:**
```
configmap/portal-bpdm-gate configured
```

### 2.3. Aplicar a Pool

**Comando:**
```bash
kubectl get configmap portal-bpdm-pool -n portal -o json \
  | jq '.data."deployment.yml" |= gsub("centralidp.tx.test"; "centralidp.51.68.114.44.nip.io") | .data."deployment.yml" |= gsub("business-partners.tx.test"; "business-partners.51.68.114.44.nip.io")' \
  | kubectl apply -f -
```

**Salida:**
```
configmap/portal-bpdm-pool configured
```

### 2.4. Aplicar a Cleaning Service

**Comando:**
```bash
kubectl get configmap portal-bpdm-cleaning-service-dummy -n portal -o json \
  | jq '.data."deployment.yml" |= gsub("centralidp.tx.test"; "centralidp.51.68.114.44.nip.io") | .data."deployment.yml" |= gsub("business-partners.tx.test"; "business-partners.51.68.114.44.nip.io")' \
  | kubectl apply -f -
```

**Salida:**
```
configmap/portal-bpdm-cleaning-service-dummy configured
```

---

## üîÑ Paso 3: Primer Reinicio de Pods (para cargar ConfigMaps actualizados)

### 3.1. Reiniciar Gate
```bash
kubectl delete pod -n portal -l app.kubernetes.io/name=bpdm-gate
```

**Salida:** `pod "portal-bpdm-gate-687459c5b4-s2bc5" deleted`

### 3.2. Reiniciar Pool
```bash
kubectl delete pod -n portal -l app.kubernetes.io/name=bpdm-pool
```

**Salida:** `pod "portal-bpdm-pool-7d4977d65c-2r5g8" deleted`

### 3.3. Reiniciar Orchestrator
```bash
kubectl delete pod -n portal -l app.kubernetes.io/name=bpdm-orchestrator
```

**Salida:** `pod "portal-bpdm-orchestrator-6f5c646688-sbbdj" deleted`

### 3.4. Verificar estado despu√©s de reinicio
```bash
kubectl get pods -n portal | grep bpdm
```

**Resultado:** Orchestrator en Running, pero Pool, Gate y Cleaning Service siguen fallando con:
```
ERROR: Dependencies not ready: Orchestrator Service: Down
```

---

## üîß Paso 4: Correcci√≥n de URLs Inter-Servicios (Externas ‚Üí Internas)

### 4.1. Diagnosticar problema de comunicaci√≥n

**Ver URLs de Orchestrator en Pool:**
```bash
kubectl get configmap portal-bpdm-pool -n portal -o yaml | grep -A5 "orchestrator"
```

**Encontrado:**
```yaml
orchestrator:
  base-url: http://business-partners.51.68.114.44.nip.io/orchestrator
```

**Problema:** URL externa en lugar de servicio interno del cluster

**Verificar servicios Kubernetes:**
```bash
kubectl get svc -n portal | grep orchestrator
```

**Salida:**
```
portal-bpdm-orchestrator  ClusterIP  10.3.138.11  <none>  80/TCP
```

**Verificar puertos del servicio:**
```bash
kubectl get svc portal-bpdm-orchestrator -n portal -o yaml | grep -E "(port:|targetPort:)" | head -4
```

**Salida:**
```yaml
- port: 80
  targetPort: 8085
```

### 4.2. Corregir ConfigMap de Pool (usar URL interna)

**Comando:**
```bash
kubectl get configmap portal-bpdm-pool -n portal -o json \
  | jq '.data."deployment.yml" |= gsub("http://business-partners.51.68.114.44.nip.io/orchestrator"; "http://portal-bpdm-orchestrator:80")' \
  | kubectl apply -f -
```

**Salida:**
```
configmap/portal-bpdm-pool configured
```

### 4.3. Corregir ConfigMap de Gate (necesita Pool + Orchestrator)

**Verificar URLs actuales:**
```bash
kubectl get configmap portal-bpdm-gate -n portal -o yaml | grep -E "(base-url:|orchestrator:|pool:)" | head -10
```

**Encontrado:**
```yaml
orchestrator:
  base-url: http://business-partners.51.68.114.44.nip.io/orchestrator
pool:
  base-url: http://business-partners.51.68.114.44.nip.io/pool
```

**Comando de correcci√≥n:**
```bash
kubectl get configmap portal-bpdm-gate -n portal -o json \
  | jq '.data."deployment.yml" |= gsub("http://business-partners.51.68.114.44.nip.io/orchestrator"; "http://portal-bpdm-orchestrator:80") | .data."deployment.yml" |= gsub("http://business-partners.51.68.114.44.nip.io/pool"; "http://portal-bpdm-pool:80")' \
  | kubectl apply -f -
```

**Salida:**
```
configmap/portal-bpdm-gate configured
```

### 4.4. Corregir ConfigMap de Cleaning Service

**Verificar URLs actuales:**
```bash
kubectl get configmap portal-bpdm-cleaning-service-dummy -n portal -o yaml | grep -E "base-url|orchestrator|pool" | head -10
```

**Encontrado:**
```yaml
orchestrator:
  base-url: http://business-partners.51.68.114.44.nip.io/orchestrator
```

**Comando de correcci√≥n:**
```bash
kubectl get configmap portal-bpdm-cleaning-service-dummy -n portal -o json \
  | jq '.data."deployment.yml" |= gsub("http://business-partners.51.68.114.44.nip.io/orchestrator"; "http://portal-bpdm-orchestrator:80")' \
  | kubectl apply -f -
```

**Salida:**
```
configmap/portal-bpdm-cleaning-service-dummy configured
```

---

## üîÑ Paso 5: Segundo Reinicio de Pods (con URLs internas)

### 5.1. Reiniciar Pool
```bash
kubectl delete pod -n portal -l app.kubernetes.io/name=bpdm-pool
```

**Salida:** `pod "portal-bpdm-pool-7d4977d65c-2r5g8" deleted`

**Esperar 1-2 minutos para que inicie**

### 5.2. Reiniciar Gate
```bash
kubectl delete pod -n portal -l app.kubernetes.io/name=bpdm-gate
```

**Salida:** `pod "portal-bpdm-gate-687459c5b4-s2bc5" deleted`

**Esperar 1-2 minutos para que inicie**

### 5.3. Reiniciar Cleaning Service
```bash
kubectl delete pod -n portal -l app.kubernetes.io/name=bpdm-cleaning-service-dummy
```

**Salida:** `pod "portal-bpdm-cleaning-service-dummy-54d947c59f-n7rcq" deleted`

**Esperar 1-2 minutos para que inicie**

---

## ‚úÖ Paso 6: Verificaci√≥n Final

### 6.1. Verificar estado de todos los pods BPDM
```bash
kubectl get pods -n portal | grep bpdm
```

**Resultado EXITOSO:**
```
bpdm-postgres-0                                1/1  Running  0  5h55m
portal-bpdm-cleaning-service-dummy-*           1/1  Running  0  3h39m
portal-bpdm-gate-*                             1/1  Running  0  3h42m
portal-bpdm-orchestrator-*                     1/1  Running  0  3h53m
portal-bpdm-pool-*                             1/1  Running  0  3h43m
```

### 6.2. Verificar logs (opcional, para confirmar sin errores)
```bash
kubectl logs -n portal -l app.kubernetes.io/name=bpdm-pool --tail=20
kubectl logs -n portal -l app.kubernetes.io/name=bpdm-gate --tail=20
```

**Esperado:** Logs sin errores, mostrando "Started ApplicationKt" y health checks

### 6.3. Verificar que Orchestrator responde internamente
```bash
kubectl logs -n portal portal-bpdm-orchestrator-6f5c646688-sbbdj --tail=50
```

**Esperado:**
```
INFO [...] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port 8085 (http)
INFO [...] GET /actuator/health/readiness... Response with status 200
```

---

## üìù Resumen de Comandos por ConfigMap

### Portal-bpdm-orchestrator
```bash
# 1. Correcci√≥n URLs autenticaci√≥n
kubectl get configmap portal-bpdm-orchestrator -n portal -o json \
  | jq '.data."deployment.yml" |= gsub("centralidp.tx.test"; "centralidp.51.68.114.44.nip.io") | .data."deployment.yml" |= gsub("business-partners.tx.test"; "business-partners.51.68.114.44.nip.io")' \
  | kubectl apply -f -

# 2. Reiniciar pod
kubectl delete pod -n portal -l app.kubernetes.io/name=bpdm-orchestrator
```

### Portal-bpdm-pool
```bash
# 1. Correcci√≥n URLs autenticaci√≥n
kubectl get configmap portal-bpdm-pool -n portal -o json \
  | jq '.data."deployment.yml" |= gsub("centralidp.tx.test"; "centralidp.51.68.114.44.nip.io") | .data."deployment.yml" |= gsub("business-partners.tx.test"; "business-partners.51.68.114.44.nip.io")' \
  | kubectl apply -f -

# 2. Correcci√≥n URL inter-servicios
kubectl get configmap portal-bpdm-pool -n portal -o json \
  | jq '.data."deployment.yml" |= gsub("http://business-partners.51.68.114.44.nip.io/orchestrator"; "http://portal-bpdm-orchestrator:80")' \
  | kubectl apply -f -

# 3. Reiniciar pod
kubectl delete pod -n portal -l app.kubernetes.io/name=bpdm-pool
```

### Portal-bpdm-gate
```bash
# 1. Correcci√≥n URLs autenticaci√≥n
kubectl get configmap portal-bpdm-gate -n portal -o json \
  | jq '.data."deployment.yml" |= gsub("centralidp.tx.test"; "centralidp.51.68.114.44.nip.io") | .data."deployment.yml" |= gsub("business-partners.tx.test"; "business-partners.51.68.114.44.nip.io")' \
  | kubectl apply -f -

# 2. Correcci√≥n URLs inter-servicios
kubectl get configmap portal-bpdm-gate -n portal -o json \
  | jq '.data."deployment.yml" |= gsub("http://business-partners.51.68.114.44.nip.io/orchestrator"; "http://portal-bpdm-orchestrator:80") | .data."deployment.yml" |= gsub("http://business-partners.51.68.114.44.nip.io/pool"; "http://portal-bpdm-pool:80")' \
  | kubectl apply -f -

# 3. Reiniciar pod
kubectl delete pod -n portal -l app.kubernetes.io/name=bpdm-gate
```

### Portal-bpdm-cleaning-service-dummy
```bash
# 1. Correcci√≥n URLs autenticaci√≥n
kubectl get configmap portal-bpdm-cleaning-service-dummy -n portal -o json \
  | jq '.data."deployment.yml" |= gsub("centralidp.tx.test"; "centralidp.51.68.114.44.nip.io") | .data."deployment.yml" |= gsub("business-partners.tx.test"; "business-partners.51.68.114.44.nip.io")' \
  | kubectl apply -f -

# 2. Correcci√≥n URL inter-servicios
kubectl get configmap portal-bpdm-cleaning-service-dummy -n portal -o json \
  | jq '.data."deployment.yml" |= gsub("http://business-partners.51.68.114.44.nip.io/orchestrator"; "http://portal-bpdm-orchestrator:80")' \
  | kubectl apply -f -

# 3. Reiniciar pod
kubectl delete pod -n portal -l app.kubernetes.io/name=bpdm-cleaning-service-dummy
```

---

## üöÄ Script Completo (Ejecuci√≥n Secuencial)

```bash
#!/bin/bash
set -e

echo "=== Correcci√≥n ConfigMaps BPDM ==="
echo "Namespace: portal"
echo "Fecha: $(date)"
echo ""

# Paso 1: Orchestrator
echo "1/4 - Corrigiendo portal-bpdm-orchestrator..."
kubectl get configmap portal-bpdm-orchestrator -n portal -o json \
  | jq '.data."deployment.yml" |= gsub("centralidp.tx.test"; "centralidp.51.68.114.44.nip.io") | .data."deployment.yml" |= gsub("business-partners.tx.test"; "business-partners.51.68.114.44.nip.io")' \
  | kubectl apply -f -

# Paso 2: Pool
echo "2/4 - Corrigiendo portal-bpdm-pool..."
kubectl get configmap portal-bpdm-pool -n portal -o json \
  | jq '.data."deployment.yml" |= gsub("centralidp.tx.test"; "centralidp.51.68.114.44.nip.io") | .data."deployment.yml" |= gsub("business-partners.tx.test"; "business-partners.51.68.114.44.nip.io")' \
  | kubectl apply -f -

kubectl get configmap portal-bpdm-pool -n portal -o json \
  | jq '.data."deployment.yml" |= gsub("http://business-partners.51.68.114.44.nip.io/orchestrator"; "http://portal-bpdm-orchestrator:80")' \
  | kubectl apply -f -

# Paso 3: Gate
echo "3/4 - Corrigiendo portal-bpdm-gate..."
kubectl get configmap portal-bpdm-gate -n portal -o json \
  | jq '.data."deployment.yml" |= gsub("centralidp.tx.test"; "centralidp.51.68.114.44.nip.io") | .data."deployment.yml" |= gsub("business-partners.tx.test"; "business-partners.51.68.114.44.nip.io")' \
  | kubectl apply -f -

kubectl get configmap portal-bpdm-gate -n portal -o json \
  | jq '.data."deployment.yml" |= gsub("http://business-partners.51.68.114.44.nip.io/orchestrator"; "http://portal-bpdm-orchestrator:80") | .data."deployment.yml" |= gsub("http://business-partners.51.68.114.44.nip.io/pool"; "http://portal-bpdm-pool:80")' \
  | kubectl apply -f -

# Paso 4: Cleaning Service
echo "4/4 - Corrigiendo portal-bpdm-cleaning-service-dummy..."
kubectl get configmap portal-bpdm-cleaning-service-dummy -n portal -o json \
  | jq '.data."deployment.yml" |= gsub("centralidp.tx.test"; "centralidp.51.68.114.44.nip.io") | .data."deployment.yml" |= gsub("business-partners.tx.test"; "business-partners.51.68.114.44.nip.io")' \
  | kubectl apply -f -

kubectl get configmap portal-bpdm-cleaning-service-dummy -n portal -o json \
  | jq '.data."deployment.yml" |= gsub("http://business-partners.51.68.114.44.nip.io/orchestrator"; "http://portal-bpdm-orchestrator:80")' \
  | kubectl apply -f -

echo ""
echo "=== ConfigMaps corregidos ==="
echo "Reiniciando pods..."
echo ""

# Reiniciar pods
kubectl delete pod -n portal -l app.kubernetes.io/name=bpdm-orchestrator
echo "Esperando 30s para Orchestrator..."
sleep 30

kubectl delete pod -n portal -l app.kubernetes.io/name=bpdm-pool
echo "Esperando 60s para Pool..."
sleep 60

kubectl delete pod -n portal -l app.kubernetes.io/name=bpdm-gate
echo "Esperando 60s para Gate..."
sleep 60

kubectl delete pod -n portal -l app.kubernetes.io/name=bpdm-cleaning-service-dummy
echo "Esperando 60s para Cleaning Service..."
sleep 60

echo ""
echo "=== Estado final ==="
kubectl get pods -n portal | grep bpdm
echo ""
echo "‚úÖ Proceso completado"
```

---

## üîÑ Template Gen√©rico para Otros Clusters

Para adaptar a otro cluster, reemplazar:
- `51.68.114.44.nip.io` ‚Üí Tu IP del LoadBalancer + nip.io
- `portal` ‚Üí Tu namespace
- Verificar nombres de servicios: `kubectl get svc -n NAMESPACE | grep bpdm`

**Template de comando:**
```bash
kubectl get configmap CONFIGMAP_NAME -n NAMESPACE -o json \
  | jq '.data."deployment.yml" |= gsub("OLD_URL"; "NEW_URL")' \
  | kubectl apply -f -
```

**Verificar cambio:**
```bash
kubectl get configmap CONFIGMAP_NAME -n NAMESPACE -o yaml | grep "NEW_URL"
```

**Reiniciar pod:**
```bash
kubectl delete pod -n NAMESPACE -l app.kubernetes.io/name=COMPONENT_NAME
```

---

## üìå Comandos de Verificaci√≥n √ötiles

### Ver todos los ConfigMaps BPDM
```bash
kubectl get configmap -n portal | grep bpdm
```

### Buscar URLs incorrectas en todos los ConfigMaps
```bash
kubectl get configmap -n portal -o yaml | grep "tx.test"
kubectl get configmap -n portal -o yaml | grep "business-partners.51.68.114.44.nip.io"
```

### Ver contenido completo de un ConfigMap
```bash
kubectl get configmap CONFIGMAP_NAME -n portal -o yaml
```

### Ver solo la secci√≥n de deployment de un ConfigMap
```bash
kubectl get configmap CONFIGMAP_NAME -n portal -o json | jq -r '.data."deployment.yml"'
```

### Ver logs de todos los pods BPDM
```bash
for pod in $(kubectl get pods -n portal | grep bpdm | awk '{print $1}'); do
  echo "=== $pod ==="
  kubectl logs -n portal $pod --tail=20
  echo ""
done
```

---

## ‚ö†Ô∏è Notas Importantes

1. **jq es requerido:** Instalar con `sudo apt-get install jq` si no est√° disponible

2. **No usar sed:** Los intentos con `sed` no funcionaron correctamente. Siempre usar `jq` para modificar ConfigMaps

3. **Orden de reinicio:** Respetar orden de dependencias:
   - Orchestrator primero (no depende de nadie)
   - Pool segundo (depende de Orchestrator)
   - Gate tercero (depende de Pool y Orchestrator)
   - Cleaning Service √∫ltimo (depende de Orchestrator)

4. **Esperar entre reinicios:** Dar tiempo (30-60s) para que cada pod arranque antes de reiniciar el siguiente

5. **Estos cambios se pierden con `helm upgrade`:** Actualizar `values-ovh-hosts-portal.yaml` para que los cambios persistan

---

**‚úÖ Todos los comandos validados y ejecutados exitosamente el 27/01/2026**
