# Template values file for Portal deployment with OVH LoadBalancer
# Use generate_portal_values.sh script to create the final values file
# This template merges values-ovh-hosts.yaml and values-ovh-custom-domain.yaml

global:
  domainSuffix: "{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}"

portal:
  portalAddress: "http://portal.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}"
  portalBackendAddress: "http://portal-backend.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}"
  centralidp:
    address: "http://centralidp.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}"
  sharedidpAddress: "http://sharedidp.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}"
  semanticsAddress: "http://semantics.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}"
  bpdm:
    poolAddress: "http://business-partners.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}"
    portalGateAddress: "http://business-partners.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}"
  custodianAddress: "http://ssi-dim-wallet-stub.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}"
  dimWrapper:
    baseAddress: "http://ssi-dim-wallet-stub.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}"
    tokenAddress: "http://ssi-dim-wallet-stub.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}/oauth/token"
  decentralIdentityManagementAuthAddress: "http://ssi-dim-wallet-stub.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}/api/sts"
  sdfactoryAddress: "http://sdfactory.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}"
  clearinghouse:
    default:
      baseAddress: "http://validation.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}"
      tokenAddress: "http://someiam.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}/realms/example/protocol/openid-connect/token"
  issuerComponentAddress: "http://ssi-credential-issuer.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}"
  frontend:
    ingress:
      className: "nginx"
      annotations:
        nginx.ingress.kubernetes.io/cors-allow-origin: "http://*.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}"
      hosts:
        - host: "portal.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}"
          paths:
            - path: "/(.*)"
              pathType: "ImplementationSpecific"
              backend:
                service: "portal"
                port: 8080
            - path: "/registration/(.*)"
              pathType: "ImplementationSpecific"
              backend:
                service: "registration"
                port: 8080
            - path: "/((assets|documentation)/.*)"
              pathType: "ImplementationSpecific"
              backend:
                service: "assets"
                port: 8080
  backend:
    administration:
      issuerdid: "did:web:ssi-dim-wallet-stub.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}:BPNL00000003CRHK"
    processesworker:
      dim:
        baseAddress: "http://ssi-dim-wallet-stub.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}"
    ingress:
      enabled: true
      className: "nginx"
      annotations:
        nginx.ingress.kubernetes.io/use-regex: "true"
        nginx.ingress.kubernetes.io/enable-cors: "true"
        nginx.ingress.kubernetes.io/proxy-body-size: "8m"
        nginx.ingress.kubernetes.io/cors-allow-origin: "http://localhost:3000, http://*.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}"
      hosts:
        - host: "portal-backend.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}"
          paths:
            - path: "/api/registration"
              pathType: "Prefix"
              backend:
                service: "registration-service"
                port: 8080
            - path: "/api/administration"
              pathType: "Prefix"
              backend:
                service: "administration-service"
                port: 8080
            - path: "/api/notification"
              pathType: "Prefix"
              backend:
                service: "notification-service"
                port: 8080
            - path: "/api/provisioning"
              pathType: "Prefix"
              backend:
                service: "provisioning-service"
                port: 8080
            - path: "/api/apps"
              pathType: "Prefix"
              backend:
                service: "marketplace-app-service"
                port: 8080
            - path: "/api/services"
              pathType: "Prefix"
              backend:
                service: "services-service"
                port: 8080

centralidp:
  realmSeeding:
    initContainer:
      image:
        name: "docker.io/xmendialdua/catena-x-init:v1"
        pullPolicy: "IfNotPresent"
  keycloak:
    ingress:
      enabled: true
      ingressClassName: "nginx"
      hostname: "centralidp.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}"
      annotations:
        nginx.ingress.kubernetes.io/cors-allow-origin: "http://*.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}"
        nginx.ingress.kubernetes.io/enable-cors: "true"
        nginx.ingress.kubernetes.io/affinity: "cookie"
        nginx.ingress.kubernetes.io/session-cookie-name: "route"
        nginx.ingress.kubernetes.io/session-cookie-hash: "sha1"
        nginx.ingress.kubernetes.io/proxy-buffer-size: "128k"
      tls: false
    extraEnvVars:
      - name: KEYCLOAK_FRONTEND_URL
        value: "http://centralidp.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}/auth/"
      - name: KEYCLOAK_PROXY_ADDRESS_FORWARDING
        value: "true"
      - name: KC_SPI_STICKY_SESSION_ENCODER_INFINISPAN_SHOULD_ATTACH_ROUTE
        value: "false"
      - name: KEYCLOAK_PRODUCTION
        value: "false"
      - name: KC_HTTP_ENABLED
        value: "true"
      - name: KC_HOSTNAME_STRICT
        value: "false"
      - name: KC_HOSTNAME_STRICT_HTTPS
        value: "false"
      - name: KC_PROXY
        value: "edge"
      - name: KC_HOSTNAME
        value: "centralidp.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}"
      - name: KC_HOSTNAME_PATH
        value: "/auth/"

sharedidp:
  realmSeeding:
    initContainer:
      image:
        name: "docker.io/xmendialdua/catena-x-init:v1"
        pullPolicy: "IfNotPresent"
  keycloak:
    ingress:
      enabled: true
      ingressClassName: "nginx"
      hostname: "sharedidp.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}"
      annotations:
        nginx.ingress.kubernetes.io/cors-allow-origin: "http://*.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}"
        nginx.ingress.kubernetes.io/enable-cors: "true"
        nginx.ingress.kubernetes.io/affinity: "cookie"
        nginx.ingress.kubernetes.io/session-cookie-name: "route"
        nginx.ingress.kubernetes.io/session-cookie-hash: "sha1"
        nginx.ingress.kubernetes.io/proxy-buffer-size: "128k"
      tls: false
    extraEnvVars:
      - name: KEYCLOAK_FRONTEND_URL
        value: "http://sharedidp.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}/auth/"
      - name: KEYCLOAK_PROXY_ADDRESS_FORWARDING
        value: "true"
      - name: KC_SPI_STICKY_SESSION_ENCODER_INFINISPAN_SHOULD_ATTACH_ROUTE
        value: "false"
      - name: KEYCLOAK_PRODUCTION
        value: "false"
      - name: KC_HTTP_ENABLED
        value: "true"
      - name: KC_HOSTNAME_STRICT
        value: "false"
      - name: KC_HOSTNAME_STRICT_HTTPS
        value: "false"
      - name: KC_PROXY
        value: "edge"
      - name: KC_HOSTNAME
        value: "sharedidp.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}"
      - name: KC_HOSTNAME_PATH
        value: "/auth/"

pgadmin4:
  ingress:
    enabled: true
    ingressClassName: nginx
    hosts:
      - host: pgadmin4.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}
        paths:
          - path: /
            pathType: Prefix

# BPDM Configuration
# NOTE: Use internal cluster URLs for inter-service communication
# External URLs via Ingress are only for browser/external API access
bpdm-gate:
  ingress:
    enabled: true
    className: "nginx"
    hosts:
      - host: "business-partners.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}"
        paths:
          - path: /gate
            pathType: Prefix
  applicationConfig:
    bpdm:
      security:
        authServerUrl: "http://centralidp.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}/auth"
      pool:
        baseUrl: "http://portal-bpdm-pool:80"
      orchestrator:
        baseUrl: "http://portal-bpdm-orchestrator:80"

bpdm-pool:
  ingress:
    enabled: true
    className: "nginx"
    hosts:
      - host: "business-partners.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}"
        paths:
          - path: /pool
            pathType: Prefix
  applicationConfig:
    bpdm:
      security:
        authServerUrl: "http://centralidp.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}/auth"
      orchestrator:
        baseUrl: "http://portal-bpdm-orchestrator:80"

bpdm-orchestrator:
  ingress:
    enabled: true
    className: "nginx"
    hosts:
      - host: "business-partners.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}"
        paths:
          - path: /orchestrator
            pathType: Prefix

bpdm-cleaning-service-dummy:
  applicationConfig:
    bpdm:
      orchestrator:
        baseUrl: "http://portal-bpdm-orchestrator:80"

smtp4dev:
  ingress:
    enabled: true
    className: "nginx"
    hosts:
      - host: "smtp4dev.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}"
        paths:
          - path: /
            pathType: Prefix

# ============================================================================
# SSI & Identity Components
# ============================================================================

# Self-Description Factory (sdfactory)
selfdescription:
  sdfactory:
    secret:
      jwkSetUri: "http://centralidp.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}/auth/realms/CX-Central/protocol/openid-connect/certs"
  ingress:
    enabled: true
    className: "nginx"
    hosts:
      - host: "sdfactory.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}"
        paths:
          - path: "/"
            pathType: "Prefix"

# SSI Credential Issuer
ssi-credential-issuer:
  portalBackendAddress: "http://portal-backend.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}"
  walletAddress: "http://ssi-dim-wallet-stub.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}"
  walletTokenAddress: "http://ssi-dim-wallet-stub.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}/oauth/token"
  service:
    credential:
      issuerDid: "did:web:ssi-dim-wallet-stub.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}:BPNL00000003CRHK"
      statusListUrl: "http://ssi-dim-wallet-stub.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}/status-list/BPNL00000003CRHK/8a6c7486-1e1f-4555-bdd2-1a178182651e"
  centralidp:
    address: "http://centralidp.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}"
  ingress:
    enabled: true
    className: "nginx"
    annotations:
      nginx.ingress.kubernetes.io/use-regex: "true"
      nginx.ingress.kubernetes.io/enable-cors: "true"
      nginx.ingress.kubernetes.io/proxy-body-size: "8m"
      nginx.ingress.kubernetes.io/cors-allow-origin: "http://*.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}"
    hosts:
      - host: "ssi-credential-issuer.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}"
        paths:
          - path: "/"
            pathType: "Prefix"
            backend:
              port: 8080

# DIM Wallet Stub (part of identity-and-trust-bundle)
identity-and-trust-bundle:
  ssi-dim-wallet-stub:
    wallet:
      host: "ssi-dim-wallet-stub.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}"
      didHost: "ssi-dim-wallet-stub.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}"
      stubUrl: "http://ssi-dim-wallet-stub.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}"
      portal:
        host: "http://portal-backend.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}"
      keycloak:
        authServerUrl: "http://centralidp.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}/auth"
      ingress:
        enabled: true
        className: nginx

# ============================================================================
# Discovery Services
# ============================================================================

# BDRS (BPN-DID Resolution Service)
bdrs-server-memory:
  seeding:
    bpnList:
      - bpn: "BPNL00000003CRHK"
        did: "did:web:ssi-dim-wallet-stub.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}:BPNL00000003CRHK"
  server:
    trustedIssuers:
      - did:web:ssi-dim-wallet-stub.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}:BPNL00000003CRHK
    env:
      EDC_IAM_DID_WEB_USE_HTTPS: false
    ingresses:
      - enabled: true
        hostname: "bdrs-server.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}"
        endpoints:
          - directory
          - management
        className: "nginx"
        tls:
          enabled: false

# BPN Discovery
# NOTA: El subchart no permite configurar pathType: ImplementationSpecific desde values
# Por tanto, el ingress se gestiona manualmente. Ver sección "Manual Ingress Configuration" al final.
bpndiscovery:
  bpndiscovery:
    host: "semantics.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}"
    ingress:
      enabled: false  # Deshabilitado - el subchart solo soporta pathType: Prefix (incompatible con rutas regex)
    idp:
      issuerUri: "http://centralidp.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}/auth/realms/CX-Central"
    discoveryfinderClient:
      baseUrl: "http://semantics.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}/discoveryfinder"
      provider:
        tokenUri: "http://centralidp.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}/auth/realms/CX-Central/protocol/openid-connect/token"

# Discovery Finder
# NOTA: El subchart no permite configurar pathType: ImplementationSpecific desde values
# Por tanto, el ingress se gestiona manualmente. Ver sección "Manual Ingress Configuration" al final.
discoveryfinder:
  discoveryfinder:
    host: "semantics.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}"
    properties:
      discoveryfinder:
        initialEndpoints:
          - type: bpn
            endpointAddress: "http://portal-backend.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}/api/administration/Connectors/discovery"
            description: Service to discover connector endpoints based on bpns
            documentation: "http://portal-backend.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}/api/administration/swagger/index.html"
    idp:
      issuerUri: "http://centralidp.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}/auth/realms/CX-Central"
    ingress:
      enabled: false  # Deshabilitado - el subchart solo soporta pathType: Prefix (incompatible con rutas regex)

# ============================================================================
# Manual Ingress Configuration (required for Discovery Services)
# ============================================================================
# Los subcharts de bpndiscovery y discoveryfinder usan pathType: Prefix hardcodeado,
# lo cual es incompatible con rutas regex como /bpndiscovery(/|$)(.*).
# 
# Para habilitar acceso externo, aplicar manualmente después del helm upgrade:
#
#   kubectl apply -f - <<EOF
#   apiVersion: networking.k8s.io/v1
#   kind: Ingress
#   metadata:
#     name: portal-bpndiscovery
#     namespace: portal
#     annotations:
#       nginx.ingress.kubernetes.io/use-regex: "true"
#       nginx.ingress.kubernetes.io/rewrite-target: /\$2
#   spec:
#     ingressClassName: nginx
#     rules:
#     - host: semantics.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}
#       http:
#         paths:
#         - path: /bpndiscovery(/|$)(.*)
#           pathType: ImplementationSpecific
#           backend:
#             service:
#               name: portal-bpndiscovery
#               port:
#                 number: 8080
#   ---
#   apiVersion: networking.k8s.io/v1
#   kind: Ingress
#   metadata:
#     name: portal-discoveryfinder
#     namespace: portal
#     annotations:
#       nginx.ingress.kubernetes.io/use-regex: "true"
#       nginx.ingress.kubernetes.io/rewrite-target: /\$2
#   spec:
#     ingressClassName: nginx
#     rules:
#     - host: semantics.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}
#       http:
#         paths:
#         - path: /discoveryfinder(/|$)(.*)
#           pathType: ImplementationSpecific
#           backend:
#             service:
#               name: portal-discoveryfinder
#               port:
#                 number: 8080
#   EOF
#
# Verificar acceso:
#   curl http://semantics.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}/bpndiscovery/swagger-ui/index.html
#   curl http://semantics.{{LOAD_BALANCER_IP}}{{DNS_SUFFIX}}/discoveryfinder/swagger-ui/index.html
