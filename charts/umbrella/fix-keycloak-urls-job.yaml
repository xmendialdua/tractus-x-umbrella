# Kubernetes Job to fix Keycloak URLs after initial deployment
# This job corrects the URLs in both centralidp and sharedidp databases
# that are not updated by realm seeding because it's idempotent
#
# Usage:
#   kubectl apply -f fix-keycloak-urls-job.yaml -n portal
#   kubectl logs -n portal job/fix-keycloak-urls -f
#
# IMPORTANT: Update the IP address (51.75.198.189) with your LoadBalancer IP

apiVersion: batch/v1
kind: Job
metadata:
  name: fix-keycloak-urls
  labels:
    app: fix-keycloak-urls
spec:
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: fix-keycloak-urls
    spec:
      restartPolicy: Never
      initContainers:
        # Wait for PostgreSQL pods to be ready
        - name: wait-for-databases
          image: bitnami/kubectl:latest
          command:
            - sh
            - -c
            - |
              echo "Waiting for centralidp-postgresql..."
              kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=postgresql,app.kubernetes.io/instance=portal-centralidp --timeout=300s
              echo "Waiting for sharedidp-postgresql..."
              kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=postgresql,app.kubernetes.io/instance=portal-sharedidp --timeout=300s
              echo "All databases are ready"
      containers:
        - name: fix-urls
          image: bitnami/postgresql:15
          env:
            - name: PGPASSWORD_CENTRAL
              valueFrom:
                secretKeyRef:
                  name: portal-centralidp-postgresql
                  key: password
            - name: PGPASSWORD_SHARED
              valueFrom:
                secretKeyRef:
                  name: portal-sharedidp-postgresql
                  key: password
            # CHANGE THIS: Replace with your LoadBalancer IP
            - name: EXTERNAL_IP
              value: "51.75.198.189"
          command:
            - sh
            - -c
            - |
              set -e
              
              echo "=========================================="
              echo "Starting Keycloak URL Fix Job"
              echo "External IP: $EXTERNAL_IP"
              echo "=========================================="
              
              # Function to execute SQL on centralidp
              exec_central() {
                PGPASSWORD="$PGPASSWORD_CENTRAL" psql -h portal-centralidp-postgresql -U kccentral -d iamcentralidp -c "$1"
              }
              
              # Function to execute SQL on sharedidp
              exec_shared() {
                PGPASSWORD="$PGPASSWORD_SHARED" psql -h portal-sharedidp-postgresql -U kcshared -d iamsharedidp -c "$1"
              }
              
              echo ""
              echo "=== FIXING CENTRAL IDP DATABASE ==="
              echo ""
              
              # 1. Fix client root_url for Cl2-CX-Portal
              echo "1. Updating client.root_url for Cl2-CX-Portal..."
              exec_central "
                UPDATE client 
                SET root_url = 'http://portal.$EXTERNAL_IP.nip.io/home' 
                WHERE client_id = 'Cl2-CX-Portal';
              "
              echo "   ✓ root_url updated"
              
              # 2. Fix redirect_uris for portal clients
              echo "2. Updating redirect_uris for portal clients..."
              exec_central "
                UPDATE redirect_uris 
                SET value = 'http://portal.$EXTERNAL_IP.nip.io/*' 
                WHERE client_id IN (
                  SELECT id FROM client WHERE client_id IN ('Cl1-CX-Registration', 'Cl2-CX-Portal', 'Cl3-CX-Semantic')
                );
              "
              ROWS_UPDATED=$(exec_central "SELECT COUNT(*) FROM redirect_uris WHERE value = 'http://portal.$EXTERNAL_IP.nip.io/*';" | sed -n '3p' | xargs)
              echo "   ✓ $ROWS_UPDATED redirect_uris updated"
              
              # 3. Fix identity_provider_config URLs (tokenUrl, authorizationUrl, jwksUrl, logoutUrl)
              echo "3. Updating identity_provider_config URLs for CX-Operator..."
              exec_central "
                UPDATE identity_provider_config 
                SET value = REPLACE(value, 'sharedidp.tx.test', 'sharedidp.$EXTERNAL_IP.nip.io')
                WHERE identity_provider_id IN (
                  SELECT internal_id FROM identity_provider WHERE provider_alias = 'CX-Operator'
                )
                AND name IN ('tokenUrl', 'authorizationUrl', 'jwksUrl', 'logoutUrl');
              "
              ROWS_UPDATED=$(exec_central "SELECT COUNT(*) FROM identity_provider_config WHERE value LIKE '%sharedidp.$EXTERNAL_IP.nip.io%';" | sed -n '3p' | xargs)
              echo "   ✓ $ROWS_UPDATED identity_provider_config URLs updated"
              
              echo ""
              echo "=== FIXING SHARED IDP DATABASE ==="
              echo ""
              
              # 4. Fix redirect_uri for central-idp client
              echo "4. Updating redirect_uri for central-idp client..."
              exec_shared "
                UPDATE redirect_uris 
                SET value = 'http://centralidp.$EXTERNAL_IP.nip.io/auth/realms/CX-Central/broker/CX-Operator/endpoint/*'
                WHERE client_id IN (SELECT id FROM client WHERE client_id = 'central-idp');
              "
              echo "   ✓ redirect_uri updated"
              
              # 5. Fix jwks.url in client_attributes
              echo "5. Updating client_attributes.jwks.url for central-idp..."
              exec_shared "
                UPDATE client_attributes 
                SET value = 'http://centralidp.$EXTERNAL_IP.nip.io/auth/realms/CX-Central/protocol/openid-connect/certs'
                WHERE name = 'jwks.url' 
                AND client_id IN (SELECT id FROM client WHERE client_id = 'central-idp');
              "
              echo "   ✓ jwks.url updated"
              
              echo ""
              echo "=========================================="
              echo "Keycloak URL Fix Completed Successfully"
              echo "=========================================="
              echo ""
              echo "NEXT STEPS:"
              echo "1. Restart centralidp pods:"
              echo "   kubectl delete pod -n portal -l app.kubernetes.io/name=centralidp"
              echo ""
              echo "2. Restart sharedidp pods:"
              echo "   kubectl delete pod -n portal -l app.kubernetes.io/name=sharedidp"
              echo ""
              echo "3. Wait for pods to be ready and test login at:"
              echo "   http://portal.$EXTERNAL_IP.nip.io"
              echo "=========================================="
