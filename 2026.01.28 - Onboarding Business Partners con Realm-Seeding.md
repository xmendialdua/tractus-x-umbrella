# Gu√≠a: Onboarding de Business Partners mediante Realm-Seeding

**Fecha:** 28 de Enero de 2026  
**Objetivo:** Documentar el proceso de onboarding de nuevos business partners utilizando realm-seeding en lugar de modificaciones manuales en la base de datos  
**Partner Ejemplo:** MAssembly (idp2)  
**Partner Anterior:** Ikerlan (idp1) - realizado manualmente via SQL

---

## √çndice

1. [Introducci√≥n: ¬øQu√© es Realm-Seeding?](#introducci√≥n-qu√©-es-realm-seeding)
2. [Ventajas vs Proceso Manual](#ventajas-vs-proceso-manual)
3. [¬øCu√°ndo se ejecuta el Realm-Seeding?](#cu√°ndo-se-ejecuta-el-realm-seeding)
4. [Arquitectura: Init-Container y Archivos JSON](#arquitectura-init-container-y-archivos-json)
5. [Estructura de los Archivos JSON](#estructura-de-los-archivos-json)
6. [Proceso Paso a Paso](#proceso-paso-a-paso)
7. [Configuraci√≥n para MAssembly](#configuraci√≥n-para-massembly)
8. [Ejecuci√≥n del Realm-Seeding](#ejecuci√≥n-del-realm-seeding)
9. [Verificaci√≥n Post-Despliegue](#verificaci√≥n-post-despliegue)
10. [Troubleshooting](#troubleshooting)

---

## Introducci√≥n: ¬øQu√© es Realm-Seeding?

**Realm-seeding** es el proceso de **pre-configurar** un realm de Keycloak mediante archivos JSON que contienen:
- Configuraci√≥n del realm (CX-Central)
- Identity Providers (IdPs) para business partners
- Clientes OAuth2/OIDC
- Roles, grupos y mappers
- Usuarios iniciales

Estos archivos JSON se importan **autom√°ticamente** durante el despliegue de Keycloak mediante un **init-container**.

### Conceptos Clave:

- **Init-Container**: Contenedor que se ejecuta ANTES del contenedor principal de Keycloak
- **Realm**: Espacio aislado en Keycloak que gestiona usuarios, clientes y configuraciones
- **Identity Provider (IdP)**: Configuraci√≥n que permite a un business partner autenticarse con su propio sistema de identidad
- **Idempotencia**: El realm-seeding NO sobrescribe datos existentes, solo a√±ade lo que falta

---

## Ventajas vs Proceso Manual

### ‚ùå Proceso Manual (usado con Ikerlan):
- Requiere m√∫ltiples comandos SQL
- Alto riesgo de errores en INSERT statements
- Dif√≠cil de rastrear cambios
- No versionable
- Proceso largo de prueba y error
- Requiere acceso directo a PostgreSQL

### ‚úÖ Proceso con Realm-Seeding:
- Configuraci√≥n declarativa en JSON
- Versionable en Git
- Reproducible y automatizado
- Menor riesgo de errores
- Mismo formato que usa Keycloak internamente
- Se ejecuta durante el despliegue

---

## ¬øCu√°ndo se ejecuta el Realm-Seeding?

### IMPORTANTE: Idempotencia del Realm-Seeding

El realm-seeding en Keycloak es **IDEMPOTENTE**, lo que significa:

‚úÖ **Puedes ejecutarlo en cualquier momento**
- Durante el despliegue inicial
- En actualizaciones posteriores (upgrade del chart)
- Cuando a√±ades nuevos partners

‚úÖ **NO elimina partners existentes**
- Si Ikerlan (idp1) ya existe ‚Üí se mantiene
- Si a√±ades MAssembly (idp2) ‚Üí se a√±ade sin afectar a Ikerlan
- Solo se importan elementos nuevos

‚úÖ **NO sobrescribe configuraciones existentes**
- Si un Identity Provider ya existe con el mismo ID ‚Üí NO se actualiza
- Solo se crean los que NO existen

‚ö†Ô∏è **Limitaci√≥n: No actualiza configuraciones existentes**
- Si necesitas modificar un IdP existente ‚Üí debes hacerlo manualmente o eliminarlo primero

### ¬øNecesitas redesplegar el portal?

**NO** - No necesitas redesplegar todo el portal. Opciones:

1. **Upgrade del release de Helm** (recomendado):
   ```bash
   helm upgrade umbrella charts/umbrella -n umbrella -f valores.yaml
   ```

2. **Restart del pod de Keycloak**:
   ```bash
   kubectl rollout restart statefulset/umbrella-centralidp -n umbrella
   ```

El init-container se ejecuta cada vez que el pod de Keycloak se reinicia.

---

## Arquitectura: Init-Container y Archivos JSON

### Flujo de Despliegue

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              1. BUILD: Init-Container Image                  ‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ  Dockerfile: init-container/Dockerfile                       ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ FROM alpine:3.19                                       ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ COPY iam/centralidp/*.json ‚Üí /import/centralidp/      ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ COPY iam/sharedidp/*.json ‚Üí /import/sharedidp/        ‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ  Archivos copiados:                                          ‚îÇ
‚îÇ  - CX-Central-realm.json        (11,400 l√≠neas)            ‚îÇ
‚îÇ  - CX-Central-users-0.json      (33 l√≠neas)                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         2. DESPLIEGUE: Pod de Keycloak con Init-Container   ‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ  Init Container: "import"                                    ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ Monta volumen compartido /import                       ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ Copia JSONs desde imagen ‚Üí /import/                   ‚îÇ
‚îÇ                           ‚Üì                                  ‚îÇ
‚îÇ  Main Container: "keycloak"                                  ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ Lee JSONs desde /import/                              ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ Importa realm: CX-Central                             ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ Importa usuarios: admin, company admin, etc.          ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ Importa Identity Providers (IdPs)                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              3. RESULTADO: Base de Datos PostgreSQL          ‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ  Tablas actualizadas:                                        ‚îÇ
‚îÇ  - identity_provider (lista de IdPs)                        ‚îÇ
‚îÇ  - identity_provider_config (configuraci√≥n de cada IdP)     ‚îÇ
‚îÇ  - user_entity (usuarios del realm)                         ‚îÇ
‚îÇ  - client (aplicaciones OAuth2)                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Ubicaci√≥n de los Archivos

```
tractus-x-umbrella/
‚îú‚îÄ‚îÄ init-container/
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile                          # Build del init-container
‚îÇ   ‚îî‚îÄ‚îÄ iam/
‚îÇ       ‚îú‚îÄ‚îÄ centralidp/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ CX-Central-realm.json      # ‚Üê AQU√ç a√±adimos IdPs
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ CX-Central-users-0.json    # ‚Üê AQU√ç a√±adimos usuarios
‚îÇ       ‚îî‚îÄ‚îÄ sharedidp/
‚îÇ           ‚îî‚îÄ‚îÄ CX-Central-realm.json      # Realm para shared IdP
```

---

## Estructura de los Archivos JSON

### 1. Archivo: CX-Central-realm.json (11,400 l√≠neas)

Este archivo contiene la configuraci√≥n completa del realm `CX-Central`:

**Estructura principal:**
```json
{
  "id": "CX-Central",
  "realm": "CX-Central",
  "displayName": "Catena-X Central",
  
  // ... 10,000+ l√≠neas de configuraci√≥n ...
  
  "identityProviders": [
    {
      "alias": "CX-Operator",
      "displayName": "CX-Operator",
      "internalId": "b320f4ea-1a43-4210-8256-060d0d9a7774",
      "providerId": "keycloak-oidc",
      "enabled": true,
      "config": {
        "clientId": "central-idp",
        "tokenUrl": "http://sharedidp.tx.test/auth/realms/CX-Operator/protocol/openid-connect/token",
        "jwksUrl": "http://sharedidp.tx.test/auth/realms/CX-Operator/protocol/openid-connect/certs",
        "authorizationUrl": "http://sharedidp.tx.test/auth/realms/CX-Operator/protocol/openid-connect/auth",
        "logoutUrl": "http://sharedidp.tx.test/auth/realms/CX-Operator/protocol/openid-connect/logout",
        // ... m√°s configuraci√≥n ...
      }
    }
    // ‚Üê AQU√ç a√±adiremos los Identity Providers de business partners
  ],
  
  "identityProviderMappers": [
    {
      "name": "organisation-mapper",
      "identityProviderAlias": "CX-Operator",
      "identityProviderMapper": "hardcoded-attribute-idp-mapper",
      "config": {
        "attribute.value": "CX-Operator",
        "attribute": "organisation"
      }
    }
    // ‚Üê AQU√ç a√±adiremos los mappers para cada partner
  ]
}
```

**Secci√≥n clave:** `identityProviders` (l√≠nea 10,251)

Esta es la secci√≥n donde se definen los Identity Providers externos. Actualmente solo tiene `CX-Operator` (el IdP del operador).

### 2. Archivo: CX-Central-users-0.json (33 l√≠neas)

Este archivo contiene los usuarios iniciales del realm:

```json
{
  "realm": "CX-Central",
  "users": [
    {
      "id": "502dabcf-01c7-47d9-a88e-0be4279097b5",
      "username": "ac1cf001-7fbc-1f2f-817f-bce058020006",
      "enabled": true,
      "firstName": "Operator",
      "lastName": "CX Admin",
      "email": "cx-operator@tx.org",
      "attributes": {
        "bpn": ["BPNL00000003CRHK"],
        "organisation": ["CX-Operator"]
      },
      "federatedIdentities": [{
        "identityProvider": "CX-Operator",
        "userId": "656e8a94-188b-4a3e-9eec-b45d8efd8347",
        "userName": "cx-operator@tx.org"
      }],
      "realmRoles": ["default-roles-cx-central"],
      "clientRoles": {
        "Cl2-CX-Portal": ["CX Admin"]
      }
    }
    // ‚Üê AQU√ç a√±adiremos los usuarios de business partners
  ]
}
```

---

## Proceso Paso a Paso

### Informaci√≥n necesaria antes de empezar

Para hacer el onboarding de **MAssembly** necesitamos:

1. **Informaci√≥n b√°sica del partner:**
   - Nombre legal de la empresa
   - Nombre corto (display name)
   - BPN (Business Partner Number)
   - Email del administrador
   
2. **Identificador del IdP:**
   - Formato: `idpX` donde X es un n√∫mero secuencial
   - Ikerlan = `idp1` (ya existe)
   - MAssembly = `idp2` (nuevo)

3. **Dominio del Shared IdP:**
   - Tu dominio actual: `51.68.114.44.nip.io`
   - URL base: `http://sharedidp.51.68.114.44.nip.io`

### PASO 1: Preparar la informaci√≥n de MAssembly

Crea un archivo de texto similar a `onboarding/Ikerlan.txt` con la informaci√≥n del nuevo partner:

```bash
nano onboarding/MAssembly.txt
```

**Informaci√≥n m√≠nima necesaria:**
```
Nombre legal:           [Nombre completo de MAssembly]
Nombre corto:           MAssembly
BPN:                    BPNL000000002MSA  (ejemplo, debe ser √∫nico)
Email admin:            admin@massembly.com
IdP Keycloak:           idp2
Display Name:           MAssembly
```

### PASO 2: Identificar las secciones a modificar

Los archivos que modificaremos:
1. `init-container/iam/centralidp/CX-Central-realm.json` - a√±adir IdP
2. `init-container/iam/centralidp/CX-Central-users-0.json` - a√±adir usuario

### PASO 3: A√±adir el Identity Provider para MAssembly

Necesitamos a√±adir una entrada en la secci√≥n `identityProviders` del archivo `CX-Central-realm.json`.

**Estructura del nuevo IdP:**

```json
{
  "alias": "idp2",
  "displayName": "MAssembly",
  "internalId": "UUID-GENERADO-NUEVO",
  "providerId": "keycloak-oidc",
  "enabled": true,
  "updateProfileFirstLoginMode": "on",
  "trustEmail": false,
  "storeToken": false,
  "addReadTokenRoleOnCreate": false,
  "authenticateByDefault": false,
  "linkOnly": false,
  "firstBrokerLoginFlowAlias": "first broker login",
  "config": {
    "hideOnLoginPage": "false",
    "validateSignature": "true",
    "clientId": "central-idp",
    "tokenUrl": "http://sharedidp.51.68.114.44.nip.io/auth/realms/idp2/protocol/openid-connect/token",
    "jwksUrl": "http://sharedidp.51.68.114.44.nip.io/auth/realms/idp2/protocol/openid-connect/certs",
    "authorizationUrl": "http://sharedidp.51.68.114.44.nip.io/auth/realms/idp2/protocol/openid-connect/auth",
    "clientAuthMethod": "private_key_jwt",
    "logoutUrl": "http://sharedidp.51.68.114.44.nip.io/auth/realms/idp2/protocol/openid-connect/logout",
    "clientAssertionSigningAlg": "RS256",
    "syncMode": "FORCE",
    "useJwksUrl": "true"
  }
}
```

**‚ö†Ô∏è IMPORTANTE:** 
- Cambia `sharedidp.tx.test` por tu dominio real: `sharedidp.51.68.114.44.nip.io`
- Genera un UUID nuevo para `internalId` (comando: `uuidgen`)
- El `alias` debe ser √∫nico: `idp2`
- Las URLs apuntan al realm `idp2` en el Shared IdP

### PASO 4: A√±adir el mapper del Identity Provider

Despu√©s de a√±adir el IdP, necesitamos a√±adir su mapper en la secci√≥n `identityProviderMappers`:

```json
{
  "id": "UUID-GENERADO-NUEVO",
  "name": "organisation-mapper",
  "identityProviderAlias": "idp2",
  "identityProviderMapper": "hardcoded-attribute-idp-mapper",
  "config": {
    "attribute.value": "MAssembly",
    "syncMode": "INHERIT",
    "attribute": "organisation"
  }
}
```

Este mapper asegura que el atributo `organisation` se establece correctamente para usuarios de MAssembly.

### PASO 5: A√±adir el usuario administrador de MAssembly

En el archivo `CX-Central-users-0.json`, a√±adimos el usuario administrador:

```json
{
  "id": "UUID-GENERADO-NUEVO",
  "createdTimestamp": 1706400000000,
  "username": "UUID-GENERADO-NUEVO",
  "enabled": true,
  "totp": false,
  "emailVerified": false,
  "firstName": "Admin",
  "lastName": "MAssembly",
  "email": "admin@massembly.com",
  "attributes": {
    "bpn": ["BPNL000000002MSA"],
    "organisation": ["MAssembly"]
  },
  "credentials": [],
  "disableableCredentialTypes": [],
  "requiredActions": [],
  "federatedIdentities": [{
    "identityProvider": "idp2",
    "userId": "UUID-GENERADO-NUEVO",
    "userName": "admin@massembly.com"
  }],
  "realmRoles": ["default-roles-cx-central"],
  "clientRoles": {
    "Cl2-CX-Portal": ["Company Admin"]
  },
  "notBefore": 0,
  "groups": []
}
```

**‚ö†Ô∏è IMPORTANTE:** 
- Genera 2 UUIDs diferentes: uno para `id` y otro para `username`
- Genera 1 UUID para `userId` en `federatedIdentities`
- El `identityProvider` debe coincidir con el alias: `idp2`
- El `bpn` debe ser √∫nico
- El rol `Company Admin` en `Cl2-CX-Portal` es esencial para administrar la empresa

---

## Configuraci√≥n para MAssembly

### Datos de ejemplo para MAssembly

```yaml
Nombre legal:           MAssembly Technologies, S.L.
Nombre corto:           MAssembly
BPN:                    BPNL000000002MSA
Email admin:            admin@massembly.com
IdP alias:              idp2
Display Name:           MAssembly
Dominio Shared IdP:     http://sharedidp.51.68.114.44.nip.io
```

### UUIDs a generar

Necesitaremos generar 4 UUIDs √∫nicos:

```bash
# Generar los UUIDs necesarios
uuidgen  # Para internalId del IdP
uuidgen  # Para id del mapper
uuidgen  # Para id del usuario
uuidgen  # Para username del usuario (puede ser el mismo que id)
uuidgen  # Para userId en federatedIdentities
```

---

## Ejecuci√≥n del Realm-Seeding

### Opci√≥n 1: Modificar archivos JSON y redesplegar init-container (Recomendado)

Esta es la forma **correcta y reproducible**:

#### 1. Modificar los archivos JSON

```bash
cd /home/xmendialdua/projects/assembly/tractus-x-umbrella

# Editar CX-Central-realm.json
nano init-container/iam/centralidp/CX-Central-realm.json

# Editar CX-Central-users-0.json  
nano init-container/iam/centralidp/CX-Central-users-0.json
```

#### 2. Rebuild del init-container con los nuevos JSONs

```bash
# Build de la nueva imagen del init-container
cd init-container
docker build -t umbrella-init-container:2.3.0-init-massembly .

# Tag para tu registry (ajusta seg√∫n tu configuraci√≥n)
docker tag umbrella-init-container:2.3.0-init-massembly \
  your-registry/umbrella-init-container:2.3.0-init-massembly

# Push al registry
docker push your-registry/umbrella-init-container:2.3.0-init-massembly
```

#### 3. Actualizar el values.yaml para usar la nueva imagen

```yaml
# En tu archivo values-ovh-hosts-portal.yaml
centralidp:
  keycloak:
    initContainers:
      - name: import
        image: your-registry/umbrella-init-container:2.3.0-init-massembly
        # ... resto de la configuraci√≥n
```

#### 4. Upgrade del release de Helm

```bash
helm upgrade umbrella charts/umbrella -n umbrella \
  -f charts/umbrella/values-adopter-portal.yaml \
  -f charts/umbrella/values-ovh-hosts-portal.yaml
```

#### 5. Verificar que el pod se reinicia

```bash
kubectl get pods -n umbrella -w | grep centralidp
```

### Opci√≥n 2: Restart del pod existente (Solo si IdP ya est√° en JSON)

Si los archivos JSON ya est√°n actualizados en la imagen del init-container:

```bash
# Restart del StatefulSet de Keycloak
kubectl rollout restart statefulset/umbrella-centralidp -n umbrella

# Monitorear el reinicio
kubectl get pods -n umbrella -w | grep centralidp
```

### Opci√≥n 3: Importaci√≥n manual v√≠a API de Keycloak (No recomendado)

Esta opci√≥n es m√°s compleja y requiere autenticaci√≥n con Keycloak Admin API.

---

## Verificaci√≥n Post-Despliegue

### 1. Verificar que el pod de Keycloak arranc√≥ correctamente

```bash
# Ver logs del init-container
kubectl logs -n umbrella umbrella-centralidp-0 -c import

# Ver logs del contenedor principal
kubectl logs -n umbrella umbrella-centralidp-0 -c keycloak | grep -i "import\|idp2"
```

### 2. Verificar en la base de datos que el IdP fue creado

```bash
# Conectar a PostgreSQL
POD=$(kubectl get pod -n umbrella -l app.kubernetes.io/name=postgresql -o jsonpath='{.items[0].metadata.name}')

kubectl exec -it -n umbrella $POD -- psql -U kccentral -d iamcentralidp -c \
  "SELECT alias, display_name, enabled FROM identity_provider WHERE alias='idp2';"
```

**Resultado esperado:**
```
 alias | display_name | enabled 
-------+--------------+---------
 idp2  | MAssembly    | t
```

### 3. Verificar que el usuario fue creado

```bash
kubectl exec -it -n umbrella $POD -- psql -U kccentral -d iamcentralidp -c \
  "SELECT u.username, u.email, u.first_name, u.last_name FROM user_entity u WHERE u.email='admin@massembly.com';"
```

### 4. Verificar en la UI de Keycloak

```bash
# Obtener URL de Keycloak
echo "http://centralidp.51.68.114.44.nip.io/auth/admin/CX-Central/console/"
```

**En el navegador:**
1. Navegar a la URL de Keycloak Admin
2. Login con credenciales de admin
3. Ir a: **Identity Providers**
4. Verificar que aparece `idp2` con display name `MAssembly`
5. Ir a: **Users**
6. Buscar `admin@massembly.com`

### 5. Probar el login desde el Portal

```bash
# URL del Portal
echo "http://portal.51.68.114.44.nip.io"
```

**Pasos:**
1. Abrir el Portal en modo inc√≥gnito
2. Click en "Login"
3. Deber√≠a aparecer una opci√≥n para `MAssembly` (idp2)
4. Seleccionar MAssembly
5. Redirige a Shared IdP realm `idp2`
6. **NOTA:** El realm `idp2` debe existir en Shared IdP (se crea autom√°ticamente si el portal lo gestiona)

---

## Troubleshooting

### Problema 1: El IdP no aparece despu√©s del despliegue

**Causa:** La imagen del init-container no se actualiz√≥ o el pod no se reinici√≥.

**Soluci√≥n:**
```bash
# Forzar pull de la imagen nueva
kubectl delete pod umbrella-centralidp-0 -n umbrella

# Verificar que el nuevo pod arranca con la imagen correcta
kubectl describe pod umbrella-centralidp-0 -n umbrella | grep -A 5 "Init Containers"
```

### Problema 2: Error "Identity Provider already exists"

**Causa:** Ya existe un IdP con el mismo alias.

**Soluci√≥n:**
- Verifica en la base de datos
- Si existe, usa otro alias (`idp3`, `idp4`, etc.)
- O elimina el existente si es un test:
```sql
DELETE FROM identity_provider WHERE alias='idp2';
DELETE FROM identity_provider_config WHERE identity_provider_id='...';
```

### Problema 3: El usuario no puede hacer login

**Posibles causas:**

1. **El realm `idp2` no existe en Shared IdP:**
```bash
# Verificar realms en Shared IdP
kubectl exec -it -n umbrella $(kubectl get pod -n umbrella -l app.kubernetes.io/name=sharedidp -o jsonpath='{.items[0].metadata.name}') -- \
  psql -U kcshared -d iamsharedidp -c "SELECT realm FROM realm;"
```

2. **Las URLs del IdP son incorrectas:**
   - Verifica que apuntan a `sharedidp.51.68.114.44.nip.io` y no a `tx.test`

3. **El usuario no tiene el rol correcto:**
```bash
# Verificar roles del usuario
kubectl exec -it -n umbrella $POD -- psql -U kccentral -d iamcentralidp -c \
  "SELECT r.name FROM keycloak_role r 
   JOIN user_role_mapping urm ON r.id = urm.role_id 
   JOIN user_entity u ON urm.user_id = u.id 
   WHERE u.email='admin@massembly.com';"
```

### Problema 4: Error en validaci√≥n de certificados

**Causa:** Keycloak intenta validar certificados HTTPS pero el despliegue usa HTTP.

**Soluci√≥n:**
- Asegurar que `validateSignature` est√° en `"false"` o
- Configurar HTTPS correctamente

### Problema 5: Shared IdP no tiene el realm idp2

**Causa:** El realm para el partner no se cre√≥ en Shared IdP.

**Soluci√≥n temporal:**
```bash
# Crear realm manualmente en Shared IdP o usar el proceso de portal
# El portal deber√≠a crear el realm autom√°ticamente al detectar el nuevo partner
```

---

## Pr√≥ximos Pasos

Una vez completado el onboarding de MAssembly mediante realm-seeding:

1. ‚úÖ **Validar que el usuario puede hacer login**
2. ‚è≥ **Registrar el BPN en BPDM Pool** (si no se sincroniza autom√°ticamente)
3. ‚è≥ **Configurar aplicaciones adicionales** para el partner
4. ‚è≥ **Establecer pol√≠ticas de datos** y contratos
5. üìù **Documentar el proceso** para futuros partners (idp3, idp4, ...)

---

## Resumen: Diferencias con el Proceso Manual (Ikerlan)

| Aspecto | Proceso Manual (Ikerlan) | Realm-Seeding (MAssembly) |
|---------|-------------------------|---------------------------|
| **M√©todo** | INSERT SQL directo | Archivos JSON + init-container |
| **Tiempo** | 2-3 horas prueba/error | 30 min (una vez configurado) |
| **Riesgo** | Alto (errores SQL) | Bajo (formato validado) |
| **Reproducible** | No, comandos ad-hoc | S√≠, archivos en Git |
| **Versionable** | No | S√≠, JSON en repositorio |
| **Requiere acceso DB** | S√≠, directo | No, via Keycloak import |
| **Idempotente** | No | S√≠ |
| **Rollback** | Dif√≠cil | F√°cil (revert commit) |

---

## Conclusi√≥n

El proceso de **realm-seeding** es significativamente mejor que las modificaciones manuales en la base de datos:

‚úÖ **Ventajas:**
- Proceso declarativo y reproducible
- Menos propenso a errores
- Versionable en Git
- Mismo formato que usa Keycloak internamente
- Idempotente (no afecta a partners existentes)

‚ö†Ô∏è **Consideraciones:**
- Requiere rebuild del init-container
- Los archivos JSON son grandes (11,000+ l√≠neas)
- Requiere acceso a registry de Docker
- No actualiza IdPs existentes (solo a√±ade nuevos)

üéØ **Recomendaci√≥n:**
Usar realm-seeding para todos los futuros onboardings. Solo usar SQL directo en casos de emergencia o para modificar configuraciones existentes.

---

## AP√âNDICE: Proceso Ejecutado para MAssembly

### Archivos Generados

‚úÖ **Scripts Python creados:**
- `add_massembly_to_realm.py` - A√±ade IdP y mapper al realm
- `add_massembly_user.py` - A√±ade usuario administrador

‚úÖ **Archivos JSON generados:**
- `init-container/iam/centralidp/CX-Central-realm_MAssembly.json` (363 KB)
- `init-container/iam/centralidp/CX-Central-users-0_MAssembly.json` (2 KB)

‚úÖ **Documentaci√≥n creada:**
- `onboarding/MAssembly.txt` - Informaci√≥n completa del partner

### UUIDs Generados para MAssembly

```yaml
IdP Internal ID:    e35e5a08-cd51-4ef9-84a6-ead2cb46fd1d
Mapper ID:          846758d1-ccad-4623-bf40-f1b6ee42e9a3
User ID:            c1aedc7c-c2cd-40a1-a325-e5c79a36125a
Username:           28701438-a727-40c3-8479-4f6884ef342b
Federated User ID:  a8133aa1-9731-4584-ab05-e5afa8d5352e
Timestamp:          1769582860090
```

### Comandos Ejecutados

```bash
# 1. Generar UUIDs
uuidgen | tr '[:upper:]' '[:lower:]'  # Repetir 5 veces

# 2. Ejecutar scripts de generaci√≥n
python3 add_massembly_to_realm.py
python3 add_massembly_user.py

# 3. Validar JSONs generados
python3 -m json.tool CX-Central-realm_MAssembly.json > /dev/null
python3 -m json.tool CX-Central-users-0_MAssembly.json > /dev/null
```

### Informaci√≥n de MAssembly

```yaml
Partner:            MAssembly
IdP Alias:          idp2
Display Name:       MAssembly
BPN:                BPNL000000002MSA
Email Admin:        admin@massembly.com
Rol:                Company Admin
Shared IdP Domain:  sharedidp.51.68.114.44.nip.io
Portal URL:         portal.51.68.114.44.nip.io
```

### Contenido A√±adido

**En CX-Central-realm_MAssembly.json:**
1. Identity Provider `idp2` con configuraci√≥n completa
2. Mapper `organisation-mapper` para atributo `MAssembly`

**En CX-Central-users-0_MAssembly.json:**
1. Usuario `admin@massembly.com` con rol `Company Admin`
2. Atributos: BPN, organizaci√≥n
3. Identidad federada vinculada a `idp2`

### Pr√≥ximos Pasos para Despliegue

Ver archivo [onboarding/MAssembly.txt](onboarding/MAssembly.txt) para instrucciones detalladas de despliegue.

**Opci√≥n recomendada:**
1. Backup de archivos originales
2. Reemplazar archivos originales con versiones _MAssembly
3. Rebuild del init-container
4. Helm upgrade del release

---

## Fecha de Creaci√≥n

**Documento creado:** 28 de Enero de 2026  
**Partner objetivo:** MAssembly (idp2)  
**Estado:** ‚úÖ JSONs preparados, pendiente de despliegue

